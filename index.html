<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–û–Ω–ª–∞–π–Ω –ë–∞–Ω–∫</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/3Jp6C40b/IMG-2667.jpg">

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <style>
        :root { 
            --bg: #f2f3f7; --accent: #007aff; --card: #ffffff; --text: #1c1c1e; 
            --secondary: #8e8e93; --credit: #34c759; --red: #ff3b30; --tab-bg: #ffffff;
        }
        body.dark {
            --bg: #000000; --card: #1c1c1e; --text: #ffffff; --secondary: #8e8e93; --tab-bg: #121212;
        }
        * { box-sizing: border-box; font-family: -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); color: var(--text); overscroll-behavior: none; transition: background 0.3s; }
        
        #blocked-view { 
            display: none; padding: 40px; text-align: center; background: var(--card); 
            height: 100vh; flex-direction: column; justify-content: center; 
            position: fixed; top: 0; left: 0; width: 100%; z-index: 10000; 
        }
        .lock-icon { font-size: 80px; margin-bottom: 20px; }

        .refresh-btn { position: fixed; top: 20px; right: 20px; width: 45px; height: 45px; background: var(--card); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; font-size: 22px; border: none; cursor: pointer; color: var(--text); }
        #install-view { display: none; padding: 40px 24px; text-align: center; min-height: 100vh; background: #fff; }
        .logo-box { width: 80px; height: 80px; background: var(--accent); border-radius: 20px; margin: 0 auto 24px; display: flex; align-items: center; justify-content: center; color: white; font-size: 32px; }
        .screen { display: none; padding: 20px 20px 100px 20px; min-height: 100vh; position: relative; }
        .screen.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .card { background: var(--card); border-radius: 24px; padding: 20px; margin-bottom: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); position: relative; }
        .balance { font-size: 32px; font-weight: 700; margin: 5px 0; }
        .small { color: var(--secondary); font-size: 13px; }
        
        .ip-badge {
            display: none;
            position: absolute;
            top: 20px;
            right: 20px;
            background: #000;
            color: #fff;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 800;
        }

        .btn-row { display: flex; gap: 8px; margin-bottom: 20px; justify-content: space-between; }
        .btn { flex: 1; padding: 18px 5px; border-radius: 18px; border: none; font-size: 14px; font-weight: 600; cursor: pointer; text-align: center; }
        .primary { background: #ffdd2d; color: #000; }
        .secondary { background: #e8f0ff; color: #007aff; }

        .dots { display: flex; justify-content: center; gap: 15px; margin: 30px 0; }
        .dot { width: 12px; height: 12px; border: 2px solid #ccc; border-radius: 50%; }
        .dot.filled { background: var(--text); border-color: var(--text); }
        .keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; max-width: 300px; margin: 0 auto; }
        .key { height: 70px; font-size: 26px; border: none; background: none; border-radius: 35px; cursor: pointer; color: var(--text); }
        input, select { width: 100%; padding: 18px; border-radius: 18px; border: 1px solid #ddd; font-size: 16px; margin-bottom: 15px; background: var(--card); color: var(--text); }
        
        .tab-bar { position: fixed; bottom: 0; left: 0; width: 100%; height: 70px; background: var(--tab-bg); display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #e5e5ea; z-index: 1000; }
        .tab-item { display: flex; flex-direction: column; align-items: center; font-size: 10px; color: var(--secondary); }
        .tab-item.active { color: var(--accent); }
    </style>
</head>
<body>

    <button class="refresh-btn" onclick="hardReset()">üîÑ</button>

    <div id="blocked-view">
        <div class="lock-icon">‚ùÑÔ∏è</div>
        <h1 style="color: var(--red);">–î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω</h1>
        <p>–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É –¥–ª—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏.</p>
        <button class="btn secondary" onclick="hardReset()">–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
    </div>

    <div id="screen-name" class="screen">
        <h1 style="margin-top:60px">–í—Ö–æ–¥ –≤ –±–∞–Ω–∫</h1>
        <div class="card">
            <input type="text" id="loginInp" placeholder="–ò–º—è –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω">
            <button class="btn primary" style="width: 100%;" onclick="findClient()">–ù–∞–π—Ç–∏ –º–æ–π –∞–∫–∫–∞—É–Ω—Ç</button>
            <div id="error" style="color:red; margin-top:10px; text-align:center;"></div>
        </div>
        <div id="variants"></div>
    </div>

    <div id="screen-pin" class="screen">
        <div style="text-align:center; margin-top:80px;">
            <div class="logo-box" style="background:#e5e7eb; color:#000;">üë§</div>
            <h2 id="pinUser"></h2>
            <div class="dots" id="pinDots">
                <div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div>
            </div>
            <div class="keypad" id="keypad"></div>
        </div>
    </div>

    <div id="screen-home" class="screen">
        <h1 id="homeUser" style="margin-top:10px"></h1>
        <div class="card">
            <div class="ip-badge" id="ipBadge">–ò–ü</div>
            <div class="small">–í—Å–µ–≥–æ –Ω–∞ —Å—á–µ—Ç—É</div>
            <div class="balance" id="hBal">0 ‚ÇΩ</div>
            <div class="small" id="hBonuses" style="color: var(--credit)">–ë–æ–Ω—É—Å—ã: 0 –ë</div>
        </div>
        <div id="accounts-container"></div>
    </div>

    <div class="tab-bar" id="main-nav" style="display: none;">
        <div class="tab-item active" onclick="navTo('screen-home', this)"><span>üè†</span><span>–ì–ª–∞–≤–Ω–∞—è</span></div>
        <div class="tab-item"><span>‚öôÔ∏è</span><span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span></div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA3J7KnUgxUHZigwRKmndm7xyxJeeLCrxg",
            authDomain: "webapp-b7149.firebaseapp.com",
            databaseURL: "https://webapp-b7149-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "webapp-b7149",
            storageBucket: "webapp-b7149.firebasestorage.app",
            messagingSenderId: "1034835242406",
            appId: "1:1034835242406:web:98499dc1edbb83e4b8f367"
        };

        firebase.initializeApp(firebaseConfig);
        const dbRef = firebase.database().ref('clients'); // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –ø–∞–ø–∫–æ–π clients –∏–∑ –∞–¥–º–∏–Ω–∫–∏

        let clientsData = [];
        let curUser = null;
        let enteredPin = "";

        // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –±–∞–∑–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
        dbRef.on('value', (snapshot) => {
            const val = snapshot.val();
            clientsData = val ? Object.keys(val).map(key => ({...val[key], fbKey: key})) : [];
            
            if(curUser) {
                const updated = clientsData.find(c => c.fbKey === curUser.fbKey);
                if(updated) {
                    curUser = updated;
                    checkLock();
                    if(document.getElementById('screen-home').classList.contains('active')) showHome();
                }
            }
        });

        function findClient() {
            const val = document.getElementById('loginInp').value.trim().toLowerCase();
            const results = clientsData.filter(c => c.name.toLowerCase().includes(val) || c.phone.includes(val));
            
            if(results.length === 0) {
                document.getElementById('error').innerText = "–ê–∫–∫–∞—É–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω";
            } else if (results.length === 1) {
                selectUser(results[0]);
            } else {
                let html = '';
                results.forEach(c => {
                    html += `<div class="card" onclick='selectUserByFbKey("${c.fbKey}")'>${c.name}</div>`;
                });
                document.getElementById('variants').innerHTML = html;
            }
        }

        function selectUser(user) {
            curUser = user;
            enteredPin = "";
            document.getElementById('pinUser').innerText = curUser.name;
            updateDots();
            navTo('screen-pin');
        }

        function selectUserByFbKey(key) {
            const user = clientsData.find(c => c.fbKey === key);
            selectUser(user);
        }

        function checkLock() {
            document.getElementById('blocked-view').style.display = curUser.frozen ? 'flex' : 'none';
        }

        function buildKeypad() {
            const keys = [1,2,3,4,5,6,7,8,9,'',0,'‚Üê'];
            const container = document.getElementById('keypad');
            container.innerHTML = '';
            keys.forEach(k => {
                const b = document.createElement('button');
                b.className = 'key';
                b.innerText = k;
                if(k === '') b.style.visibility = 'hidden';
                b.onclick = () => {
                    if(k === '‚Üê') enteredPin = enteredPin.slice(0, -1);
                    else if(typeof k === 'number' && enteredPin.length < 4) enteredPin += k;
                    updateDots();
                    
                    if(enteredPin.length === 4) {
                        // –ü–†–û–í–ï–†–ö–ê –ü–ò–ù-–ö–û–î–ê –ò–ó –ê–î–ú–ò–ù–ö–ò
                        if(enteredPin === curUser.clientPin) {
                            checkLock();
                            navTo('screen-home');
                        } else {
                            alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ü–ò–ù-–∫–æ–¥");
                            enteredPin = "";
                            updateDots();
                        }
                    }
                };
                container.appendChild(b);
            });
        }

        function updateDots() {
            const dots = document.getElementById('pinDots').children;
            for(let i=0; i<4; i++) dots[i].classList.toggle('filled', i < enteredPin.length);
        }

        function showHome() {
            document.getElementById('homeUser').innerText = `–ü—Ä–∏–≤–µ—Ç, ${curUser.name}`;
            document.getElementById('hBal').innerText = (curUser.balance || 0).toLocaleString() + " ‚ÇΩ";
            document.getElementById('hBonuses').innerText = "–ë–æ–Ω—É—Å—ã: " + (curUser.bonuses || 0).toLocaleString() + " –ë";
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ—Ç–∫—É –ò–ü –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å —Å–æ–≤–ø–∞–¥–∞–µ—Ç
            document.getElementById('ipBadge').style.display = (curUser.orgType === '–ò–ü') ? 'block' : 'none';

            document.getElementById('accounts-container').innerHTML = `
                <div class="card">
                    <div class="small">–ù–æ–º–µ—Ä —Å—á–µ—Ç–∞</div>
                    <div style="font-weight:600">ID: ${curUser.id}</div>
                    <div class="small" style="margin-top:10px">–¢—Ä–∞—Ç—ã –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ</div>
                    <div style="font-weight:600">${(curUser.spentMonth || 0).toLocaleString()} ‚ÇΩ</div>
                </div>
            `;
        }

        function navTo(id, el) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'screen-home') {
                document.getElementById('main-nav').style.display = 'flex';
                showHome();
            }
        }

        function hardReset() { location.reload(); }
        
        window.onload = () => {
            buildKeypad();
            navTo('screen-name');
        };
    </script>
</body>
</html>
