<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>K-Online Red Edition | Ultra Compact</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <style>
        /* -----------------------------------------------------------
           –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò –ò –ü–ï–†–ï–ú–ï–ù–ù–´–ï
           ----------------------------------------------------------- */
        :root {
            --bg-body: #f7f8fa; /* –ë–µ–ª—ã–π/—Å–≤–µ—Ç–ª—ã–π –Ω–∏–∑ */
            --bg-card-container: linear-gradient(170deg, #000000 10%, #520000 100%); /* –ß–µ—Ä–Ω–æ-–∫—Ä–∞—Å–Ω—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç */
            
            --white: #ffffff;
            --sber-green: #21a038;
            --danger: #ff3b30;
            
            --text-dark: #1c1c1e;
            --text-light: #f5f5f7;
            --text-grey: #8e8e93;
            
            --shadow-soft: 0 10px 40px rgba(0,0,0,0.08);
            --shadow-deep: 0 15px 35px rgba(0,0,0,0.3);
            
            --anim-bezier: cubic-bezier(0.34, 1.56, 0.64, 1); /* –ü—Ä—É–∂–∏–Ω–∏—Å—Ç–∞—è –∞–Ω–∏–º–∞—Ü–∏—è */
        }

        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            overflow: hidden; background: var(--bg-body); 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            color: var(--text-dark);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

        /* -----------------------------------------------------------
           –°–ò–°–¢–ï–ú–ê –≠–ö–†–ê–ù–û–í (SPA NAVIGATION)
           ----------------------------------------------------------- */
        .screen { 
            display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            width: 100%; height: 100%; overflow-y: auto; background: var(--bg-body);
            z-index: 10; opacity: 0; transform: scale(0.96);
            transition: opacity 0.4s ease, transform 0.4s var(--anim-bezier);
        }
        .screen.active { display: block !important; opacity: 1; transform: scale(1); }

        /* -----------------------------------------------------------
           –≠–ö–†–ê–ù 1: –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø
           ----------------------------------------------------------- */
        .auth-container { 
            padding: 90px 30px 40px; text-align: center; min-height: 100vh; 
            display: flex; flex-direction: column; background: var(--white);
        }
        .auth-logo { 
            font-size: 48px; font-weight: 900; 
            background: -webkit-linear-gradient(45deg, #000, #990000); 
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin: 0; letter-spacing: -2px; 
        }
        .auth-sub { color: var(--text-grey); font-size: 17px; margin-top: 8px; }
        
        .auth-list-box { 
            background: #f9f9f9; border-radius: 30px; padding: 10px; 
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.03); margin: 40px 0; 
            max-height: 350px; overflow-y: auto; flex-grow: 1;
        }
        .user-item { 
            padding: 20px; margin: 5px; background: white; border-radius: 20px;
            font-size: 18px; font-weight: 600; display: flex; justify-content: space-between; 
            align-items: center; cursor: pointer; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }
        .user-item:active { transform: scale(0.97); }
        .user-item.selected { border: 2px solid #990000; color: #990000; }

        /* -----------------------------------------------------------
           –≠–ö–†–ê–ù 2: –ü–ò–ù-–ö–û–î
           ----------------------------------------------------------- */
        #screen-pin-entry {
            background: linear-gradient(135deg, #000000 0%, #3a0000 100%);
            color: white; display: none; flex-direction: column; align-items: center; 
            justify-content: space-between; padding: 80px 30px 50px; z-index: 1000;
        }
        .pin-title-box { width: 100%; text-align: center; }
        .pin-dots { display: flex; gap: 20px; margin: 40px 0; justify-content: center; }
        .pin-dot { 
            width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.4); 
            border-radius: 50%; transition: 0.2s; 
        }
        .pin-dot.filled { background: #ff3b30; border-color: #ff3b30; transform: scale(1.3); box-shadow: 0 0 15px #ff3b30; }
        
        .keyboard-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; width: 100%; max-width: 300px; }
        .key-btn { 
            height: 75px; border-radius: 50%; background: rgba(255,255,255,0.1); 
            display: flex; align-items: center; justify-content: center; 
            font-size: 28px; font-weight: 500; cursor: pointer; transition: 0.1s;
        }
        .key-btn:active { background: rgba(255,255,255,0.3); }

        /* -----------------------------------------------------------
           –≠–ö–†–ê–ù 3: –ì–õ–ê–í–ù–´–ô (–†–ï–î–ò–ó–ê–ô–ù)
           ----------------------------------------------------------- */
        /* –ß–µ—Ä–Ω–æ-–∫—Ä–∞—Å–Ω–∞—è —à–∞–ø–∫–∞ —Å –∑–∞–∫—Ä—É–≥–ª–µ–Ω–∏–µ–º */
        .dashboard-header { 
            background: var(--bg-card-container); 
            padding: 60px 0 40px; /* –û—Ç—Å—Ç—É–ø—ã –¥–ª—è –∫–∞—Ä—Ç */
            border-radius: 0 0 45px 45px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            color: white;
            position: relative;
        }

        .user-info-row {
            padding: 0 25px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;
        }
        .user-avatar-circle {
            width: 48px; height: 48px; background: rgba(255,255,255,0.2); 
            backdrop-filter: blur(5px); border-radius: 50%; display: flex; 
            align-items: center; justify-content: center; font-weight: 700; border: 1px solid rgba(255,255,255,0.1);
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–∞—Ä—Ç —Å –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–º —Å–∫—Ä–æ–ª–ª–æ–º */
        .cards-scroller { 
            display: flex; overflow-x: auto; padding: 10px 25px 30px; gap: 15px; 
            scrollbar-width: none; scroll-snap-type: x mandatory; 
        }
        .cards-scroller::-webkit-scrollbar { display: none; }

        /* –ö–û–ú–ü–ê–ö–¢–ù–ê–Ø –ö–ê–†–¢–ê (SMALL SIZE) */
        .compact-card { 
            min-width: 165px;  /* –£–º–µ–Ω—å—à–µ–Ω–Ω–∞—è —à–∏—Ä–∏–Ω–∞ */
            height: 250px;     /* –£–º–µ–Ω—å—à–µ–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ */
            border-radius: 24px; 
            padding: 20px; 
            color: white; 
            display: flex; flex-direction: column; justify-content: space-between; 
            scroll-snap-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3); 
            position: relative; overflow: hidden;
            transition: transform 0.3s;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .compact-card:active { transform: scale(0.95); }

        /* –°—Ç–∏–ª–∏ –∫–∞—Ä—Ç */
        .bg-rub { background: linear-gradient(160deg, #2b2b2b 0%, #1a1a1a 100%); }
        .bg-usd { background: linear-gradient(160deg, #141E30 0%, #243B55 100%); }
        .bg-gold { background: linear-gradient(160deg, #BF953F 0%, #FCF6BA 50%, #B38728 100%); color: #4a3b00; text-shadow: none; }
        
        /* –≠–ª–µ–º–µ–Ω—Ç—ã –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ä—Ç—ã */
        .c-chip { width: 32px; height: 24px; background: rgba(255,255,255,0.2); border-radius: 6px; }
        .c-bal { font-size: 20px; font-weight: 800; margin-top: 10px; word-break: break-all; }
        .c-name { font-size: 11px; opacity: 0.6; text-transform: uppercase; letter-spacing: 1px; margin-top: auto; padding-top: 10px; }
        .c-logo { font-weight: 900; font-size: 14px; text-align: right; font-style: italic; }

        /* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π –Ω–∞ —Ç–µ–º–Ω–æ–º —Ñ–æ–Ω–µ */
        .dark-actions { display: flex; justify-content: center; gap: 25px; margin-top: 5px; }
        .d-btn { 
            width: 55px; height: 55px; 
            background: rgba(255,255,255,0.1); 
            backdrop-filter: blur(10px);
            border-radius: 20px; 
            display: flex; align-items: center; justify-content: center; font-size: 24px;
            cursor: pointer; border: 1px solid rgba(255,255,255,0.05);
            transition: 0.2s;
        }
        .d-btn:active { background: rgba(255,255,255,0.2); transform: translateY(2px); }

        /* –ë–µ–ª–∞—è —á–∞—Å—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
        .white-body-content { padding: 30px 20px 80px; }
        
        .widget { 
            background: white; border-radius: 24px; padding: 20px; margin-bottom: 15px; 
            display: flex; align-items: center; gap: 15px; box-shadow: var(--shadow-soft);
            transition: 0.2s;
        }
        .widget:active { transform: scale(0.98); background: #fcfcfc; }
        .w-icon { width: 45px; height: 45px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 20px; }

        /* -----------------------------------------------------------
           –≠–ö–†–ê–ù–´ –û–ü–ï–†–ê–¶–ò–ô (–§–û–†–ú–´)
           ----------------------------------------------------------- */
        .form-header { padding: 60px 25px 20px; }
        .form-card { 
            background: white; border-radius: 35px; padding: 30px; margin: 10px 15px;
            box-shadow: var(--shadow-soft);
        }
        
        label { display: block; font-size: 13px; font-weight: 700; color: #888; margin-left: 10px; margin-bottom: 5px; }
        input, select { 
            width: 100%; height: 55px; border-radius: 16px; border: 1px solid #e0e0e0; 
            padding: 0 15px; margin-bottom: 25px; font-size: 17px; background: #fafafa; transition: 0.3s;
        }
        input:focus { border-color: #000; background: #fff; }
        
        .main-btn { 
            width: 100%; height: 60px; background: #000; color: white; 
            border: none; border-radius: 18px; font-size: 17px; font-weight: 700; 
            cursor: pointer; transition: 0.2s;
        }
        .main-btn:active { opacity: 0.8; }
        .btn-red { background: var(--danger); margin-top: 15px; }

        .back-circle { 
            width: 40px; height: 40px; border-radius: 50%; background: #eee; 
            display: flex; align-items: center; justify-content: center; font-size: 20px; 
            cursor: pointer; margin-bottom: 15px;
        }

        /* -----------------------------------------------------------
           –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê –ò –î–ï–¢–ê–õ–ò
           ----------------------------------------------------------- */
        .modal-overlay { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.85); z-index: 5000; align-items: center; 
            justify-content: center; backdrop-filter: blur(15px); 
        }
        .modal-box { background: white; width: 88%; max-width: 380px; border-radius: 35px; padding: 35px; text-align: center; }
        
        /* –î–µ—Ç–∞–ª–∏ —Å—á–µ—Ç–∞ */
        .details-hero { 
            background: var(--white); padding: 70px 25px 40px; 
            border-radius: 0 0 45px 45px; box-shadow: var(--shadow-soft); text-align: center;
        }
        .hist-list { padding: 25px 15px; }
        .hist-row { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 18px 15px; border-bottom: 1px solid #f0f0f0; 
        }
    </style>
</head>
<body>

    <div id="modal-success" class="modal-overlay">
        <div class="modal-box">
            <div style="width:80px; height:80px; background:#2ecc71; color:white; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:40px; margin:0 auto 20px;">‚úì</div>
            <h2 id="suc-title" style="margin:0; font-size:24px;">–ì–æ—Ç–æ–≤–æ</h2>
            <div id="suc-sum" style="font-size:32px; font-weight:900; margin:15px 0;">0 ‚ÇΩ</div>
            <p id="suc-desc" style="color:#888; font-size:15px; margin-bottom:30px;"></p>
            <button class="main-btn btn-red" onclick="ui.closeSuccess()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <div id="screen-auth" class="screen active">
        <div class="auth-container">
            <h1 class="auth-logo">K-Online</h1>
            <div class="auth-sub">Black Edition</div>
            
            <div class="auth-list-box" id="auth-list">
                <div style="padding:40px; color:#aaa;">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –æ–±–ª–∞–∫—É...</div>
            </div>
            
            <div style="display:flex; gap:10px;">
                <button class="main-btn" style="background:#f2f2f2; color:black;" onclick="core.newUser()">+ –°–æ–∑–¥–∞—Ç—å</button>
                <button class="main-btn" style="width:80px; background: linear-gradient(45deg, #000, #550000);" onclick="core.toPin()">‚ûú</button>
            </div>
        </div>
    </div>

    <div id="screen-pin-entry" class="screen">
        <div class="pin-title-box">
            <h2 id="pin-hello" style="font-size:32px; font-weight:800; margin-bottom:10px;">–í—Ö–æ–¥</h2>
            <p style="opacity:0.7;">–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞</p>
        </div>
        
        <div class="pin-dots" id="pin-dots-ui">
            <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
        </div>
        
        <div class="keyboard-grid">
            <div class="key-btn" onclick="core.inputPin('1')">1</div><div class="key-btn" onclick="core.inputPin('2')">2</div><div class="key-btn" onclick="core.inputPin('3')">3</div>
            <div class="key-btn" onclick="core.inputPin('4')">4</div><div class="key-btn" onclick="core.inputPin('5')">5</div><div class="key-btn" onclick="core.inputPin('6')">6</div>
            <div class="key-btn" onclick="core.inputPin('7')">7</div><div class="key-btn" onclick="core.inputPin('8')">8</div><div class="key-btn" onclick="core.inputPin('9')">9</div>
            <div class="key-btn" style="opacity:0; pointer-events:none;"></div><div class="key-btn" onclick="core.inputPin('0')">0</div><div class="key-btn" onclick="core.inputPin('DEL')">‚å´</div>
        </div>
        <div onclick="ui.nav('screen-auth')" style="margin-top:20px; opacity:0.6; text-decoration:underline;">–û—Ç–º–µ–Ω–∞</div>
    </div>

    <div id="screen-home" class="screen">
        <div class="dashboard-header">
            <div class="user-info-row">
                <div>
                    <div id="home-name" style="font-size:24px; font-weight:800;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    <div style="font-size:13px; opacity:0.7; margin-top:4px;">Premium Status</div>
                </div>
                <div id="home-ava" class="user-avatar-circle">?</div>
            </div>
            
            <div class="cards-scroller" id="cards-container">
                </div>

            <div class="dark-actions">
                <div class="d-btn" onclick="ui.nav('screen-transfer')">üí∏</div>
                <div class="d-btn" onclick="ui.nav('screen-exchange')">üîÑ</div>
                <div class="d-btn" onclick="ui.nav('screen-loan')">üè¶</div>
                <div class="d-btn" onclick="alert('–ò—Å—Ç–æ—Ä–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ä—Ç—ã')">üßæ</div>
            </div>
        </div>

        <div class="white-body-content">
            <h3 style="margin: 0 0 15px 10px; font-size: 18px; color: #333;">–í–∞–∂–Ω–æ–µ —Å–µ–≥–æ–¥–Ω—è</h3>
            
            <div class="widget" onclick="ui.nav('screen-transfer')">
                <div class="w-icon" style="background:#e8f5e9; color:#2ecc71;">‚ö°</div>
                <div style="flex:1;">
                    <b style="font-size:16px;">–ë—ã—Å—Ç—Ä—ã–π –ø–µ—Ä–µ–≤–æ–¥</b>
                    <div style="font-size:13px; color:#999;">–ë–µ–∑ –∫–æ–º–∏—Å—Å–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞–º</div>
                </div>
            </div>
            
            <div class="widget" onclick="ui.nav('screen-exchange')">
                <div class="w-icon" style="background:#e3f2fd; color:#3494e6;">üí≤</div>
                <div style="flex:1;">
                    <b style="font-size:16px;">–ö—É—Ä—Å –î–æ–ª–ª–∞—Ä–∞</b>
                    <div id="widget-usd" style="font-size:14px; font-weight:700; color:#333;">91.20 ‚ÇΩ</div>
                </div>
            </div>

            <div id="widget-loan" class="widget" onclick="ui.nav('screen-loan')">
                <div class="w-icon" style="background:#fff3e0; color:#f39c12;">üî•</div>
                <div style="flex:1;">
                    <b style="font-size:16px;">–ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞</b>
                    <div style="font-size:13px; color:#e67e22;">–í–∞–º –æ–¥–æ–±—Ä–µ–Ω–æ 500 000 ‚ÇΩ</div>
                </div>
            </div>
        </div>
    </div>

    <div id="screen-transfer" class="screen">
        <div class="form-header">
            <div class="back-circle" onclick="ui.nav('screen-home')">‚Üê</div>
            <h2 style="font-size:32px; font-weight:900;">–ü–µ—Ä–µ–≤–æ–¥</h2>
        </div>
        <div class="form-card">
            <label>–ö–æ–º—É –ø–µ—Ä–µ–≤–µ—Å—Ç–∏</label>
            <select id="inp-tr-to"></select>
            
            <label>–°—É–º–º–∞ (‚ÇΩ)</label>
            <input type="number" id="inp-tr-sum" placeholder="0">
            
            <button class="main-btn" onclick="bank.transfer()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            <button class="main-btn btn-red" onclick="ui.nav('screen-home')">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <div id="screen-exchange" class="screen">
        <div class="form-header">
            <div class="back-circle" onclick="ui.nav('screen-home')">‚Üê</div>
            <h2 style="font-size:32px; font-weight:900;">–û–±–º–µ–Ω –≤–∞–ª—é—Ç</h2>
        </div>
        <div class="form-card" style="text-align:center;">
            <p style="color:#888; margin-bottom:5px;">–¢–µ–∫—É—â–∏–π –∫—É—Ä—Å –ø—Ä–æ–¥–∞–∂–∏</p>
            <div style="font-size:48px; font-weight:900; margin-bottom:30px;">91.20 ‚ÇΩ</div>
            
            <label style="text-align:left;">–°–∫–æ–ª—å–∫–æ –∫—É–ø–∏—Ç—å ($)</label>
            <input type="number" id="inp-exc-usd" placeholder="100">
            
            <button class="main-btn" style="background:#3494e6;" onclick="bank.buyUsd()">–ö—É–ø–∏—Ç—å USD</button>
            <button class="main-btn btn-red" onclick="ui.nav('screen-home')">–ó–∞–∫—Ä—ã—Ç—å</button>
            <p style="font-size:12px; color:#aaa; margin-top:15px;">–û—Ç–∫—Ä–æ–µ—Ç—Å—è –Ω–æ–≤–∞—è –∫–∞—Ä—Ç–∞ VISA Digital</p>
        </div>
    </div>

    <div id="screen-loan" class="screen">
        <div class="form-header">
            <div class="back-circle" onclick="ui.nav('screen-home')">‚Üê</div>
            <h2 style="font-size:32px; font-weight:900;">–ö—Ä–µ–¥–∏—Ç</h2>
        </div>
        <div class="form-card">
            <label>–ñ–µ–ª–∞–µ–º—ã–π –ª–∏–º–∏—Ç (‚ÇΩ)</label>
            <input type="number" id="inp-loan-sum" placeholder="–ú–∏–Ω. 10 000">
            
            <div style="font-size:12px; color:#999; margin-bottom:20px;">
                –°—Ç–∞–≤–∫–∞ 14.9% –≥–æ–¥–æ–≤—ã—Ö. –õ—å–≥–æ—Ç–Ω—ã–π –ø–µ—Ä–∏–æ–¥ 120 –¥–Ω–µ–π.
            </div>
            
            <button class="main-btn" style="background:#f39c12;" onclick="bank.takeLoan()">–û—Ñ–æ—Ä–º–∏—Ç—å –∫–∞—Ä—Ç—É</button>
            <button class="main-btn btn-red" onclick="ui.nav('screen-home')">–ù–∞–∑–∞–¥</button>
        </div>
    </div>

    <div id="screen-details" class="screen">
        <div class="details-hero">
            <div class="back-circle" onclick="ui.nav('screen-home')" style="margin:0 auto 15px; background:#f5f5f5;">‚úï</div>
            <div id="det-type" style="text-transform:uppercase; font-size:12px; font-weight:800; color:#888; letter-spacing:2px;">–°—á–µ—Ç</div>
            <h1 id="det-amount" style="font-size:46px; font-weight:900; margin:10px 0;">0</h1>
            <div id="det-actions" style="margin-top:20px;"></div>
        </div>
        <div class="hist-list">
            <h3 style="margin-left:10px;">–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</h3>
            <div id="det-hist-box"></div>
        </div>
    </div>

    <script>
        /**
         * -------------------------------------------------------------
         * K-ONLINE CORE LOGIC
         * -------------------------------------------------------------
         */
        
        // 1. –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE
        const fbConfig = { 
            apiKey: "AIzaSyA3J7KnUgxUHZigwRKmndm7xyxJeeLCrxg", 
            databaseURL: "https://webapp-b7149-default-rtdb.europe-west1.firebasedatabase.app", 
            projectId: "webapp-b7149" 
        };
        firebase.initializeApp(fbConfig);
        const db = firebase.database();

        // 2. –ì–õ–û–ë–ê–õ–¨–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï
        const state = {
            users: [],
            selectedUid: null,
            currentUser: null,
            pinBuffer: "",
            isBusy: false
        };

        // 3. UI –ú–ï–ù–ï–î–ñ–ï–†
        const ui = {
            nav: (id) => {
                document.querySelectorAll('.screen').forEach(s => {
                    s.classList.remove('active');
                    setTimeout(() => { if(!s.classList.contains('active')) s.style.display = 'none'; }, 400);
                });
                const t = document.getElementById(id);
                t.style.display = (id === 'screen-pin-entry') ? 'flex' : 'block';
                setTimeout(() => t.classList.add('active'), 50);
                window.scrollTo(0,0);
            },
            
            renderUsers: () => {
                const list = document.getElementById('auth-list');
                if(!state.users.length) { list.innerHTML = '<div style="padding:30px">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>'; return; }
                
                list.innerHTML = state.users.map(u => `
                    <div class="user-item ${state.selectedUid === u.fbKey ? 'selected' : ''}" onclick="core.selectUser('${u.fbKey}')">
                        <span>${u.name}</span>
                        ${state.selectedUid === u.fbKey ? '<span>‚óè</span>' : ''}
                    </div>
                `).join('');
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ–ª–µ–∫—Ç–∞ –ø–µ—Ä–µ–≤–æ–¥–∞
                const sel = document.getElementById('inp-tr-to');
                if(sel) {
                    sel.innerHTML = state.users
                        .filter(u => u.fbKey !== state.currentUser?.fbKey)
                        .map(u => `<option value="${u.fbKey}">${u.name}</option>`).join('');
                }
            },

            renderDashboard: () => {
                const u = state.currentUser;
                if(!u) return;

                document.getElementById('home-name').innerText = u.name;
                document.getElementById('home-ava').innerText = u.name[0];
                document.getElementById('widget-usd').innerText = (u.usd || 0).toFixed(2) + " $";

                const container = document.getElementById('cards-container');
                let html = '';

                // –ö–∞—Ä—Ç–∞ 1: –†—É–±–ª–µ–≤–∞—è (–í—Å–µ–≥–¥–∞ –µ—Å—Ç—å)
                html += `
                    <div class="compact-card bg-rub" onclick="ui.openDetails('rub')">
                        <div style="display:flex; justify-content:space-between;">
                            <div class="c-chip"></div>
                            <div class="c-logo">MIR</div>
                        </div>
                        <div>
                            <div class="c-bal">${(u.balance || 0).toLocaleString()} ‚ÇΩ</div>
                            <div class="c-name">Main Debit ‚Ä¢ 4200</div>
                        </div>
                    </div>
                `;

                // –ö–∞—Ä—Ç–∞ 2: –î–æ–ª–ª–∞—Ä–æ–≤–∞—è (–ï—Å–ª–∏ –µ—Å—Ç—å –±–∞–ª–∞–Ω—Å)
                if(u.usd > 0) {
                    html += `
                        <div class="compact-card bg-usd" onclick="ui.openDetails('usd')">
                            <div style="display:flex; justify-content:space-between;">
                                <div class="c-chip"></div>
                                <div class="c-logo">VISA</div>
                            </div>
                            <div>
                                <div class="c-bal">${u.usd.toFixed(2)} $</div>
                                <div class="c-name">Digital USD ‚Ä¢ 8811</div>
                            </div>
                        </div>
                    `;
                }

                // –ö–∞—Ä—Ç–∞ 3: –ö—Ä–µ–¥–∏—Ç–Ω–∞—è (–ï—Å–ª–∏ –µ—Å—Ç—å)
                if(u.hasCredit) {
                    document.getElementById('widget-loan').style.display = 'none';
                    html += `
                        <div class="compact-card bg-gold" onclick="ui.openDetails('gold')">
                            <div style="display:flex; justify-content:space-between;">
                                <div class="c-chip" style="background:rgba(0,0,0,0.1)"></div>
                                <div class="c-logo">GOLD</div>
                            </div>
                            <div>
                                <div class="c-bal" style="color:#4a3b00">${(u.creditBalance || 0).toLocaleString()} ‚ÇΩ</div>
                                <div class="c-name" style="color:#6e5800">Credit Limit ‚Ä¢ 7777</div>
                            </div>
                        </div>
                    `;
                } else {
                    document.getElementById('widget-loan').style.display = 'flex';
                }

                container.innerHTML = html;
            },

            openDetails: (type) => {
                const u = state.currentUser;
                const tit = document.getElementById('det-type');
                const am = document.getElementById('det-amount');
                const acts = document.getElementById('det-actions');
                
                let hist = [];
                if(u.history) hist = Object.values(u.history).reverse();

                if(type === 'rub') {
                    tit.innerText = "MIR PREMIUM";
                    am.innerText = u.balance.toLocaleString() + " ‚ÇΩ";
                    am.style.color = "#000";
                    acts.innerHTML = `<button class="main-btn" onclick="ui.nav('screen-transfer')">–ü–µ—Ä–µ–≤–µ—Å—Ç–∏</button>`;
                }
                else if(type === 'usd') {
                    tit.innerText = "VISA DIGITAL";
                    am.innerText = u.usd.toFixed(2) + " $";
                    am.style.color = "#2980b9";
                    acts.innerHTML = `<button class="main-btn" onclick="ui.nav('screen-exchange')">–ö—É–ø–∏—Ç—å –µ—â–µ</button>`;
                }
                else if(type === 'gold') {
                    tit.innerText = "CREDIT GOLD";
                    am.innerText = u.creditBalance.toLocaleString() + " ‚ÇΩ";
                    am.style.color = "#f39c12";
                    const debt = (u.creditLimit || 0) - (u.creditBalance || 0);
                    if(debt > 0) {
                        acts.innerHTML = `<button class="main-btn" onclick="bank.repay(${debt})">–ü–æ–≥–∞—Å–∏—Ç—å (${debt} ‚ÇΩ)</button>`;
                    } else {
                        acts.innerHTML = `<div style="color:green; font-weight:bold;">–ó–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–∏ –Ω–µ—Ç</div>`;
                    }
                }

                // –†–µ–Ω–¥–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏
                const box = document.getElementById('det-hist-box');
                box.innerHTML = hist.length ? hist.map(h => `
                    <div class="hist-row">
                        <div>
                            <div style="font-weight:700;">${h.title}</div>
                            <div style="font-size:12px; color:#aaa;">${new Date(h.date).toLocaleDateString()}</div>
                        </div>
                        <div style="font-weight:bold; color:${h.sum > 0 ? '#2ecc71' : '#000'}">
                            ${h.sum > 0 ? '+' : ''}${h.sum.toLocaleString()}
                        </div>
                    </div>
                `).join('') : '<div style="text-align:center; padding:20px; color:#ccc;">–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</div>';

                ui.nav('screen-details');
            },

            showSuccess: (t, s, d) => {
                document.getElementById('suc-title').innerText = t;
                document.getElementById('suc-sum').innerText = s;
                document.getElementById('suc-desc').innerText = d;
                document.getElementById('modal-success').style.display = 'flex';
            },
            closeSuccess: () => {
                document.getElementById('modal-success').style.display = 'none';
                ui.nav('screen-home');
            }
        };

        // 4. –ë–ò–ó–ù–ï–° –õ–û–ì–ò–ö–ê
        const core = {
            init: () => {
                db.ref('clients').on('value', snap => {
                    const val = snap.val();
                    state.users = val ? Object.keys(val).map(k => ({...val[k], fbKey: k})) : [];
                    ui.renderUsers();
                    if(state.currentUser) {
                        state.currentUser = state.users.find(u => u.fbKey === state.currentUser.fbKey);
                        ui.renderDashboard();
                    }
                });
            },
            selectUser: (uid) => {
                state.selectedUid = uid;
                ui.renderUsers();
            },
            toPin: () => {
                if(!state.selectedUid) return alert("–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è");
                const u = state.users.find(x => x.fbKey === state.selectedUid);
                document.getElementById('pin-hello').innerText = "–ü—Ä–∏–≤–µ—Ç, " + u.name.split(' ')[0];
                state.pinBuffer = "";
                core.updatePinUI();
                ui.nav('screen-pin-entry');
            },
            inputPin: (key) => {
                if(state.isBusy) return;
                if(key === 'DEL') state.pinBuffer = state.pinBuffer.slice(0, -1);
                else if(state.pinBuffer.length < 4) state.pinBuffer += key;
                
                core.updatePinUI();

                if(state.pinBuffer.length === 4) {
                    state.isBusy = true;
                    setTimeout(() => {
                        const u = state.users.find(x => x.fbKey === state.selectedUid);
                        if(u.clientPin === state.pinBuffer) {
                            state.currentUser = u;
                            ui.renderDashboard();
                            ui.nav('screen-home');
                            state.pinBuffer = "";
                        } else {
                            alert("–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥");
                            state.pinBuffer = "";
                            core.updatePinUI();
                        }
                        state.isBusy = false;
                    }, 200);
                }
            },
            updatePinUI: () => {
                document.querySelectorAll('.pin-dot').forEach((d, i) => {
                    d.classList.toggle('filled', i < state.pinBuffer.length);
                });
            },
            newUser: () => {
                const n = prompt("–§–ò–û –∫–ª–∏–µ–Ω—Ç–∞:");
                const p = prompt("–ü–ò–ù-–∫–æ–¥ (4 —Ü–∏—Ñ—Ä—ã):");
                if(n && p && p.length===4) {
                    db.ref('clients').push({
                        name: n, clientPin: p, balance: 50000, usd: 0, hasCredit: false,
                        history: { init: {title:"–û—Ç–∫—Ä—ã—Ç–∏–µ —Å—á–µ—Ç–∞", sum: 50000, date: Date.now()} }
                    });
                }
            }
        };

        const bank = {
            transfer: () => {
                const toId = document.getElementById('inp-tr-to').value;
                const sum = parseInt(document.getElementById('inp-tr-sum').value);
                const u = state.currentUser;
                const target = state.users.find(x => x.fbKey === toId);

                if(!sum || sum <= 0) return alert("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—É–º–º–∞");
                if(u.balance < sum) return alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤");

                db.ref(`clients/${u.fbKey}`).update({ balance: u.balance - sum });
                db.ref(`clients/${u.fbKey}/history`).push({ title: `–ü–µ—Ä–µ–≤–æ–¥ (${target.name})`, sum: -sum, date: Date.now() });
                
                db.ref(`clients/${toId}`).update({ balance: (target.balance||0) + sum });
                db.ref(`clients/${toId}/history`).push({ title: `–í—Ö–æ–¥—è—â–∏–π (${u.name})`, sum: sum, date: Date.now() });

                ui.showSuccess("–ü–µ—Ä–µ–≤–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω", sum + " ‚ÇΩ", "–ü–æ–ª—É—á–∞—Ç–µ–ª—å: " + target.name);
                document.getElementById('inp-tr-sum').value = "";
            },
            buyUsd: () => {
                const amount = parseFloat(document.getElementById('inp-exc-usd').value);
                const rate = 91.20;
                const cost = Math.round(amount * rate);
                const u = state.currentUser;

                if(!amount || amount <= 0) return alert("–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É");
                if(u.balance < cost) return alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä—É–±–ª–µ–π");

                db.ref(`clients/${u.fbKey}`).update({
                    balance: u.balance - cost,
                    usd: (u.usd || 0) + amount
                });
                db.ref(`clients/${u.fbKey}/history`).push({ title: "–ü–æ–∫—É–ø–∫–∞ USD", sum: -cost, date: Date.now() });

                ui.showSuccess("–£—Å–ø–µ—à–Ω–æ", amount + " $", `–°–ø–∏—Å–∞–Ω–æ ${cost} ‚ÇΩ. –ù–æ–≤–∞—è –∫–∞—Ä—Ç–∞ –¥–æ—Å—Ç—É–ø–Ω–∞.`);
                document.getElementById('inp-exc-usd').value = "";
            },
            takeLoan: () => {
                const sum = parseInt(document.getElementById('inp-loan-sum').value);
                if(!sum || sum < 10000) return alert("–ú–∏–Ω–∏–º—É–º 10 000 ‚ÇΩ");
                
                const u = state.currentUser;
                db.ref(`clients/${u.fbKey}`).update({
                    hasCredit: true, creditLimit: sum, creditBalance: sum
                });
                db.ref(`clients/${u.fbKey}/history`).push({ title: "–ö—Ä–µ–¥–∏—Ç –≤—ã–¥–∞–Ω", sum: sum, date: Date.now() });

                ui.showSuccess("–ö—Ä–µ–¥–∏—Ç –æ–¥–æ–±—Ä–µ–Ω", sum + " ‚ÇΩ", "–ö–∞—Ä—Ç–∞ Gold –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞");
                document.getElementById('inp-loan-sum').value = "";
            },
            repay: (amount) => {
                const u = state.currentUser;
                if(u.balance < amount) return alert("–ú–∞–ª–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ —Ä—É–±–ª–µ–≤–æ–º —Å—á–µ—Ç–µ");
                
                db.ref(`clients/${u.fbKey}`).update({
                    balance: u.balance - amount,
                    creditBalance: u.creditLimit
                });
                db.ref(`clients/${u.fbKey}/history`).push({ title: "–ü–æ–≥–∞—à–µ–Ω–∏–µ –¥–æ–ª–≥–∞", sum: -amount, date: Date.now() });
                
                ui.nav('screen-home');
                alert("–î–æ–ª–≥ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–≥–∞—à–µ–Ω!");
            }
        };

        // –ó–ê–ü–£–°–ö
        window.onload = () => {
            core.init();
            ui.nav('screen-auth');
        };

    </script>
</body>
</html>
