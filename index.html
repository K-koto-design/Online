<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>K-Online Pro Max Gold Edition</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <style>
        /* –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ —Å–±—Ä–æ—Å —Å—Ç–∏–ª–µ–π */
        :root {
            --bg-main: #f4f6f8;
            --white: #ffffff;
            --sber-green: #21a038;
            --sber-accent: #2cc74d;
            --danger: #eb4d4b;
            --text-dark: #1c1c1e;
            --text-grey: #8e8e93;
            --shadow: 0 12px 35px rgba(0,0,0,0.1);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            overflow: hidden; background: var(--bg-main); 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

        /* –°–∏—Å—Ç–µ–º–∞ —ç–∫—Ä–∞–Ω–æ–≤ */
        .screen { 
            display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            width: 100%; height: 100%; overflow-y: auto; background: var(--bg-main);
            z-index: 10; opacity: 0; transform: translateY(10px);
            transition: opacity 0.4s ease, transform 0.4s ease;
        }
        .screen.active { display: block !important; opacity: 1; transform: translateY(0); }

        /* –≠–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ –∞–∫–∫–∞—É–Ω—Ç–∞ */
        .auth-container { padding: 80px 25px 40px; text-align: center; min-height: 100vh; display: flex; flex-direction: column; }
        .auth-logo { font-size: 48px; font-weight: 900; color: #3494e6; margin: 0; letter-spacing: -2px; }
        .auth-subtitle { color: var(--text-grey); font-size: 18px; margin-top: 8px; margin-bottom: 35px; }
        
        .auth-card { 
            background: var(--white); border-radius: 32px; padding: 12px; 
            box-shadow: var(--shadow); margin-bottom: 30px; max-height: 400px; 
            overflow-y: auto; border: 1px solid rgba(0,0,0,0.04); flex-grow: 1;
        }
        .user-row { 
            padding: 24px; border-bottom: 1px solid #f5f5f7; font-size: 20px; 
            font-weight: 600; display: flex; justify-content: space-between; 
            align-items: center; cursor: pointer; border-radius: 20px; transition: var(--transition);
        }
        .user-row:active { background: #f9f9f9; transform: scale(0.98); }
        .user-row.selected { background: #eef9ef; color: var(--sber-green); }

        /* –≠–∫—Ä–∞–Ω –ü–ò–ù-–∫–æ–¥–∞ */
        #screen-pin-entry {
            background: linear-gradient(160deg, #3494e6 0%, #2ecc71 100%);
            color: white; display: none; flex-direction: column; align-items: center; 
            justify-content: space-between; padding: 70px 30px 50px; text-align: center; z-index: 1000;
        }
        .pin-greeting-box { text-align: left; width: 100%; }
        .pin-dots { display: flex; gap: 22px; margin: 50px 0; justify-content: center; }
        .pin-dot { width: 18px; height: 18px; border: 2.5px solid rgba(255,255,255,0.35); border-radius: 50%; transition: var(--transition); }
        .pin-dot.filled { background: white; border-color: white; transform: scale(1.3); box-shadow: 0 0 15px rgba(255,255,255,0.5); }
        
        .v-keyboard { display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px; width: 100%; max-width: 330px; }
        .v-key { 
            height: 80px; border-radius: 50%; background: rgba(255,255,255,0.12); 
            display: flex; align-items: center; justify-content: center; 
            font-size: 30px; font-weight: 500; cursor: pointer; transition: background 0.15s;
        }
        .v-key:active { background: rgba(255,255,255,0.3); transform: scale(0.9); }

        /* –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω –∏ –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        .top-nav { background: var(--white); padding: 65px 22px 35px; border-radius: 0 0 38px 38px; box-shadow: var(--shadow); }
        .user-profile-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 28px; }
        
        .cards-area { display: flex; align-items: center; gap: 18px; margin-top: 15px; }
        .side-actions { display: flex; flex-direction: column; gap: 14px; }
        .side-btn { 
            width: 52px; height: 52px; background: #f2f4f7; border-radius: 16px; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 24px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); cursor: pointer;
        }

        .card-slider { display: flex; overflow-x: auto; padding: 12px 5px; gap: 18px; scrollbar-width: none; flex: 1; }
        .card-slider::-webkit-scrollbar { display: none; }
        
        .bank-card { 
            min-width: 285px; height: 175px; border-radius: 28px; padding: 25px; 
            color: white; display: flex; flex-direction: column; justify-content: space-between;
            box-shadow: 0 15px 30px rgba(0,0,0,0.2); position: relative; overflow: hidden;
        }
        .card-debit { background: linear-gradient(135deg, #1d1d1f 0%, #434343 100%); }
        .card-credit { background: linear-gradient(135deg, #d4af37 0%, #8a6d3b 100%); }
        
        /* –í–∏–¥–∂–µ—Ç—ã */
        .widget { 
            background: white; border-radius: 26px; padding: 22px; margin: 18px 22px; 
            display: flex; align-items: center; gap: 18px; box-shadow: var(--shadow);
            transition: var(--transition); cursor: pointer;
        }
        .widget:active { transform: scale(0.97); }
        .widget-icon { width: 54px; height: 54px; border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 26px; }

        /* –ö–Ω–æ–ø–∫–∏ –∏ —Ñ–æ—Ä–º—ã */
        .submit-btn { 
            width: 100%; height: 62px; background: var(--sber-green); color: white; 
            border: none; border-radius: 22px; font-size: 19px; font-weight: 700; 
            cursor: pointer; transition: var(--transition); margin-top: 10px;
        }
        .submit-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-red { background: var(--danger) !important; margin-top: 15px; }
        
        .modal-overlay { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.75); z-index: 5000; align-items: center; 
            justify-content: center; backdrop-filter: blur(15px); 
        }
        .modal-card { background: white; width: 92%; max-width: 420px; border-radius: 40px; padding: 40px; text-align: center; }
        
        input, select { 
            width: 100%; height: 60px; border-radius: 18px; border: 1.5px solid #ececec; 
            padding: 0 20px; margin-top: 15px; background: #fafafa; font-size: 18px; transition: border 0.3s;
        }
        input:focus { border-color: var(--sber-green); background: white; }
        
        .back-arrow { font-size: 36px; margin-bottom: 30px; cursor: pointer; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
        .back-arrow:active { background: rgba(0,0,0,0.05); }

        /* –°–ø–∏—Å–æ–∫ –∏—Å—Ç–æ—Ä–∏–∏ */
        .hist-container { margin-top: 10px; }
        .hist-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 18px 0; border-bottom: 1.5px solid #f8f8f8; 
        }
        .hist-info { display: flex; flex-direction: column; gap: 4px; }
        .hist-sum { font-weight: 800; font-size: 17px; }
    </style>
</head>
<body>

    <div id="modal-success" class="modal-overlay">
        <div class="modal-card">
            <div style="width:90px; height:90px; background:var(--sber-green); color:white; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:45px; margin:0 auto 30px; box-shadow: 0 10px 20px rgba(33, 160, 56, 0.3);">‚úì</div>
            <h2 id="success-title" style="margin:0; font-size: 26px; font-weight: 800;">–ì–æ—Ç–æ–≤–æ</h2>
            <div id="success-amount" style="font-size: 36px; font-weight: 900; margin: 18px 0; color: var(--text-dark);">0 ‚ÇΩ</div>
            <p id="success-path" style="color:var(--text-grey); font-size: 17px; margin-bottom: 35px;"></p>
            <button class="submit-btn btn-red" onclick="closeSuccessModal()">–ó–∞–∫—Ä—ã—Ç—å —á–µ–∫</button>
        </div>
    </div>

    <div id="screen-auth" class="screen active">
        <div class="auth-container">
            <h1 class="auth-logo">K-Online</h1>
            <p class="auth-subtitle">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å –¥–ª—è –≤—Ö–æ–¥–∞</p>
            
            <div class="auth-card" id="userListUI">
                <div style="padding:40px; color:grey;">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –æ–±–ª–∞–∫–∞...</div>
            </div>
            
            <div style="display: flex; gap: 15px;">
                <button class="submit-btn" style="background: #1c1c1e; flex: 1;" onclick="registerNewUser()">+ –°–æ–∑–¥–∞—Ç—å</button>
                <button class="submit-btn" style="width: 100px; background: #3494e6;" onclick="proceedToPin()">‚ûú</button>
            </div>
        </div>
    </div>

    <div id="screen-pin-entry" class="screen">
        <div class="pin-greeting-box">
            <h2 id="pinGreeting" style="font-size: 38px; margin: 0; font-weight: 800;">–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ</h2>
            <p style="opacity: 0.9; font-size: 19px; margin-top: 10px;">–í–≤–µ–¥–∏—Ç–µ –ü–ò–ù-–∫–æ–¥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</p>
        </div>
        
        <div class="pin-dots" id="pinDots">
            <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
        </div>
        
        <div class="v-keyboard">
            <div class="v-key" onclick="handlePinInput('1')">1</div>
            <div class="v-key" onclick="handlePinInput('2')">2</div>
            <div class="v-key" onclick="handlePinInput('3')">3</div>
            <div class="v-key" onclick="handlePinInput('4')">4</div>
            <div class="v-key" onclick="handlePinInput('5')">5</div>
            <div class="v-key" onclick="handlePinInput('6')">6</div>
            <div class="v-key" onclick="handlePinInput('7')">7</div>
            <div class="v-key" onclick="handlePinInput('8')">8</div>
            <div class="v-key" onclick="handlePinInput('9')">9</div>
            <div class="v-key" style="background:none; pointer-events:none;"></div>
            <div class="v-key" onclick="handlePinInput('0')">0</div>
            <div class="v-key" onclick="handlePinInput('BACKSPACE')">‚å´</div>
        </div>
        
        <div onclick="navigate('screen-auth')" style="margin-bottom: 10px; opacity: 0.85; font-size: 18px; font-weight: 500;">
            –û—Ç–º–µ–Ω–∞ –∏ –≤—ã—Ö–æ–¥
        </div>
    </div>

    <div id="screen-home" class="screen">
        <div class="top-nav">
            <div class="user-profile-header">
                <div>
                    <div id="displayName" style="font-size:26px; font-weight:900; color: var(--text-dark);">...</div>
                    <div style="font-size:15px; color:var(--sber-green); font-weight:700; margin-top:4px; display:flex; align-items:center; gap:5px;">
                        <span style="background:var(--sber-green); width:8px; height:8px; border-radius:50%;"></span> –ü—Ä–∞–π–º-—Å—Ç–∞—Ç—É—Å
                    </div>
                </div>
                <div id="userAvatar" style="width:52px; height:52px; background:var(--sber-green); color:white; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:900; font-size: 22px; box-shadow: 0 4px 10px rgba(33, 160, 56, 0.2);">?</div>
            </div>
            
            <div class="cards-area">
                <div class="side-actions">
                    <div class="side-btn" onclick="navigate('screen-transfer')">üí∏</div>
                    <div class="side-btn" onclick="navigate('screen-exchange')">üîÑ</div>
                </div>
                <div class="card-slider">
                    <div class="bank-card card-debit" onclick="openCardDetails('debit')">
                        <span style="font-size:13px; font-weight:800; opacity:0.6; letter-spacing:1.2px;">MIR DEBIT PREMIUM</span>
                        <div>
                            <div id="ui-main-balance" style="font-size:34px; font-weight:900;">0 ‚ÇΩ</div>
                            <div style="font-size:14px; opacity:0.4; margin-top:8px;">‚óè‚óè‚óè‚óè 4002</div>
                        </div>
                    </div>
                    <div id="ui-credit-card-block" class="bank-card card-credit" style="display:none;" onclick="openCardDetails('credit')">
                        <span style="font-size:13px; font-weight:800; opacity:0.8; letter-spacing:1.2px;">GOLD CREDIT LINE</span>
                        <div>
                            <div id="ui-credit-balance" style="font-size:34px; font-weight:900;">0 ‚ÇΩ</div>
                            <div id="ui-credit-debt-hint" style="font-size:14px; opacity:0.7; margin-top:8px;">–î–æ—Å—Ç—É–ø–Ω—ã–π –ª–∏–º–∏—Ç</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div style="padding: 15px 0 40px;">
            <div class="widget" onclick="navigate('screen-transfer')">
                <div class="widget-icon" style="background:#e8f5e9; color:var(--sber-green);">üí∏</div>
                <div style="flex:1;"><b style="font-size:18px;">–ü–µ—Ä–µ–≤–æ–¥—ã</b><div style="font-size:14px; color:grey;">–ü–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏–ª–∏ –∫–∞—Ä—Ç—ã</div></div>
            </div>
            
            <div class="widget" onclick="navigate('screen-exchange')">
                <div class="widget-icon" style="background:#e3f2fd; color:#1e88e5;">üè¶</div>
                <div style="flex:1;"><b style="font-size:18px;">–ö—É—Ä—Å—ã –≤–∞–ª—é—Ç</b><div id="ui-usd-rate" style="font-weight:700; color:var(--text-dark);">0.00 $</div></div>
            </div>
            
            <div id="ui-loan-promo" class="widget" onclick="navigate('screen-loan')">
                <div class="widget-icon" style="background:#fff3e0; color:#fb8c00;">üìà</div>
                <div style="flex:1;"><b style="font-size:18px;">–ö—Ä–µ–¥–∏—Ç</b><div style="font-size:14px; color:var(--sber-green);">–û–¥–æ–±—Ä–µ–Ω–æ –¥–æ 1 500 000 ‚ÇΩ</div></div>
            </div>
        </div>
    </div>

    <div id="screen-transfer" class="screen">
        <div style="padding:65px 25px;">
            <div class="back-arrow" onclick="navigate('screen-home')">‚Üê</div>
            <h2 style="font-size: 32px; margin-bottom: 15px; font-weight: 800;">–ù–æ–≤—ã–π –ø–µ—Ä–µ–≤–æ–¥</h2>
            <p style="color: grey; margin-bottom: 30px; font-size: 16px;">–ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ –ø–µ—Ä–µ–≤–æ–¥—ã –±–µ–∑ –∫–æ–º–∏—Å—Å–∏–∏ –≤–Ω—É—Ç—Ä–∏ —Å–∏—Å—Ç–µ–º—ã K-Online.</p>
            
            <div style="background:white; padding:30px; border-radius:35px; box-shadow: var(--shadow);">
                <label style="font-weight: 700; color: #444; margin-left: 5px;">–ü–æ–ª—É—á–∞—Ç–µ–ª—å</label>
                <select id="input-transfer-target"></select>
                
                <label style="font-weight: 700; color: #444; display:block; margin-top:25px; margin-left: 5px;">–°—É–º–º–∞ –ø–µ—Ä–µ–≤–æ–¥–∞</label>
                <input type="number" id="input-transfer-amount" placeholder="0.00 ‚ÇΩ">
                
                <button class="submit-btn" style="margin-top:35px;" onclick="executeMoneyTransfer()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–µ–Ω—å–≥–∏</button>
                <button class="submit-btn btn-red" onclick="navigate('screen-home')">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <div id="screen-loan" class="screen">
        <div style="padding:65px 25px;">
            <div class="back-arrow" onclick="navigate('screen-home')">‚Üê</div>
            <h2 style="font-size: 32px; margin-bottom: 15px; font-weight: 800;">–ö—Ä–µ–¥–∏—Ç –∑–∞ –º–∏–Ω—É—Ç—É</h2>
            <p style="color: grey; margin-bottom: 30px; font-size: 16px;">–í–∞—à–∞ –∑–∞—è–≤–∫–∞ —É–∂–µ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –æ–¥–æ–±—Ä–µ–Ω–∞. –î–µ–Ω—å–≥–∏ –ø—Ä–∏–¥—É—Ç –Ω–∞ GOLD –∫–∞—Ä—Ç—É.</p>
            
            <div style="background:white; padding:30px; border-radius:35px; box-shadow: var(--shadow);">
                <label style="font-weight: 700; color: #444; margin-left: 5px;">–ñ–µ–ª–∞–µ–º—ã–π –ª–∏–º–∏—Ç (‚ÇΩ)</label>
                <input type="number" id="input-loan-limit" placeholder="–û—Ç 15 000 ‚ÇΩ">
                
                <div style="margin-top:25px; font-size:14px; color:#999; line-height: 1.5;">–ù–∞–∂–∏–º–∞—è –∫–Ω–æ–ø–∫—É, –≤—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ —Å–æ–≥–ª–∞—Å–∏–µ —Å –¥–æ–≥–æ–≤–æ—Ä–æ–º –æ—Ñ–µ—Ä—Ç—ã –∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏ –±–∞–Ω–∫–∞.</div>
                
                <button class="submit-btn" style="background:#8e44ad; margin-top:35px;" onclick="processLoanApproval()">–ü–æ–ª—É—á–∏—Ç—å –¥–µ–Ω—å–≥–∏</button>
                <button class="submit-btn btn-red" onclick="navigate('screen-home')">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <div id="screen-exchange" class="screen">
        <div style="padding:65px 25px;">
            <div class="back-arrow" onclick="navigate('screen-home')">‚Üê</div>
            <h2 style="font-size: 32px; margin-bottom: 35px; font-weight: 800;">–û–±–º–µ–Ω –≤–∞–ª—é—Ç</h2>
            
            <div style="background:white; padding:35px; border-radius:38px; box-shadow: var(--shadow); text-align:center;">
                <div style="color:grey; font-size:16px; font-weight: 500;">–ö—É—Ä—Å –ø—Ä–æ–¥–∞–∂–∏ –¥–æ–ª–ª–∞—Ä–∞</div>
                <div style="font-size:48px; font-weight:900; margin:15px 0; color: var(--sber-green);">91.20 ‚ÇΩ</div>
                
                <div style="margin-top:35px; text-align:left;">
                    <label style="font-weight: 700; color: #444; margin-left: 5px;">–°—É–º–º–∞ –∫ –ø–æ–∫—É–ø–∫–µ (USD)</label>
                    <input type="number" id="input-buy-usd" placeholder="0.00 $">
                </div>
                
                <button class="submit-btn" style="margin-top:35px; background: #3494e6;" onclick="executeCurrencyExchange()">–û–±–º–µ–Ω—è—Ç—å —Ä—É–±–ª–∏</button>
                <button class="submit-btn btn-red" onclick="navigate('screen-home')">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <div id="screen-card-detail" class="screen">
        <div style="padding: 70px 25px 40px; background:white; border-radius: 0 0 45px 45px; box-shadow: var(--shadow); position: relative;">
            <div class="back-arrow" onclick="navigate('screen-home')">‚úï</div>
            <div id="ui-detail-type" style="font-size: 15px; color: var(--text-grey); font-weight: 800; text-transform: uppercase; letter-spacing: 1.5px;">–°—á–µ—Ç MIR</div>
            <h1 id="ui-detail-balance" style="font-size:54px; font-weight:900; margin:12px 0; color: var(--text-dark);">0 ‚ÇΩ</h1>
            <div style="display:flex; align-items:center; gap:12px; color:#f39c12; font-size:20px; font-weight:800;">
                <span style="background: rgba(243, 156, 18, 0.1); padding: 5px 12px; border-radius: 12px;">‚ú® <span id="ui-detail-bonus">0</span> –±–æ–Ω—É—Å–æ–≤</span>
            </div>
        </div>
        
        <div style="padding: 35px 25px;">
            <h3 style="font-size: 24px; font-weight: 800; margin-bottom: 25px;">–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</h3>
            <div id="ui-history-list" class="hist-container">
                </div>
            
            <div id="ui-context-actions" style="margin-top: 35px;">
                </div>
            
            <button class="submit-btn btn-red" style="margin-top:20px;" onclick="navigate('screen-home')">–ó–∞–∫—Ä—ã—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
        </div>
    </div>

    <script>
        /**
         * -------------------------------------------------------------------
         * –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ò –û–ë–õ–ê–ß–ù–´–ï –î–ê–ù–ù–´–ï (FIREBASE)
         * -------------------------------------------------------------------
         */
        const firebaseConfig = { 
            apiKey: "AIzaSyA3J7KnUgxUHZigwRKmndm7xyxJeeLCrxg", 
            databaseURL: "https://webapp-b7149-default-rtdb.europe-west1.firebasedatabase.app", 
            projectId: "webapp-b7149" 
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        let usersData = [];
        let activeUserKey = null;
        let loggedInUser = null;
        let pinInputBuffer = "";
        let isProcessing = false;

        /**
         * -------------------------------------------------------------------
         * –Ø–î–†–û –ù–ê–í–ò–ì–ê–¶–ò–ò –ò –û–ë–†–ê–ë–û–¢–ö–ò –°–û–ë–´–¢–ò–ô
         * -------------------------------------------------------------------
         */
        function navigate(screenId) {
            // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö —ç–∫—Ä–∞–Ω–æ–≤
            const screens = document.querySelectorAll('.screen');
            screens.forEach(s => {
                s.classList.remove('active');
                setTimeout(() => { if(!s.classList.contains('active')) s.style.display = 'none'; }, 400);
            });

            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –Ω—É–∂–Ω—ã–π
            const target = document.getElementById(screenId);
            target.style.display = (screenId === 'screen-pin-entry') ? 'flex' : 'block';
            
            // –ú–∞–ª–µ–Ω—å–∫–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏ –∞–Ω–∏–º–∞—Ü–∏–∏
            setTimeout(() => {
                target.classList.add('active');
                window.scrollTo(0, 0);
            }, 50);
        }

        // –°–ª—É—à–∞—Ç–µ–ª—å –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
        database.ref('clients').on('value', (snapshot) => {
            const data = snapshot.val();
            usersData = data ? Object.keys(data).map(key => ({ ...data[key], fbKey: key })) : [];
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –≤—ã–±–æ—Ä–∞
            renderUserSelectionList();
            
            // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –≤–æ—à–µ–ª, –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ –¥–∞–Ω–Ω—ã–µ –≤ –ø–∞–º—è—Ç–∏ –∏ –Ω–∞ —ç–∫—Ä–∞–Ω–µ
            if (loggedInUser) {
                const refreshed = usersData.find(u => u.fbKey === loggedInUser.fbKey);
                if (refreshed) {
                    loggedInUser = refreshed;
                    refreshDashboardUI();
                }
            }
        });

        function renderUserSelectionList() {
            const listElement = document.getElementById('userListUI');
            if (!usersData.length) {
                listElement.innerHTML = '<div style="padding:40px; color:grey; font-size:18px;">–ö–ª–∏–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.<br>–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤–æ–≥–æ.</div>';
                return;
            }

            listElement.innerHTML = usersData.map(user => `
                <div class="user-row ${activeUserKey === user.fbKey ? 'selected' : ''}" onclick="setUserSelection('${user.fbKey}')">
                    <span>${user.name}</span>
                    ${activeUserKey === user.fbKey ? '<span style="font-size:22px;">‚óè</span>' : ''}
                </div>
            `).join('');

            // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –≤ –ø–µ—Ä–µ–≤–æ–¥–∞—Ö
            const transferSelect = document.getElementById('input-transfer-target');
            if (transferSelect) {
                const others = usersData.filter(u => u.fbKey !== loggedInUser?.fbKey);
                transferSelect.innerHTML = others.map(u => `<option value="${u.fbKey}">${u.name}</option>`).join('');
            }
        }

        function setUserSelection(key) {
            activeUserKey = key;
            renderUserSelectionList();
        }

        /**
         * -------------------------------------------------------------------
         * –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø –ò –ö–û–ù–¢–†–û–õ–¨ –ü–ò–ù-–ö–û–î–ê (–ò–°–ü–†–ê–í–õ–ï–ù–û)
         * -------------------------------------------------------------------
         */
        function proceedToPin() {
            if (!activeUserKey) {
                alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ.");
                return;
            }
            const targetUser = usersData.find(u => u.fbKey === activeUserKey);
            document.getElementById('pinGreeting').innerText = "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, " + targetUser.name.split(' ')[0];
            pinInputBuffer = "";
            updatePinDotsUI();
            navigate('screen-pin-entry');
        }

        function handlePinInput(key) {
            if (isProcessing) return;

            if (key === 'BACKSPACE') {
                pinInputBuffer = pinInputBuffer.slice(0, -1);
            } else if (pinInputBuffer.length < 4) {
                pinInputBuffer += key;
            }

            updatePinDotsUI();

            // –ï—Å–ª–∏ –≤–≤–µ–¥–µ–Ω–æ 4 —Ü–∏—Ñ—Ä—ã - –ø—Ä–æ–≤–µ—Ä—è–µ–º
            if (pinInputBuffer.length === 4) {
                validatePin();
            }
        }

        function updatePinDotsUI() {
            const dots = document.querySelectorAll('#pinDots .pin-dot');
            dots.forEach((dot, index) => {
                dot.classList.toggle('filled', index < pinInputBuffer.length);
            });
        }

        function validatePin() {
            isProcessing = true;
            const targetUser = usersData.find(u => u.fbKey === activeUserKey);
            
            // –î–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —É–≤–∏–¥–µ—Ç—å 4-—é —Ç–æ—á–∫—É –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ö–æ–¥–æ–º
            setTimeout(() => {
                if (targetUser.clientPin === pinInputBuffer) {
                    loggedInUser = targetUser;
                    refreshDashboardUI();
                    navigate('screen-home');
                    pinInputBuffer = ""; // –û—á–∏—Å—Ç–∫–∞ –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞
                } else {
                    alert("‚ö†Ô∏è –ù–µ–≤–µ—Ä–Ω—ã–π –ü–ò–ù-–∫–æ–¥. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É.");
                    pinInputBuffer = "";
                    updatePinDotsUI();
                }
                isProcessing = false;
            }, 300);
        }

        /**
         * -------------------------------------------------------------------
         * –õ–û–ì–ò–ö–ê –ò–ù–¢–ï–†–§–ï–ô–°–ê –î–ê–®–ë–û–†–î–ê
         * -------------------------------------------------------------------
         */
        function refreshDashboardUI() {
            if (!loggedInUser) return;

            // –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
            document.getElementById('displayName').innerText = loggedInUser.name;
            document.getElementById('userAvatar').innerText = loggedInUser.name.charAt(0).toUpperCase();
            document.getElementById('ui-main-balance').innerText = (loggedInUser.balance || 0).toLocaleString() + " ‚ÇΩ";
            document.getElementById('ui-usd-rate').innerText = (loggedInUser.usd || 0).toFixed(2) + " $";
            
            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–∞–º–∏
            const creditCard = document.getElementById('ui-credit-card-block');
            const loanWidget = document.getElementById('ui-loan-promo');
            
            if (loggedInUser.hasCredit) {
                creditCard.style.display = 'flex';
                loanWidget.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º —Ä–µ–∫–ª–∞–º—É –µ—Å–ª–∏ –∫—Ä–µ–¥–∏—Ç —É–∂–µ –µ—Å—Ç—å
                document.getElementById('ui-credit-balance').innerText = (loggedInUser.creditBalance || 0).toLocaleString() + " ‚ÇΩ";
                
                const debt = (loggedInUser.creditLimit || 0) - (loggedInUser.creditBalance || 0);
                document.getElementById('ui-credit-debt-hint').innerText = debt > 0 ? "–î–æ–ª–≥: " + debt.toLocaleString() + " ‚ÇΩ" : "–õ–∏–º–∏—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é";
            } else {
                creditCard.style.display = 'none';
                loanWidget.style.display = 'flex';
            }
        }

        /**
         * -------------------------------------------------------------------
         * –ë–ê–ù–ö–û–í–°–ö–ò–ï –û–ü–ï–†–ê–¶–ò–ò (–ë–ò–ó–ù–ï–°-–õ–û–ì–ò–ö–ê)
         * -------------------------------------------------------------------
         */
        function executeMoneyTransfer() {
            const targetFbKey = document.getElementById('input-transfer-target').value;
            const amountStr = document.getElementById('input-transfer-amount').value;
            const amount = parseInt(amountStr);
            const targetUser = usersData.find(u => u.fbKey === targetFbKey);

            if (!amount || amount <= 0) { alert("–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞."); return; }
            if (loggedInUser.balance < amount) { alert("–ù–∞ –±–∞–ª–∞–Ω—Å–µ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤."); return; }
            if (!targetUser) { alert("–û—à–∏–±–∫–∞ –≤—ã–±–æ—Ä–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª—è."); return; }

            // –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (Update)
            database.ref(`clients/${loggedInUser.fbKey}`).update({
                balance: loggedInUser.balance - amount
            });
            database.ref(`clients/${loggedInUser.fbKey}/history`).push({
                title: "–ü–µ—Ä–µ–≤–æ–¥: " + targetUser.name,
                sum: -amount,
                date: Date.now()
            });

            database.ref(`clients/${targetFbKey}`).update({
                balance: (targetUser.balance || 0) + amount
            });
            database.ref(`clients/${targetFbKey}/history`).push({
                title: "–í—Ö–æ–¥—è—â–∏–π –æ—Ç " + loggedInUser.name,
                sum: amount,
                date: Date.now()
            });

            showSuccessMessage("–ü–µ—Ä–µ–≤–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω", amount, "–ü–æ–ª—É—á–∞—Ç–µ–ª—å: " + targetUser.name);
            document.getElementById('input-transfer-amount').value = "";
        }

        function processLoanApproval() {
            const limit = parseInt(document.getElementById('input-loan-limit').value);
            if (!limit || limit < 5000) { alert("–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∫—Ä–µ–¥–∏—Ç–Ω—ã–π –ª–∏–º–∏—Ç ‚Äî 5 000 ‚ÇΩ"); return; }

            database.ref(`clients/${loggedInUser.fbKey}`).update({
                hasCredit: true,
                creditLimit: limit,
                creditBalance: limit
            });
            database.ref(`clients/${loggedInUser.fbKey}/history`).push({
                title: "–û—Ç–∫—Ä—ã—Ç–∏–µ –∫—Ä–µ–¥–∏—Ç–Ω–æ–π –ª–∏–Ω–∏–∏",
                sum: limit,
                date: Date.now()
            });

            showSuccessMessage("–ö—Ä–µ–¥–∏—Ç –æ–¥–æ–±—Ä–µ–Ω", limit, "–î–µ–Ω—å–≥–∏ –∑–∞—á–∏—Å–ª–µ–Ω—ã –Ω–∞ MIR GOLD");
            document.getElementById('input-loan-limit').value = "";
        }

        function executeCurrencyExchange() {
            const usdToBuy = parseFloat(document.getElementById('input-buy-usd').value);
            const rate = 91.20;
            const totalCost = Math.round(usdToBuy * rate);

            if (!usdToBuy || usdToBuy <= 0) { alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–ª–∞—Ä–æ–≤."); return; }
            if (loggedInUser.balance < totalCost) { alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä—É–±–ª–µ–π –¥–ª—è –æ–±–º–µ–Ω–∞."); return; }

            database.ref(`clients/${loggedInUser.fbKey}`).update({
                balance: loggedInUser.balance - totalCost,
                usd: (loggedInUser.usd || 0) + usdToBuy
            });
            database.ref(`clients/${loggedInUser.fbKey}/history`).push({
                title: "–ü–æ–∫—É–ø–∫–∞ –≤–∞–ª—é—Ç—ã (USD)",
                sum: -totalCost,
                date: Date.now()
            });

            showSuccessMessage("–í–∞–ª—é—Ç–∞ –∫—É–ø–ª–µ–Ω–∞", totalCost, "–ó–∞—á–∏—Å–ª–µ–Ω–æ: " + usdToBuy.toFixed(2) + " $");
            document.getElementById('input-buy-usd').value = "";
        }

        /**
         * -------------------------------------------------------------------
         * –ò–°–¢–û–†–ò–Ø –ò –î–ï–¢–ê–õ–ò –ö–ê–†–¢–´
         * -------------------------------------------------------------------
         */
        function openCardDetails(type) {
            const isCredit = (type === 'credit');
            const balance = isCredit ? loggedInUser.creditBalance : loggedInUser.balance;
            
            document.getElementById('ui-detail-type').innerText = isCredit ? "–ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞ GOLD" : "–î–µ–±–µ—Ç–æ–≤–∞—è –∫–∞—Ä—Ç–∞ MIR";
            document.getElementById('ui-detail-balance').innerText = (balance || 0).toLocaleString() + " ‚ÇΩ";
            document.getElementById('ui-detail-bonus').innerText = (loggedInUser.bonus || 0).toLocaleString();
            
            // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∏—Å—Ç–æ—Ä–∏–∏
            const historyList = document.getElementById('ui-history-list');
            const transactions = loggedInUser.history ? Object.values(loggedInUser.history).reverse() : [];
            
            if (!transactions.length) {
                historyList.innerHTML = '<div style="padding:30px; text-align:center; color:#bbb;">–ü–æ–∫–∞ –Ω–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π –ø–æ —Å—á–µ—Ç—É</div>';
            } else {
                historyList.innerHTML = transactions.map(t => `
                    <div class="hist-item">
                        <div class="hist-info">
                            <span style="font-weight:700; color:#333;">${t.title}</span>
                            <span style="font-size:13px; color:grey;">${new Date(t.date || Date.now()).toLocaleDateString()} ‚Ä¢ –ò—Å–ø–æ–ª–Ω–µ–Ω–æ</span>
                        </div>
                        <div class="hist-sum" style="color:${t.sum > 0 ? 'var(--sber-green)' : '#111'}">
                            ${t.sum > 0 ? '+' : ''}${t.sum.toLocaleString()} ‚ÇΩ
                        </div>
                    </div>
                `).join('');
            }

            // –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
            const actionsBox = document.getElementById('ui-context-actions');
            if (isCredit) {
                const debt = (loggedInUser.creditLimit || 0) - (loggedInUser.creditBalance || 0);
                actionsBox.innerHTML = debt > 0 ? 
                    `<button class="submit-btn" onclick="payOffDebt(${debt})">–ü–æ–≥–∞—Å–∏—Ç—å –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å (${debt} ‚ÇΩ)</button>` :
                    `<button class="submit-btn" style="background:#444" onclick="closeCreditLine()">–ó–∞–∫—Ä—ã—Ç—å –∫—Ä–µ–¥–∏—Ç–Ω—ã–π –ª–∏–º–∏—Ç</button>`;
            } else {
                actionsBox.innerHTML = `
                    <button class="submit-btn" style="background:#f2f4f7; color:#111;" onclick="alert('–õ–∏–º–∏—Ç—ã: 1 000 000 ‚ÇΩ / –¥–µ–Ω—å')">–õ–∏–º–∏—Ç—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                    <button class="submit-btn btn-red" onclick="blockCard()">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç—É</button>
                `;
            }

            navigate('screen-card-detail');
        }

        function payOffDebt(amount) {
            if (loggedInUser.balance < amount) { alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–º —Å—á–µ—Ç–µ –¥–ª—è –ø–æ–≥–∞—à–µ–Ω–∏—è."); return; }
            
            database.ref(`clients/${loggedInUser.fbKey}`).update({
                balance: loggedInUser.balance - amount,
                creditBalance: loggedInUser.creditLimit
            });
            database.ref(`clients/${loggedInUser.fbKey}/history`).push({
                title: "–ü–æ–≥–∞—à–µ–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–∞",
                sum: -amount,
                date: Date.now()
            });
            alert("–ó–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å —É—Å–ø–µ—à–Ω–æ –ø–æ–≥–∞—à–µ–Ω–∞!");
        }

        function blockCard() {
            if(confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã? –ö–∞—Ä—Ç–∞ –±—É–¥–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞–≤—Å–µ–≥–¥–∞.")) {
                alert("–ö–∞—Ä—Ç–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞. –î–ª—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–æ—Å–µ—Ç–∏—Ç–µ –æ—Ñ–∏—Å –±–∞–Ω–∫–∞.");
                navigate('screen-home');
            }
        }

        function closeCreditLine() {
            if(confirm("–£–¥–∞–ª–∏—Ç—å –∫—Ä–µ–¥–∏—Ç–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç?")) {
                database.ref(`clients/${loggedInUser.fbKey}`).update({ hasCredit: false, creditLimit: 0, creditBalance: 0 });
                navigate('screen-home');
            }
        }

        /**
         * -------------------------------------------------------------------
         * –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
         * -------------------------------------------------------------------
         */
        function registerNewUser() {
            const name = prompt("–í–≤–µ–¥–∏—Ç–µ –§–ò–û (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ò–≤–∞–Ω–æ–≤ –ò.–ò.):");
            const pin = prompt("–ü—Ä–∏–¥—É–º–∞–π—Ç–µ 4-–∑–Ω–∞—á–Ω—ã–π –ü–ò–ù-–∫–æ–¥ –¥–ª—è –≤—Ö–æ–¥–∞:");
            
            if (name && pin && pin.length === 4 && !isNaN(pin)) {
                database.ref('clients').push({
                    name: name,
                    clientPin: pin,
                    balance: 25000,
                    usd: 0,
                    bonus: 1000,
                    hasCredit: false,
                    history: { "init": { title: "–û—Ç–∫—Ä—ã—Ç–∏–µ —Å—á–µ—Ç–∞", sum: 25000, date: Date.now() } }
                });
                alert("–ê–∫–∫–∞—É–Ω—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω! –¢–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–∏—Ç–µ –µ–≥–æ –≤ —Å–ø–∏—Å–∫–µ.");
            } else {
                alert("–û—à–∏–±–∫–∞: –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ. –ü–ò–ù –¥–æ–ª–∂–µ–Ω —Å–æ—Å—Ç–æ—è—Ç—å –∏–∑ 4 —Ü–∏—Ñ—Ä.");
            }
        }

        function showSuccessMessage(title, amount, path) {
            document.getElementById('success-title').innerText = title;
            document.getElementById('success-amount').innerText = amount.toLocaleString() + " ‚ÇΩ";
            document.getElementById('success-path').innerText = path;
            document.getElementById('modal-success').style.display = 'flex';
        }

        function closeSuccessModal() {
            document.getElementById('modal-success').style.display = 'none';
            navigate('screen-home');
        }

        // –ê–≤—Ç–æ-–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', () => {
            navigate('screen-auth');
            console.log("K-Online Enterprise Edition initialized.");
        });

    </script>
</body>
</html>
