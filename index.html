<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>K-Online Bank Ultimate 2026</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/QtVHC5G0/IMG-3035.jpg">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg-color: #f2f6f9;
            --white: #ffffff;
            --black: #000000;
            --dark-grey: #1c1c1e;
            --light-grey: #8e8e93;
            --blue: #007aff;
            --red-grad: linear-gradient(170deg, #000a1a 0%, #1a0000 40%, #660000 100%);
            --gold-grad: linear-gradient(145deg, #bf953f 0%, #fcf6ba 45%, #b38728 70%, #fbf5b7 100%);
            --card-shadow: 0 15px 35px rgba(0,0,0,0.2);
            --block-shadow: 0 10px 25px rgba(0,0,0,0.05);
        }

        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
            background-color: var(--bg-color); color: var(--dark-grey);
            overflow: hidden;
        }

        #snow-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }

        /* –°–∏—Å—Ç–µ–º–∞ —ç–∫—Ä–∞–Ω–æ–≤ */
        .screen { 
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: var(--bg-color); overflow-y: auto; padding-bottom: 50px;
            opacity: 0; transform: scale(0.97); transition: 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .screen.active { display: block !important; opacity: 1; transform: scale(1); }

        /* –í—Ö–æ–¥ –∏ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è */
        .auth-screen { background: var(--white); height: 100vh; display: flex; flex-direction: column; justify-content: space-between; padding: 60px 40px 40px; text-align: center; }
        .logo-title { font-size: 60px; font-weight: 900; background: linear-gradient(45deg, #ff0000, #ffcc00); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: -4px; margin: 0; }
        .input-field { width: 100%; height: 70px; border-radius: 22px; border: 2px solid #f2f2f2; background: #fafafa; padding: 0 25px; font-size: 18px; margin-bottom: 15px; font-weight: 600; transition: 0.3s; }
        .input-field:focus { border-color: var(--blue); background: var(--white); }
        .btn-primary { width: 100%; height: 70px; border-radius: 22px; border: none; font-size: 18px; font-weight: 800; cursor: pointer; transition: 0.2s; }
        .btn-dark { background: var(--black); color: var(--white); }
        .btn-dark:active { transform: scale(0.96); }

        /* –•–µ–¥–µ—Ä –∏ –ö–∞—Ä—Ç—ã */
        .app-header { background: var(--red-grad); padding: 65px 0 40px; border-radius: 0 0 50px 50px; position: relative; box-shadow: 0 20px 40px rgba(0,0,0,0.25); }
        .user-row { display: flex; justify-content: space-between; align-items: center; padding: 0 30px; color: white; margin-bottom: 25px; }
        .user-row h2 { margin: 0; font-size: 28px; font-weight: 900; }
        
        .card-scroller { display: flex; gap: 18px; padding: 0 30px; overflow-x: auto; scrollbar-width: none; padding-bottom: 10px; }
        .card-scroller::-webkit-scrollbar { display: none; }

        .bank-card { 
            min-width: 160px; height: 250px; border-radius: 30px; padding: 25px; 
            display: flex; flex-direction: column; justify-content: space-between;
            position: relative; flex-shrink: 0; box-shadow: var(--card-shadow);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .card-black { background: linear-gradient(160deg, #1c1c1e 0%, #000000 100%); color: white; }
        .card-gold { background: var(--gold-grad); color: #4a3500; }
        .chip { width: 42px; height: 32px; background: linear-gradient(135deg, #d4af37, #fcf6ba); border-radius: 8px; }

        /* –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ç—Ä–∞—Ç */
        .analytics-box { background: var(--white); margin: 25px; padding: 25px; border-radius: 35px; box-shadow: var(--block-shadow); }
        .stats-label { font-size: 12px; font-weight: 800; color: var(--light-grey); text-transform: uppercase; letter-spacing: 1px; }
        .stats-sum { font-size: 34px; font-weight: 900; color: var(--black); margin: 10px 0; }
        .progress-bg { width: 100%; height: 10px; background: #f0f0f0; border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--black); width: 0%; border-radius: 10px; transition: 1s ease-out; }

        /* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */
        .actions-row { display: flex; justify-content: center; gap: 20px; margin-top: 15px; }
        .action-circle { 
            width: 62px; height: 62px; background: rgba(255,255,255,0.15); 
            border-radius: 20px; display: flex; align-items: center; justify-content: center; 
            font-size: 26px; backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1);
        }

        /* –ó–∞–º–æ—Ä–æ–∑–∫–∞ */
        #frozen-overlay { 
            position: fixed; inset: 0; background: var(--white); z-index: 10000; 
            display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 40px; 
        }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 9999; align-items: center; justify-content: center; backdrop-filter: blur(15px); }
        .modal-body { background: var(--white); width: 88%; max-width: 400px; border-radius: 40px; padding: 40px; text-align: center; }

        .history-item { 
            background: var(--white); margin: 0 25px 12px; padding: 20px; 
            border-radius: 25px; display: flex; justify-content: space-between; align-items: center;
            box-shadow: var(--block-shadow);
        }
    </style>
</head>
<body>

    <canvas id="snow-canvas"></canvas>

    <div id="frozen-overlay">
        <div style="font-size: 100px; margin-bottom: 20px;">‚ùÑÔ∏è</div>
        <h1 style="font-size: 34px; font-weight: 900; margin: 0;">–î–æ—Å—Ç—É–ø –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</h1>
        <p style="color: var(--light-grey); font-size: 18px; margin-top: 15px;">–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –±—ã–ª –∑–∞–º–æ—Ä–æ–∂–µ–Ω. –î–ª—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –±–∞–Ω–∫.</p>
        <button class="btn-primary btn-dark" onclick="location.reload()" style="margin-top: 40px; width: 220px;">–û–±–Ω–æ–≤–∏—Ç—å</button>
    </div>

    <div id="screen-auth" class="screen active">
        <div class="auth-screen">
            <div>
                <h1 class="logo-title">K-Online</h1>
                <p style="color: var(--light-grey); font-weight: 700; margin-top: 10px;">Security Level: High ‚Ä¢ 2026</p>
            </div>
            <div>
                <input type="number" id="auth-tg-id" class="input-field" placeholder="–í–≤–µ–¥–∏—Ç–µ Telegram ID">
                <button class="btn-primary btn-dark" onclick="bankApp.startAuth()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
                <button style="border:none; background:none; color:var(--blue); font-weight:700; margin-top:25px;" onclick="bankApp.toggleModal('modal-reg', true)">–î–æ–±–∞–≤–∏—Ç—å –º–æ–π ID</button>
            </div>
            <div style="font-size: 11px; color: #ccc;">Secure 256-bit AES Encryption</div>
        </div>
    </div>

    <div id="screen-otp" class="screen">
        <div class="auth-screen">
            <div>
                <h2 style="font-size: 36px; font-weight: 900;">–í–∞—à –∫–æ–¥</h2>
                <p style="color: var(--light-grey);">–ú—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –ø—Ä–æ–≤–µ—Ä–æ—á–Ω—ã–π –∫–æ–¥ –≤ –í–∞—à Telegram</p>
            </div>
            <input type="number" id="auth-otp-input" class="input-field" placeholder="000 000" style="text-align:center; font-size:36px; letter-spacing:8px;">
            <button class="btn-primary btn-dark" onclick="bankApp.verifyOTP()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
        </div>
    </div>

    <div id="screen-home" class="screen">
        <div class="app-header">
            <div class="user-row">
                <div>
                    <div style="font-size: 14px; opacity: 0.7;">–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ,</div>
                    <h2 id="display-user-name">...</h2>
                </div>
                <div style="width:55px; height:55px; background:rgba(255,255,255,0.2); border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:900; font-size:22px;" id="display-user-ava">?</div>
            </div>

            <div class="card-scroller" id="card-scroller-inner">
                </div>

            <div class="actions-row">
                <div class="action-circle" onclick="bankApp.nav('screen-transfer')">üéÅ</div>
                <div class="action-circle" onclick="bankApp.nav('screen-history')">üìú</div>
                <div id="admin-trigger" class="action-circle" style="display:none; background:#f1c40f; color:black;" onclick="bankApp.nav('screen-admin')">üõ°Ô∏è</div>
                <div class="action-circle" onclick="location.reload()">üö™</div>
            </div>
        </div>

        <div class="analytics-box">
            <div class="stats-label">–¢—Ä–∞—Ç—ã –≤ —è–Ω–≤–∞—Ä–µ</div>
            <div class="stats-sum" id="stats-spent-val">0.00 ‚ÇΩ</div>
            <div class="progress-bg"><div class="progress-fill" id="stats-progress"></div></div>
        </div>

        <div style="padding: 0 25px;">
            <button class="btn-primary" style="background:var(--gold-grad); color:#4a3500; box-shadow: 0 10px 20px rgba(191,149,63,0.3);" onclick="bankApp.takeCredit()">–í–∑—è—Ç—å –∫—Ä–µ–¥–∏—Ç</button>
        </div>
    </div>

    <div id="screen-transfer" class="screen">
        <div style="padding: 60px 30px;">
            <div style="font-size: 34px; margin-bottom: 20px;" onclick="bankApp.nav('screen-home')">‚Üê</div>
            <h2 style="font-size: 36px; font-weight: 900;">–ü–µ—Ä–µ–≤–æ–¥</h2>
            <div style="background:var(--white); padding:30px; border-radius:35px; box-shadow: var(--block-shadow); margin-top:20px;">
                <label style="font-size:12px; font-weight:800; color:var(--light-grey);">–ü–û–õ–£–ß–ê–¢–ï–õ–¨</label>
                <select id="transfer-target" class="input-field" style="margin-top:10px;"></select>
                <label style="font-size:12px; font-weight:800; color:var(--light-grey);">–°–£–ú–ú–ê (‚ÇΩ)</label>
                <input type="number" id="transfer-amount" class="input-field" placeholder="0.00">
                <button class="btn-primary btn-dark" onclick="bankApp.processTransfer()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–¥–∞—Ä–æ–∫</button>
            </div>
        </div>
    </div>

    <div id="screen-history" class="screen">
        <div style="padding: 60px 25px;">
            <div style="font-size: 34px; margin-bottom: 20px;" onclick="bankApp.nav('screen-home')">‚Üê</div>
            <h2 style="font-size: 36px; font-weight: 900; margin-left: 10px;">–ò—Å—Ç–æ—Ä–∏—è</h2>
            <div id="history-list-full" style="margin-top:20px;"></div>
        </div>
    </div>

    <div id="screen-admin" class="screen">
        <div style="padding: 60px 25px;">
            <div style="font-size: 34px; margin-bottom: 20px;" onclick="bankApp.nav('screen-home')">‚Üê</div>
            <h2 style="font-size: 30px; font-weight: 900;">–ó–∞—è–≤–∫–∏ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É</h2>
            <div id="admin-pending-list" style="margin-top:20px;"></div>
        </div>
    </div>

    <div id="modal-reg" class="modal-overlay">
        <div class="modal-body">
            <h2 style="margin:0;">–ù–æ–≤—ã–π ID</h2>
            <p style="color:var(--light-grey); margin-bottom:25px;">–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏</p>
            <input type="text" id="reg-name" class="input-field" placeholder="–í–∞—à–µ –ò–º—è">
            <input type="number" id="reg-tg" class="input-field" placeholder="–í–∞—à Telegram ID">
            <button class="btn-primary btn-dark" onclick="bankApp.register()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
            <p onclick="bankApp.toggleModal('modal-reg', false)" style="margin-top:20px; color:var(--light-grey);">–û—Ç–º–µ–Ω–∞</p>
        </div>
    </div>

    <script>
        // --- –ë–õ–û–ö –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò ---
        const BOT_TOKEN = "–í–ê–®_–¢–û–ö–ï–ù_–ë–û–¢–ê";
        const ADMIN_ID = "–í–ê–®_–¢–ï–õ–ï–ì–†–ê–ú_ID";

        const firebaseConfig = { 
            apiKey: "AIzaSyA3J7KnUgxUHZigwRKmndm7xyxJeeLCrxg", 
            databaseURL: "https://webapp-b7149-default-rtdb.europe-west1.firebasedatabase.app", 
            projectId: "webapp-b7149" 
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- –ì–õ–ê–í–ù–´–ô –ú–û–î–£–õ–¨ –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ---
        const bankApp = {
            state: { allUsers: [], user: null, otp: null, candidate: null },

            nav: (id) => {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                const el = document.getElementById(id);
                el.style.display = 'block';
                setTimeout(() => el.classList.add('active'), 50);
            },

            toggleModal: (id, show) => document.getElementById(id).style.display = show ? 'flex' : 'none',

            startAuth: async () => {
                const tid = document.getElementById('auth-tg-id').value;
                const user = bankApp.state.allUsers.find(u => u.tg_id == tid);

                if (!user) return alert("ID –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å.");
                if (user.isFrozen) return document.getElementById('frozen-overlay').style.display = 'flex';

                bankApp.state.otp = Math.floor(100000 + Math.random() * 900000);
                bankApp.state.candidate = user;

                try {
                    await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${tid}&text=üõ°Ô∏è –ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è K-Online: ${bankApp.state.otp}`);
                    bankApp.nav('screen-otp');
                } catch(e) { alert("–û—à–∏–±–∫–∞ –±–æ—Ç–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–∫–µ–Ω."); }
            },

            verifyOTP: () => {
                const val = document.getElementById('auth-otp-input').value;
                if (val == bankApp.state.otp) {
                    bankApp.state.user = bankApp.state.candidate;
                    bankApp.renderUI();
                    bankApp.nav('screen-home');
                } else { alert("–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥!"); }
            },

            register: () => {
                const name = document.getElementById('reg-name').value;
                const tg = document.getElementById('reg-tg').value;
                if (!name || !tg) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!");

                db.ref('clients').push({
                    name: name,
                    tg_id: tg,
                    balance: 500,
                    isFrozen: false,
                    hasCredit: false,
                    history: []
                });
                alert("–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω! –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ.");
                bankApp.toggleModal('modal-reg', false);
            },

            processTransfer: async () => {
                const targetKey = document.getElementById('transfer-target').value;
                const amount = parseInt(document.getElementById('transfer-amount').value);
                const sender = bankApp.state.user;
                const receiver = bankApp.state.allUsers.find(u => u.fbKey === targetKey);

                if (!amount || amount <= 0 || sender.balance < amount) return alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –∏–ª–∏ –Ω–µ–≤–µ—Ä–Ω–∞—è —Å—É–º–º–∞");

                if (amount >= 1000) {
                    // –ú–û–î–ï–†–ê–¶–ò–Ø
                    await db.ref(`clients/${sender.fbKey}/balance`).set(sender.balance - amount);
                    db.ref('moderation').push({
                        from: sender.fbKey, fromN: sender.name, fromT: sender.tg_id,
                        to: targetKey, toN: receiver.name, toT: receiver.tg_id,
                        sum: amount, date: Date.now()
                    });
                    fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${ADMIN_ID}&text=üí≥ –ó–∞—è–≤–∫–∞ –Ω–∞ ${amount}‚ÇΩ –æ—Ç ${sender.name}`);
                    alert("–ü–µ—Ä–µ–≤–æ–¥ —Å–≤—ã—à–µ 1000‚ÇΩ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É –±–∞–Ω–∫–æ–º.");
                } else {
                    // –ú–û–ú–ï–ù–¢–ê–õ–¨–ù–û
                    await db.ref(`clients/${sender.fbKey}/balance`).set(sender.balance - amount);
                    await db.ref(`clients/${targetKey}/balance`).transaction(c => (c || 0) + amount);
                    
                    db.ref(`clients/${sender.fbKey}/history`).push({ title: `–ü–µ—Ä–µ–≤–æ–¥: ${receiver.name}`, sum: -amount, date: Date.now() });
                    db.ref(`clients/${targetKey}/history`).push({ title: `–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—Ç: ${sender.name}`, sum: amount, date: Date.now() });
                    alert("–£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!");
                }
                bankApp.nav('screen-home');
            },

            takeCredit: () => {
                if (bankApp.state.user.hasCredit) return alert("–£ –í–∞—Å —É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –∫—Ä–µ–¥–∏—Ç");
                db.ref(`clients/${bankApp.state.user.fbKey}`).update({ hasCredit: true });
                alert("–ö—Ä–µ–¥–∏—Ç Gold –æ–¥–æ–±—Ä–µ–Ω! –ù–æ–≤–∞—è –∫–∞—Ä—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –∫–æ—à–µ–ª–µ–∫.");
            },

            adminAction: async (key, data, isApprove) => {
                if (isApprove) {
                    await db.ref(`clients/${data.to}/balance`).transaction(c => (c || 0) + data.sum);
                    db.ref(`clients/${data.from}/history`).push({ title: `–û–¥–æ–±—Ä–µ–Ω–æ: ${data.toN}`, sum: -data.sum, date: Date.now() });
                    db.ref(`clients/${data.to}/history`).push({ title: `–ü—Ä–∏—Ö–æ–¥ –æ—Ç: ${data.fromN}`, sum: data.sum, date: Date.now() });
                    fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${data.fromT}&text=‚úÖ –ü–µ—Ä–µ–≤–æ–¥ –Ω–∞ ${data.sum}‚ÇΩ –æ–¥–æ–±—Ä–µ–Ω!`);
                } else {
                    await db.ref(`clients/${data.from}/balance`).transaction(c => (c || 0) + data.sum);
                    fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${data.fromT}&text=‚ùå –ü–µ—Ä–µ–≤–æ–¥ –Ω–∞ ${data.sum}‚ÇΩ –æ—Ç–∫–ª–æ–Ω–µ–Ω.`);
                }
                db.ref(`moderation/${key}`).remove();
            },

            renderUI: () => {
                const u = bankApp.state.user;
                if (!u) return;

                if (u.isFrozen) {
                    document.getElementById('frozen-overlay').style.display = 'flex';
                    return;
                }

                document.getElementById('display-user-name').innerText = u.name;
                document.getElementById('display-user-ava').innerText = u.name[0];
                document.getElementById('admin-trigger').style.display = (u.tg_id == ADMIN_ID) ? 'flex' : 'none';

                // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã—Ö –ö–∞—Ä—Ç
                let cardHTML = `
                    <div class="bank-card card-black">
                        <div class="chip"></div>
                        <div>
                            <div style="font-size: 24px; font-weight: 900;">${(u.balance || 0).toLocaleString()} ‚ÇΩ</div>
                            <div style="font-size: 11px; opacity: 0.5; margin-top: 5px;">MIR BLACK ‚Ä¢ 2026</div>
                        </div>
                    </div>
                `;
                if (u.hasCredit) {
                    cardHTML += `
                        <div class="bank-card card-gold">
                            <div class="chip" style="background:silver;"></div>
                            <div>
                                <div style="font-size: 24px; font-weight: 900;">50,000 ‚ÇΩ</div>
                                <div style="font-size: 11px; opacity: 0.7; margin-top: 5px;">GOLD CREDIT CARD</div>
                            </div>
                        </div>
                    `;
                }
                document.getElementById('card-scroller-inner').innerHTML = cardHTML;

                // –†–∞—Å—á–µ—Ç –¢—Ä–∞—Ç –∑–∞ –Ø–Ω–≤–∞—Ä—å
                const hist = u.history ? Object.values(u.history) : [];
                const spent = hist.filter(h => h.sum < 0).reduce((acc, curr) => acc + Math.abs(curr.sum), 0);
                document.getElementById('stats-spent-val').innerText = spent.toLocaleString() + " ‚ÇΩ";
                
                const progress = Math.min((spent / 5000) * 100, 100); 
                document.getElementById('stats-progress').style.width = progress + "%";

                // –ò—Å—Ç–æ—Ä–∏—è
                document.getElementById('history-list-full').innerHTML = hist.reverse().map(h => `
                    <div class="history-item">
                        <div><b>${h.title}</b><br><small style="color:var(--light-grey);">${new Date(h.date).toLocaleDateString()}</small></div>
                        <div style="font-weight:900; color:${h.sum > 0 ? '#2ecc71' : 'var(--black)'}">${h.sum > 0 ? '+' : ''}${h.sum}</div>
                    </div>
                `).join('') || "<p style='text-align:center; color:#ccc;'>–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</p>";

                // –ü–æ–ª—É—á–∞—Ç–µ–ª–∏
                document.getElementById('transfer-target').innerHTML = bankApp.state.allUsers
                    .filter(x => x.fbKey !== u.fbKey)
                    .map(x => `<option value="${x.fbKey}">${x.name}</option>`).join('');
            },

            renderAdmin: (mod) => {
                const box = document.getElementById('admin-pending-list');
                if (!mod) return box.innerHTML = "<p style='text-align:center; color:#ccc;'>–ó–∞—è–≤–æ–∫ –Ω–µ—Ç</p>";
                box.innerHTML = Object.keys(mod).map(k => `
                    <div class="history-item" style="flex-direction:column; align-items:flex-start;">
                        <div style="font-size:20px; font-weight:900;">${mod[k].sum} ‚ÇΩ</div>
                        <div style="margin:8px 0; font-size:14px;">${mod[k].fromN} ‚Æï ${mod[k].toN}</div>
                        <div style="display:flex; gap:10px; width:100%; margin-top:10px;">
                            <button onclick='bankApp.adminAction("${k}", ${JSON.stringify(mod[k])}, true)' style="flex:1; background:#2ecc71; border:none; padding:12px; border-radius:15px; color:white; font-weight:700;">–û–¥–æ–±—Ä–∏—Ç—å</button>
                            <button onclick='bankApp.adminAction("${k}", ${JSON.stringify(mod[k])}, false)' style="flex:1; background:#ff3b30; border:none; padding:12px; border-radius:15px; color:white; font-weight:700;">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                        </div>
                    </div>
                `).join('');
            }
        };

        // --- FIREBASE LISTENERS ---
        db.ref('clients').on('value', snap => {
            const data = snap.val();
            bankApp.state.allUsers = data ? Object.keys(data).map(k => ({...data[k], fbKey: k})) : [];
            if (bankApp.state.user) {
                bankApp.state.user = bankApp.state.allUsers.find(u => u.fbKey === bankApp.state.user.fbKey);
                bankApp.renderUI();
            }
        });

        db.ref('moderation').on('value', snap => bankApp.renderAdmin(snap.val()));

        // --- SNOW ANIMATION ---
        const canvas = document.getElementById('snow-canvas');
        const ctx = canvas.getContext('2d');
        let flakes = [];
        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.onresize = resize; resize();
        for(let i=0; i<85; i++) flakes.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, r: Math.random()*3+1, v: Math.random()*1+0.5 });
        function draw() {
            ctx.clearRect(0,0,canvas.width,canvas.height); ctx.fillStyle = "white"; ctx.beginPath();
            flakes.forEach(f => { ctx.moveTo(f.x, f.y); ctx.arc(f.x, f.y, f.r, 0, Math.PI*2); });
            ctx.fill(); flakes.forEach(f => { f.y += f.v; if(f.y > canvas.height) f.y = -5; });
            requestAnimationFrame(draw);
        }
        draw();
    </script>
</body>
</html>
