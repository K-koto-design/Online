<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>K-Online Pro | –í–µ—Ä—Å–∏—è 2.5.4</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <style>
        /* --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ò –°–¢–ò–õ–ò --- */
        :root {
            --sber-green: #21a038;
            --sber-gradient: linear-gradient(135deg, #21a038 0%, #044a16 100%);
            --dark-bg: #020b0d;
            --light-bg: #f2f5f7;
            --white: #ffffff;
            --text-main: #1c1c1e;
            --text-secondary: #8e8e93;
            --danger: #ff3b30;
            --card-shadow: 0 12px 24px rgba(0,0,0,0.1);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            -webkit-font-smoothing: antialiased;
        }

        body, html {
            margin: 0; padding: 0;
            width: 100%; height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
            background-color: var(--light-bg);
            color: var(--text-main);
            overflow: hidden;
        }

        /* --- –°–ò–°–¢–ï–ú–ê –≠–ö–†–ê–ù–û–í --- */
        .screen {
            display: none;
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: var(--light-bg);
            overflow-y: auto;
            z-index: 10;
        }
        .screen.active { display: block; animation: screenFadeIn 0.4s ease; }

        @keyframes screenFadeIn {
            from { opacity: 0; transform: scale(1.05); }
            to { opacity: 1; transform: scale(1); }
        }

        /* --- –î–ò–ó–ê–ô–ù –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò --- */
        #screen-auth {
            background: var(--sber-gradient);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            padding: 20px;
        }
        .auth-container {
            background: rgba(255, 255, 255, 0.98);
            width: 100%; max-width: 360px;
            border-radius: 32px;
            padding: 40px 25px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
            text-align: center;
        }
        .auth-logo {
            font-size: 38px; font-weight: 900;
            color: var(--sber-green);
            margin-bottom: 5px; letter-spacing: -1.5px;
        }
        .auth-subtitle { color: var(--text-secondary); font-size: 14px; margin-bottom: 30px; }
        
        .user-list-box {
            max-height: 220px; overflow-y: auto;
            margin-bottom: 25px; border-radius: 16px;
            background: #f8f9fa; border: 1px solid #eee;
        }
        .user-entry {
            padding: 18px; border-bottom: 1px solid #eee;
            display: flex; justify-content: space-between; align-items: center;
            font-weight: 600; transition: var(--transition);
        }
        .user-entry:last-child { border-bottom: none; }
        .user-entry.active { background: #e8f5e9; color: var(--sber-green); }

        .btn-primary {
            width: 100%; height: 58px;
            background: var(--sber-green); color: white;
            border: none; border-radius: 18px;
            font-size: 18px; font-weight: 700;
            box-shadow: 0 8px 16px rgba(33, 160, 56, 0.3);
            transition: var(--transition);
        }
        .btn-primary:active { transform: scale(0.96); opacity: 0.9; }

        /* --- –ì–õ–ê–í–ù–´–ô –ò–ù–¢–ï–†–§–ï–ô–° --- */
        .app-header {
            background: var(--dark-bg);
            padding: 60px 20px 30px;
            border-radius: 0 0 40px 40px;
            color: white;
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .user-badge { display: flex; align-items: center; gap: 12px; }
        .avatar {
            width: 48px; height: 48px; border-radius: 50%;
            background: #2c2c2e; border: 2px solid #3a3a3c;
            display: flex; align-items: center; justify-content: center;
            font-weight: 800; font-size: 18px; color: var(--sber-green);
        }

        /* --- –°–õ–ê–ô–î–ï–† –ö–ê–†–¢ --- */
        .card-scroller {
            display: flex; gap: 15px; overflow-x: auto;
            padding: 10px 0 20px; scroll-snap-type: x mandatory;
            -ms-overflow-style: none; scrollbar-width: none;
        }
        .card-scroller::-webkit-scrollbar { display: none; }
        
        .card-visual {
            min-width: 290px; height: 175px;
            border-radius: 24px; padding: 25px;
            position: relative; scroll-snap-align: center;
            display: flex; flex-direction: column; justify-content: space-between;
            color: white; overflow: hidden;
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
        }
        .card-debit { background: linear-gradient(135deg, #1d976c, #93f9b9); color: #000; }
        .card-credit { background: linear-gradient(135deg, #232526, #414345); }
        .card-label { font-size: 12px; font-weight: 700; text-transform: uppercase; opacity: 0.8; }
        .card-balance { font-size: 32px; font-weight: 800; }
        .card-meta { font-family: "Courier New", monospace; font-size: 16px; letter-spacing: 2px; }

        /* --- –°–ï–¢–ö–ê –î–ï–ô–°–¢–í–ò–ô --- */
        .actions-grid {
            display: grid; grid-template-columns: repeat(4, 1fr);
            gap: 15px; padding: 25px 20px;
        }
        .action-item { text-align: center; cursor: pointer; }
        .action-icon-wrapper {
            width: 62px; height: 62px; background: white;
            border-radius: 20px; display: flex; align-items: center;
            justify-content: center; font-size: 26px;
            margin: 0 auto 10px; box-shadow: var(--card-shadow);
            transition: var(--transition);
        }
        .action-item:active .action-icon-wrapper { transform: translateY(-5px); background: #f0f0f0; }
        .action-label { font-size: 12px; font-weight: 600; color: #3a3a3c; }

        /* --- –í–ò–î–ñ–ï–¢–´ --- */
        .premium-widget {
            background: white; margin: 0 20px 15px;
            border-radius: 24px; padding: 20px;
            display: flex; align-items: center; gap: 15px;
            box-shadow: var(--card-shadow);
        }
        .widget-icon-box {
            width: 50px; height: 50px; border-radius: 16px;
            display: flex; align-items: center; justify-content: center;
            font-size: 22px;
        }

        /* --- –ò–°–¢–û–†–ò–Ø --- */
        .history-section {
            background: white; border-radius: 40px 40px 0 0;
            padding: 30px 20px; margin-top: 20px; min-height: 600px;
        }
        .history-header {
            display: flex; justify-content: space-between;
            align-items: center; margin-bottom: 25px;
        }
        .history-title { font-size: 20px; font-weight: 800; }
        
        .transaction-row {
            display: flex; align-items: center; padding: 18px 0;
            border-bottom: 1px solid #f2f2f7;
        }
        .tr-icon {
            width: 46px; height: 46px; border-radius: 50%;
            background: #f2f2f7; display: flex; align-items: center;
            justify-content: center; font-size: 20px; margin-right: 15px;
        }
        .tr-info { flex: 1; }
        .tr-name { font-weight: 700; font-size: 16px; margin-bottom: 3px; }
        .tr-date { font-size: 12px; color: var(--text-secondary); }
        .tr-amount { font-weight: 800; font-size: 17px; text-align: right; }
        .tr-plus { color: var(--sber-green); }

        /* --- –°–¢–ò–õ–ò –§–û–†–ú --- */
        .payment-form { padding: 20px; }
        .form-card {
            background: white; border-radius: 24px;
            padding: 20px; margin-bottom: 20px;
            box-shadow: var(--card-shadow);
        }
        .form-label { font-size: 12px; font-weight: 800; color: var(--text-secondary); margin-bottom: 10px; display: block; }
        .form-input {
            width: 100%; border: none; font-size: 24px; font-weight: 700;
            padding: 10px 0; border-bottom: 2px solid #f2f2f7;
            margin-bottom: 15px; outline: none; transition: 0.3s;
        }
        .form-input:focus { border-bottom-color: var(--sber-green); }
        
        select.form-input { font-size: 18px; cursor: pointer; }

        /* --- –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6); z-index: 100;
            display: none; backdrop-filter: blur(5px);
        }
        .modal-content {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: white; border-radius: 30px 30px 0 0;
            padding: 40px 20px; transform: translateY(100%);
            transition: transform 0.4s ease;
        }
        .modal-overlay.active { display: block; }
        .modal-overlay.active .modal-content { transform: translateY(0); }

    </style>
</head>
<body>

    <div id="screen-auth" class="screen active">
        <div class="auth-container">
            <div class="auth-logo">K-Online</div>
            <div class="auth-subtitle">–ü—Ä–µ–º–∏–∞–ª—å–Ω—ã–π –º–æ–±–∏–ª—å–Ω—ã–π –±–∞–Ω–∫–∏–Ω–≥</div>
            <div id="userListUI" class="user-list-box">
                </div>
            <button class="btn-primary" onclick="attemptLogin()">–í–æ–π—Ç–∏ –≤ –∫–∞–±–∏–Ω–µ—Ç</button>
            <p onclick="triggerRegister()" style="margin-top: 20px; font-size: 14px; font-weight: 700; color: #555;">
                –°—Ç–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–º –±–∞–Ω–∫–∞ <span style="color: var(--sber-green);">+</span>
            </p>
        </div>
    </div>

    <div id="screen-home" class="screen">
        <div class="app-header">
            <div class="header-top">
                <div class="user-badge">
                    <div class="avatar" id="uiAvatar">?</div>
                    <div>
                        <div style="font-size: 12px; opacity: 0.7;">–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ,</div>
                        <div id="uiName" style="font-size: 18px; font-weight: 800;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    </div>
                </div>
                <div onclick="nav('screen-settings')" style="font-size: 24px;">‚öôÔ∏è</div>
            </div>
            
            <div class="card-scroller">
                <div class="card-visual card-debit" onclick="openDetails('debit')">
                    <div class="card-label">–î–µ–±–µ—Ç–æ–≤–∞—è –∫–∞—Ä—Ç–∞ ‚Ä¢ –ú–ò–†</div>
                    <div class="card-balance" id="balDebit">0.00 ‚ÇΩ</div>
                    <div class="card-meta">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ 4002</div>
                </div>
                <div class="card-visual card-credit" onclick="openDetails('credit')">
                    <div class="card-label">–ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞ ‚Ä¢ Platinum</div>
                    <div class="card-balance" id="balCredit">0.00 ‚ÇΩ</div>
                    <div class="card-meta">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ 8851</div>
                </div>
            </div>
        </div>

        <div class="actions-grid">
            <div class="action-item" onclick="nav('screen-transfer')">
                <div class="action-icon-wrapper">üí∏</div>
                <div class="action-label">–ü–µ—Ä–µ–≤–æ–¥</div>
            </div>
            <div class="action-item" onclick="nav('screen-payments')">
                <div class="action-icon-wrapper">üì±</div>
                <div class="action-label">–ü–ª–∞—Ç–µ–∂–∏</div>
            </div>
            <div class="action-item" onclick="nav('screen-exchange')">
                <div class="action-icon-wrapper">üí±</div>
                <div class="action-label">–í–∞–ª—é—Ç–∞</div>
            </div>
            <div class="action-item" onclick="alert('–ò—Å—Ç–æ—Ä–∏—è –∑–∞ –≤—Å–µ –≤—Ä–µ–º—è –≤—ã–≥—Ä—É–∂–µ–Ω–∞ –Ω–∞ –ø–æ—á—Ç—É')">
                <div class="action-icon-wrapper">üìä</div>
                <div class="action-label">–ê–Ω–∞–ª–∏–∑</div>
            </div>
        </div>

        <div class="premium-widget" onclick="alert('–í–∞—à –∫—ç—à–±—ç–∫ –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ —Å–æ—Å—Ç–∞–≤–∏–ª 450 –±–æ–Ω—É—Å–æ–≤')">
            <div class="widget-icon-box" style="background: #e8f5e9; color: var(--sber-green);">‚≠ê</div>
            <div style="flex: 1;">
                <div style="font-weight: 800; font-size: 15px;">–ë–æ–Ω—É—Å—ã –ø—Ä–æ–≥—Ä–∞–º–º—ã</div>
                <div id="uiBonuses" style="font-size: 13px; color: #666;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
            <div style="font-weight: 900; color: var(--sber-green);">‚ûú</div>
        </div>

        <div class="history-section">
            <div class="history-header">
                <div class="history-title">–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</div>
                <div style="color: var(--sber-green); font-weight: 700; font-size: 14px;">–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</div>
            </div>
            <div id="historyListUI">
                </div>
        </div>
    </div>

    <div id="screen-transfer" class="screen">
        <div style="padding: 50px 20px 20px; display: flex; align-items: center; justify-content: space-between;">
            <div onclick="nav('screen-home')" style="font-size: 26px;">‚úï</div>
            <div style="font-weight: 800; font-size: 20px;">–ü–µ—Ä–µ–≤–æ–¥ –¥–µ–Ω–µ–≥</div>
            <div style="width: 26px;"></div>
        </div>
        <div class="payment-form">
            <div class="form-card">
                <label class="form-label">–ü–û–õ–£–ß–ê–¢–ï–õ–¨</label>
                <select id="transferTarget" class="form-input">
                    </select>
                <label class="form-label">–°–£–ú–ú–ê (‚ÇΩ)</label>
                <input type="number" id="transferSum" class="form-input" placeholder="0.00">
                <label class="form-label">–°–û–û–ë–©–ï–ù–ò–ï</label>
                <input type="text" id="transferNote" class="form-input" style="font-size: 16px;" placeholder="–ù–∞ –ø–æ–¥–∞—Ä–æ–∫">
            </div>
            <button class="btn-primary" onclick="confirmTransfer()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–µ—Ä–µ–≤–æ–¥</button>
        </div>
    </div>

    <div id="screen-payments" class="screen">
        <div style="padding: 50px 20px 20px; display: flex; align-items: center; gap: 15px;">
            <div onclick="nav('screen-home')" style="font-size: 26px;">‚Üê</div>
            <h2 style="margin: 0;">–û–ø–ª–∞—Ç–∞ —É—Å–ª—É–≥</h2>
        </div>
        <div style="padding: 0 20px;">
            <div class="premium-widget" onclick="payService('–ú–æ–±–∏–ª—å–Ω–∞—è —Å–≤—è–∑—å', 'üì±')">
                <div class="widget-icon-box" style="background: #f1f8e9;">üì±</div>
                <div style="font-weight: 800;">–ú–æ–±–∏–ª—å–Ω–∞—è —Å–≤—è–∑—å</div>
            </div>
            <div class="premium-widget" onclick="payService('–ò–Ω—Ç–µ—Ä–Ω–µ—Ç', 'üåê')">
                <div class="widget-icon-box" style="background: #e1f5fe;">üåê</div>
                <div style="font-weight: 800;">–ò–Ω—Ç–µ—Ä–Ω–µ—Ç –∏ –¢–í</div>
            </div>
            <div class="premium-widget" onclick="payService('–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç', 'üöå')">
                <div class="widget-icon-box" style="background: #fff3e0;">üöå</div>
                <div style="font-weight: 800;">–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç (–¢—Ä–æ–π–∫–∞)</div>
            </div>
            <div class="premium-widget" onclick="payService('–ñ–ö–•', 'üè†')">
                <div class="widget-icon-box" style="background: #efebe9;">üè†</div>
                <div style="font-weight: 800;">–ö–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏</div>
            </div>
        </div>
    </div>

    <div id="screen-details" class="screen">
        <div id="detailsHeader" style="padding: 60px 20px 40px; color: white; transition: 0.3s;">
            <div onclick="nav('screen-home')" style="font-weight: 700;">‚Üê –ó–∞–∫—Ä—ã—Ç—å</div>
            <div id="detName" style="margin-top: 30px; opacity: 0.8; font-weight: 600;">–î–µ–±–µ—Ç–æ–≤–∞—è –∫–∞—Ä—Ç–∞</div>
            <h1 id="detBalance" style="font-size: 44px; margin: 10px 0;">0.00 ‚ÇΩ</h1>
            <div style="font-family: monospace; letter-spacing: 2px;">4002 ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ 1192</div>
        </div>
        <div class="actions-grid">
            <div class="action-item" onclick="topUpFlow()">
                <div class="action-icon-wrapper">üì•</div>
                <div class="action-label">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</div>
            </div>
            <div class="action-item" onclick="alert('–õ–∏–º–∏—Ç: 150 000 ‚ÇΩ / –¥–µ–Ω—å')">
                <div class="action-icon-wrapper">üõ°Ô∏è</div>
                <div class="action-label">–õ–∏–º–∏—Ç—ã</div>
            </div>
            <div class="action-item" onclick="freezeCard()">
                <div class="action-icon-wrapper">‚ùÑÔ∏è</div>
                <div class="action-label">–ó–∞–º–æ—Ä–æ–∑–∫–∞</div>
            </div>
            <div class="action-item" onclick="alert('PIN-–∫–æ–¥: ****')">
                <div class="action-icon-wrapper">üîë</div>
                <div class="action-label">PIN-–∫–æ–¥</div>
            </div>
        </div>
        <div class="history-section" id="cardSpecificHistory">
            </div>
    </div>

    <script>
        /* –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø */
        const firebaseConfig = { 
            apiKey: "AIzaSyA3J7KnUgxUHZigwRKmndm7xyxJeeLCrxg", 
            databaseURL: "https://webapp-b7149-default-rtdb.europe-west1.firebasedatabase.app", 
            projectId: "webapp-b7149"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let currentUser = null;
        let allUsers = [];
        let selectedLoginKey = null;
        let activeCardType = 'debit';

        // –°—Ç–∞—Ä—Ç —Å–∏—Å—Ç–µ–º—ã
        function bootstrap() {
            db.ref('clients').on('value', snapshot => {
                const data = snapshot.val();
                allUsers = data ? Object.keys(data).map(k => ({...data[k], fbKey: k})) : [];
                renderAuthList();
                
                if(currentUser) {
                    const updated = allUsers.find(u => u.fbKey === currentUser.fbKey);
                    if(updated) {
                        currentUser = updated;
                        syncInterface();
                    }
                }
            });
        }

        /* –õ–û–ì–ò–ö–ê –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò */
        function renderAuthList() {
            const container = document.getElementById('userListUI');
            if(allUsers.length === 0) {
                container.innerHTML = `<div style="padding:20px; color:#999;">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤</div>`;
                return;
            }
            container.innerHTML = allUsers.map(u => `
                <div class="user-entry ${selectedLoginKey === u.fbKey ? 'active' : ''}" 
                     onclick="setLoginKey('${u.fbKey}')">
                    <span>${u.name}</span>
                    <span>${selectedLoginKey === u.fbKey ? '‚óè' : ''}</span>
                </div>
            `).join('');

            // –°–µ–ª–µ–∫—Ç –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π
            const select = document.getElementById('transferTarget');
            select.innerHTML = allUsers.filter(u => currentUser && u.fbKey !== currentUser.fbKey)
                                       .map(u => `<option value="${u.fbKey}">${u.name}</option>`).join('');
        }

        function setLoginKey(key) {
            selectedLoginKey = key;
            renderAuthList();
        }

        function attemptLogin() {
            if(!selectedLoginKey) return alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å");
            const pin = prompt("–í–≤–µ–¥–∏—Ç–µ —á–µ—Ç—ã—Ä–µ—Ö–∑–Ω–∞—á–Ω—ã–π –ü–ò–ù-–∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞:");
            const user = allUsers.find(u => u.fbKey === selectedLoginKey);
            
            if(user && user.clientPin === pin) {
                currentUser = user;
                syncInterface();
                nav('screen-home');
            } else {
                alert("–û—à–∏–±–∫–∞: –ù–µ–≤–µ—Ä–Ω—ã–π –ü–ò–ù-–∫–æ–¥");
            }
        }

        function triggerRegister() {
            const n = prompt("–í–∞—à–µ –ü–æ–ª–Ω–æ–µ –ò–º—è (–§–ò–û):");
            const p = prompt("–ü—Ä–∏–¥—É–º–∞–π—Ç–µ 4-–∑–Ω–∞—á–Ω—ã–π –ü–ò–ù-–∫–æ–¥:");
            if(n && p && p.length === 4) {
                const newUser = {
                    name: n,
                    clientPin: p,
                    balance: 5000,
                    bonus: 150,
                    usd: 0,
                    creditLimit: 50000,
                    creditBalance: 0,
                    history: { "initial": { title: "–û—Ç–∫—Ä—ã—Ç–∏–µ –∫–∞—Ä—Ç—ã", sum: 5000, date: new Date().toLocaleDateString() } }
                };
                db.ref('clients').push(newUser);
                alert("–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í–∞—à —Å—á–µ—Ç –æ—Ç–∫—Ä—ã—Ç. –ë–∞–ª–∞–Ω—Å: 5,000.00 ‚ÇΩ");
            }
        }

        /* –û–ë–ù–û–í–õ–ï–ù–ò–ï –î–ê–ù–ù–´–• */
        function syncInterface() {
            if(!currentUser) return;

            // –ù–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –≥–ª–∞–≤–Ω–æ–π
            document.getElementById('uiName').innerText = currentUser.name;
            document.getElementById('uiAvatar').innerText = currentUser.name.charAt(0);
            document.getElementById('balDebit').innerText = (currentUser.balance || 0).toLocaleString('ru-RU') + " ‚ÇΩ";
            
            const creditAvail = (currentUser.creditLimit || 0) - (currentUser.creditBalance || 0);
            document.getElementById('balCredit').innerText = creditAvail.toLocaleString('ru-RU') + " ‚ÇΩ";
            document.getElementById('uiBonuses').innerText = "–ù–∞–∫–æ–ø–ª–µ–Ω–æ: " + (currentUser.bonus || 0);

            // –†–µ–Ω–¥–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏
            const rawHistory = currentUser.history ? Object.values(currentUser.history).reverse() : [];
            const historyHTML = rawHistory.map(item => `
                <div class="transaction-row">
                    <div class="tr-icon">${item.sum > 0 ? 'üì•' : 'üõí'}</div>
                    <div class="tr-info">
                        <div class="tr-name">${item.title}</div>
                        <div class="tr-date">${item.date || '–°–µ–≥–æ–¥–Ω—è'}</div>
                    </div>
                    <div class="tr-amount ${item.sum > 0 ? 'tr-plus' : ''}">
                        ${item.sum > 0 ? '+' : ''}${item.sum.toLocaleString()} ‚ÇΩ
                    </div>
                </div>
            `).join('');

            document.getElementById('historyListUI').innerHTML = historyHTML;
            
            if(document.getElementById('screen-details').classList.contains('active')) {
                renderDetailsPanel();
            }
        }

        /* –ù–ê–í–ò–ì–ê–¶–ò–Ø */
        function nav(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            window.scrollTo(0,0);
        }

        /* –§–£–ù–ö–¶–ò–ò –ü–ï–†–ï–í–û–î–ê */
        function confirmTransfer() {
            const targetId = document.getElementById('transferTarget').value;
            const amount = parseInt(document.getElementById('transferSum').value);
            const note = document.getElementById('transferNote').value || "–ü–µ—Ä–µ–≤–æ–¥";

            if(!amount || amount <= 0) return alert("–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É");
            if(currentUser.balance < amount) return alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ");

            const target = allUsers.find(u => u.fbKey === targetId);
            
            // 1. –°–ø–∏—Å–∞–Ω–∏–µ —É –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
            db.ref(`clients/${currentUser.fbKey}`).update({ balance: currentUser.balance - amount });
            db.ref(`clients/${currentUser.fbKey}/history`).push({
                title: "–ü–µ—Ä–µ–≤–æ–¥: " + target.name,
                sum: -amount,
                date: new Date().toLocaleDateString()
            });

            // 2. –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—é
            db.ref(`clients/${targetId}`).update({ balance: (target.balance || 0) + amount });
            db.ref(`clients/${targetId}/history`).push({
                title: "–û—Ç: " + currentUser.name,
                sum: amount,
                date: new Date().toLocaleDateString()
            });

            alert("–ü–µ—Ä–µ–≤–æ–¥ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!");
            document.getElementById('transferSum').value = "";
            nav('screen-home');
        }

        /* –û–ü–õ–ê–¢–ê –£–°–õ–£–ì */
        function payService(service, icon) {
            const sumInput = prompt(`–û–ø–ª–∞—Ç–∞ —É—Å–ª—É–≥–∏: ${service}\n–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É (‚ÇΩ):`);
            const sum = parseInt(sumInput);
            
            if(!sum || sum <= 0) return;
            if(currentUser.balance < sum) return alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è –æ–ø–ª–∞—Ç—ã");

            const bAdd = Math.floor(sum * 0.01); // 1% –∫—ç—à–±—ç–∫
            
            db.ref(`clients/${currentUser.fbKey}`).update({ 
                balance: currentUser.balance - sum,
                bonus: (currentUser.bonus || 0) + bAdd
            });
            db.ref(`clients/${currentUser.fbKey}/history`).push({
                title: "–û–ø–ª–∞—Ç–∞: " + service,
                sum: -sum,
                date: new Date().toLocaleDateString()
            });

            alert(`–£—Å–ø–µ—Ö! –û–ø–ª–∞—á–µ–Ω–æ ${sum} ‚ÇΩ. –ü–æ–ª—É—á–µ–Ω–æ ${bAdd} –±–æ–Ω—É—Å–æ–≤.`);
        }

        /* –î–ï–¢–ê–õ–ò –ö–ê–†–¢–´ */
        function openDetails(type) {
            activeCardType = type;
            const header = document.getElementById('detailsHeader');
            
            if(type === 'debit') {
                header.style.backgroundColor = "var(--sber-green)";
                document.getElementById('detName').innerText = "–î–µ–±–µ—Ç–æ–≤–∞—è –∫–∞—Ä—Ç–∞ ‚Ä¢ –ú–ò–†";
            } else {
                header.style.backgroundColor = "var(--dark-bg)";
                document.getElementById('detName').innerText = "–ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞ ‚Ä¢ Platinum";
            }
            
            renderDetailsPanel();
            nav('screen-details');
        }

        function renderDetailsPanel() {
            const balUI = document.getElementById('detBalance');
            if(activeCardType === 'debit') {
                balUI.innerText = (currentUser.balance || 0).toLocaleString() + " ‚ÇΩ";
            } else {
                const avail = (currentUser.creditLimit || 0) - (currentUser.creditBalance || 0);
                balUI.innerText = avail.toLocaleString() + " ‚ÇΩ";
            }
            document.getElementById('cardSpecificHistory').innerHTML = document.getElementById('historyListUI').innerHTML;
        }

        function topUpFlow() {
            const sum = prompt("–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è —á–µ—Ä–µ–∑ —Ç–µ—Ä–º–∏–Ω–∞–ª (‚ÇΩ):");
            if(sum && !isNaN(sum)) {
                db.ref(`clients/${currentUser.fbKey}`).update({ balance: currentUser.balance + parseInt(sum) });
                db.ref(`clients/${currentUser.fbKey}/history`).push({
                    title: "–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ ATM",
                    sum: parseInt(sum),
                    date: new Date().toLocaleDateString()
                });
            }
        }

        function freezeCard() {
            if(confirm("–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ –≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç—É?")) {
                alert("–ö–∞—Ä—Ç–∞ –∑–∞–º–æ—Ä–æ–∂–µ–Ω–∞. –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –≤–æ–∑–º–æ–∂–Ω–∞ —Ç–æ–ª—å–∫–æ –≤ –æ—Ñ–∏—Å–µ –±–∞–Ω–∫–∞.");
            }
        }

        // –ó–∞–ø—É—Å–∫
        bootstrap();
    </script>
</body>
</html>
