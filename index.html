<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>K-Online Ultra Pro Max | Enterprise Edition</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <style>
        /* –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï */
        :root {
            --bg-main: #f2f4f7;
            --white: #ffffff;
            --sber-green: #21a038;
            --sber-dark: #1a7d2c;
            --danger: #eb4d4b;
            --text-main: #1c1c1e;
            --text-grey: #8e8e93;
            --shadow-soft: 0 10px 30px rgba(0,0,0,0.06);
            --shadow-card: 0 15px 40px rgba(0,0,0,0.18);
            --anim-speed: 0.4s;
        }

        /* –ë–ê–ó–û–í–´–ï –°–¢–ò–õ–ò */
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            overflow: hidden; background: var(--bg-main); 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

        /* –≠–ö–†–ê–ù–ù–ê–Ø –°–ò–°–¢–ï–ú–ê */
        .screen { 
            display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            width: 100%; height: 100%; overflow-y: auto; background: var(--bg-main);
            z-index: 10; opacity: 0; transform: translateY(20px);
            transition: opacity var(--anim-speed) ease, transform var(--anim-speed) ease;
        }
        .screen.active { display: block !important; opacity: 1; transform: translateY(0); }

        /* –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø */
        .auth-container { padding: 90px 30px 40px; text-align: center; min-height: 100vh; display: flex; flex-direction: column; }
        .auth-header h1 { font-size: 56px; font-weight: 900; color: #3494e6; margin: 0; letter-spacing: -3px; }
        .auth-header p { color: var(--text-grey); font-size: 18px; margin-top: 5px; }
        
        .auth-list { 
            background: var(--white); border-radius: 35px; padding: 15px; 
            box-shadow: var(--shadow-soft); margin: 45px 0; max-height: 380px; 
            overflow-y: auto; border: 1px solid rgba(0,0,0,0.03); flex-grow: 1;
        }
        .user-item { 
            padding: 24px; border-bottom: 1px solid #f2f2f7; font-size: 20px; 
            font-weight: 700; display: flex; justify-content: space-between; 
            align-items: center; cursor: pointer; border-radius: 20px; transition: 0.2s;
        }
        .user-item:active { background: #f9f9f9; transform: scale(0.98); }
        .user-item.selected { background: #eef9ef; color: var(--sber-green); }

        /* –ü–ò–ù-–ö–û–î –î–ò–ó–ê–ô–ù */
        #screen-pin-entry {
            background: linear-gradient(180deg, #1c1c1e 0%, #21a038 100%);
            color: white; display: none; flex-direction: column; align-items: center; 
            justify-content: space-between; padding: 80px 40px; z-index: 1000;
        }
        .pin-header { text-align: left; width: 100%; }
        .pin-dots-row { display: flex; gap: 25px; margin: 60px 0; }
        .dot { width: 20px; height: 20px; border: 2.5px solid rgba(255,255,255,0.3); border-radius: 50%; transition: 0.3s; }
        .dot.active { background: white; border-color: white; transform: scale(1.3); box-shadow: 0 0 15px #fff; }
        
        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; width: 100%; max-width: 320px; }
        .n-key { 
            height: 80px; border-radius: 50%; background: rgba(255,255,255,0.1); 
            display: flex; align-items: center; justify-content: center; 
            font-size: 32px; font-weight: 500; cursor: pointer;
        }
        .n-key:active { background: rgba(255,255,255,0.2); }

        /* –î–ê–®–ë–û–†–î –ò –í–ï–†–¢–ò–ö–ê–õ–¨–ù–´–ï –ö–ê–†–¢–´ */
        .dashboard-top { background: var(--white); padding: 70px 25px 35px; border-radius: 0 0 45px 45px; box-shadow: var(--shadow-soft); }
        .user-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        
        /* –ö–ê–†–£–°–ï–õ–¨ –ö–ê–†–¢ */
        .cards-scroll-container { 
            display: flex; overflow-x: auto; padding: 20px 0; gap: 20px; 
            scrollbar-width: none; scroll-snap-type: x mandatory; 
        }
        .cards-scroll-container::-webkit-scrollbar { display: none; }

        .v-card { 
            min-width: 220px; height: 320px; border-radius: 30px; 
            padding: 28px; color: white; display: flex; flex-direction: column; 
            justify-content: space-between; scroll-snap-align: center;
            box-shadow: var(--shadow-card); position: relative; transition: 0.3s;
        }
        .v-card:active { transform: scale(0.96); }
        .v-card-rub { background: linear-gradient(135deg, #1d1d1f 0%, #434343 100%); }
        .v-card-usd { background: linear-gradient(135deg, #2c3e50 0%, #3494e6 100%); }
        .v-card-gold { background: linear-gradient(135deg, #d4af37 0%, #b8860b 100%); }
        
        .v-card .chip { width: 45px; height: 35px; background: rgba(255,255,255,0.15); border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); }
        .v-card .balance-label { font-size: 30px; font-weight: 900; margin-top: 15px; letter-spacing: -1px; }
        .v-card .card-info { font-size: 14px; opacity: 0.6; letter-spacing: 2px; font-family: monospace; }
        .v-card .card-brand { font-weight: 800; font-size: 16px; text-align: right; }

        /* –ö–ù–û–ü–ö–ò –î–ï–ô–°–¢–í–ò–ô */
        .action-grid { display: flex; justify-content: space-around; margin-top: 25px; }
        .act-btn { 
            width: 60px; height: 60px; background: #f2f2f7; border-radius: 20px; 
            display: flex; align-items: center; justify-content: center; font-size: 26px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); cursor: pointer; transition: 0.2s;
        }
        .act-btn:active { transform: translateY(3px); background: #e5e5ea; }

        /* –í–ò–î–ñ–ï–¢–´ */
        .widget-list { padding: 15px 25px 100px; }
        .widget-item { 
            background: white; border-radius: 28px; padding: 22px; margin-bottom: 18px; 
            display: flex; align-items: center; gap: 18px; box-shadow: var(--shadow-soft);
        }
        .w-icon { width: 55px; height: 55px; border-radius: 18px; display: flex; align-items: center; justify-content: center; font-size: 26px; }

        /* –ö–ù–û–ü–ö–ò –ò –§–û–†–ú–´ */
        .main-button { 
            width: 100%; height: 65px; background: var(--sber-green); color: white; 
            border: none; border-radius: 22px; font-size: 19px; font-weight: 700; 
            cursor: pointer; transition: 0.2s; margin-top: 15px;
        }
        .main-button:active { opacity: 0.8; transform: scale(0.98); }
        .btn-red { background: var(--danger) !important; }
        
        .modal { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.85); z-index: 5000; align-items: center; 
            justify-content: center; backdrop-filter: blur(12px); 
        }
        .modal-content { background: white; width: 90%; max-width: 400px; border-radius: 40px; padding: 40px; text-align: center; }
        
        .input-group { text-align: left; margin-top: 20px; }
        .input-group label { font-weight: 700; color: var(--text-grey); margin-left: 10px; font-size: 14px; }
        input, select { 
            width: 100%; height: 62px; border-radius: 20px; border: 1.5px solid #f2f2f7; 
            padding: 0 20px; margin-top: 8px; font-size: 18px; background: #fafafa; transition: 0.3s;
        }
        input:focus { border-color: var(--sber-green); background: #fff; }
        
        .back-icon { font-size: 38px; cursor: pointer; width: 50px; height: 50px; display: flex; align-items: center; }

        /* –ò–°–¢–û–†–ò–Ø */
        .history-row { display: flex; justify-content: space-between; align-items: center; padding: 20px 0; border-bottom: 1px solid #f2f2f7; }
        .h-title { font-weight: 700; font-size: 17px; }
        .h-date { font-size: 13px; color: var(--text-grey); margin-top: 3px; }
        .h-sum { font-weight: 800; font-size: 17px; }
    </style>
</head>
<body>

    <div id="modal-success" class="modal">
        <div class="modal-content">
            <div style="width:90px; height:90px; background:var(--sber-green); color:white; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:45px; margin:0 auto 30px; box-shadow: 0 10px 25px rgba(33,160,56,0.3);">‚úì</div>
            <h2 id="success-header" style="font-size: 26px; font-weight: 800;">–£—Å–ø–µ—à–Ω–æ</h2>
            <div id="success-val" style="font-size: 38px; font-weight: 900; margin: 15px 0;">0 ‚ÇΩ</div>
            <p id="success-desc" style="color:var(--text-grey); font-size:16px; margin-bottom: 35px;"></p>
            <button class="main-button btn-red" onclick="closeSuccess()">–ó–∞–∫—Ä—ã—Ç—å —á–µ–∫</button>
        </div>
    </div>

    <div id="screen-auth" class="screen active">
        <div class="auth-container">
            <div class="auth-header">
                <h1>K-Online</h1>
                <p>–¶–∏—Ñ—Ä–æ–≤–æ–π –±–∞–Ω–∫–∏–Ω–≥ –Ω–æ–≤–æ–≥–æ –ø–æ–∫–æ–ª–µ–Ω–∏—è</p>
            </div>
            
            <div class="auth-list" id="ui-user-list">
                <div style="padding:40px; color:grey;">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º...</div>
            </div>
            
            <div style="display: flex; gap: 15px;">
                <button class="main-button" style="background: #1c1c1e; flex: 1;" onclick="app.createUser()">+ –ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç</button>
                <button class="main-button" style="width: 100px; background: #3494e6;" onclick="app.toPin()">‚ûú</button>
            </div>
        </div>
    </div>

    <div id="screen-pin-entry" class="screen">
        <div class="pin-header">
            <h2 id="pin-user-name" style="font-size: 40px; margin: 0; font-weight: 900;">–ü—Ä–∏–≤–µ—Ç!</h2>
            <p style="opacity: 0.8; font-size: 19px; margin-top: 10px;">–í–≤–µ–¥–∏—Ç–µ –∑–∞—â–∏—Ç–Ω—ã–π –∫–æ–¥</p>
        </div>
        
        <div class="pin-dots-row" id="ui-pin-dots">
            <div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div>
        </div>
        
        <div class="numpad">
            <div class="n-key" onclick="app.pinPress('1')">1</div>
            <div class="n-key" onclick="app.pinPress('2')">2</div>
            <div class="n-key" onclick="app.pinPress('3')">3</div>
            <div class="n-key" onclick="app.pinPress('4')">4</div>
            <div class="n-key" onclick="app.pinPress('5')">5</div>
            <div class="n-key" onclick="app.pinPress('6')">6</div>
            <div class="n-key" onclick="app.pinPress('7')">7</div>
            <div class="n-key" onclick="app.pinPress('8')">8</div>
            <div class="n-key" onclick="app.pinPress('9')">9</div>
            <div class="n-key" style="opacity:0; pointer-events:none;"></div>
            <div class="n-key" onclick="app.pinPress('0')">0</div>
            <div class="n-key" onclick="app.pinPress('DEL')">‚å´</div>
        </div>
        
        <div onclick="app.nav('screen-auth')" style="margin-top:20px; opacity:0.7; font-size:18px; text-decoration:underline;">–°–º–µ–Ω–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</div>
    </div>

    <div id="screen-home" class="screen">
        <div class="dashboard-top">
            <div class="user-bar">
                <div>
                    <div id="ui-name" style="font-size:28px; font-weight:900;">...</div>
                    <div style="font-size:14px; color:var(--sber-green); font-weight:700; margin-top:5px;">SberPrime+ Active</div>
                </div>
                <div id="ui-avatar" style="width:55px; height:55px; background:var(--sber-green); color:white; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:900; font-size:22px; box-shadow: 0 5px 15px rgba(33,160,56,0.2);">?</div>
            </div>
            
            <div class="cards-scroll-container" id="ui-cards-carousel">
                </div>

            <div class="action-grid">
                <div class="act-btn" onclick="app.nav('screen-transfer')">üí∏</div>
                <div class="act-btn" onclick="app.nav('screen-exchange')">üîÑ</div>
                <div class="act-btn" onclick="alert('–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞')">üìë</div>
                <div class="act-btn" onclick="app.nav('screen-loan')">üìà</div>
            </div>
        </div>

        <div class="widget-list">
            <div class="widget-item" onclick="app.nav('screen-transfer')">
                <div class="w-icon" style="background:#e8f5e9; color:var(--sber-green);">üí∏</div>
                <div style="flex:1;">
                    <b style="font-size:18px;">–ü–ª–∞—Ç–µ–∂–∏</b>
                    <div style="font-size:14px; color:grey;">–ü–µ—Ä–µ–≤–æ–¥—ã, –ñ–ö–•, —à—Ç—Ä–∞—Ñ—ã</div>
                </div>
            </div>
            
            <div class="widget-item" onclick="app.nav('screen-exchange')">
                <div class="w-icon" style="background:#e3f2fd; color:#1e88e5;">üè¶</div>
                <div style="flex:1;">
                    <b style="font-size:18px;">–ö—É—Ä—Å USD</b>
                    <div id="ui-home-usd" style="font-weight:700; color:var(--text-main);">91.20 ‚ÇΩ</div>
                </div>
            </div>

            <div id="ui-loan-widget" class="widget-item" onclick="app.nav('screen-loan')">
                <div class="w-icon" style="background:#fff3e0; color:#fb8c00;">üíé</div>
                <div style="flex:1;">
                    <b style="font-size:18px;">–ö—Ä–µ–¥–∏—Ç–Ω—ã–π –ª–∏–º–∏—Ç</b>
                    <div style="font-size:14px; color:var(--sber-green);">–í–∞–º –æ–¥–æ–±—Ä–µ–Ω–æ 500 000 ‚ÇΩ</div>
                </div>
            </div>
        </div>
    </div>

    <div id="screen-transfer" class="screen">
        <div style="padding:70px 30px;">
            <div class="back-icon" onclick="app.nav('screen-home')">‚Üê</div>
            <h2 style="font-size:36px; font-weight:900; margin-bottom:10px;">–ü–µ—Ä–µ–≤–æ–¥</h2>
            <p style="color:grey; font-size:17px; margin-bottom:30px;">–ú–≥–Ω–æ–≤–µ–Ω–Ω–æ –∫–ª–∏–µ–Ω—Ç—É K-Online –ø–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–º—É –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—É.</p>
            
            <div style="background:white; padding:30px; border-radius:35px; box-shadow: var(--shadow-soft);">
                <div class="input-group">
                    <label>–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è</label>
                    <select id="inp-target-user"></select>
                </div>
                
                <div class="input-group">
                    <label>–°—É–º–º–∞ –ø–µ—Ä–µ–≤–æ–¥–∞ (‚ÇΩ)</label>
                    <input type="number" id="inp-tr-amount" placeholder="0.00">
                </div>
                
                <button class="main-button" style="margin-top:40px;" onclick="app.execTransfer()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–µ–Ω—å–≥–∏</button>
                <button class="main-button btn-red" onclick="app.nav('screen-home')">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <div id="screen-exchange" class="screen">
        <div style="padding:70px 30px;">
            <div class="back-icon" onclick="app.nav('screen-home')">‚Üê</div>
            <h2 style="font-size:36px; font-weight:900; margin-bottom:35px;">–û–±–º–µ–Ω USD</h2>
            
            <div style="background:white; padding:40px; border-radius:40px; text-align:center; box-shadow: var(--shadow-soft);">
                <div style="color:grey; font-size:17px; font-weight:500;">–ö—É—Ä—Å –ø—Ä–æ–¥–∞–∂–∏ –¥–æ–ª–ª–∞—Ä–∞</div>
                <div style="font-size:52px; font-weight:900; color:var(--sber-green); margin:15px 0;">91.20 ‚ÇΩ</div>
                
                <div class="input-group">
                    <label>–°—É–º–º–∞ –∫ –ø–æ–∫—É–ø–∫–µ ($)</label>
                    <input type="number" id="inp-buy-usd" placeholder="0.00 $">
                </div>
                
                <button class="main-button" style="margin-top:40px; background:#3494e6;" onclick="app.execExchange()">–ö—É–ø–∏—Ç—å –≤–∞–ª—é—Ç—É</button>
                <button class="main-button btn-red" onclick="app.nav('screen-home')">–ó–∞–∫—Ä—ã—Ç—å</button>
                <p style="font-size:13px; color:grey; margin-top:20px; line-height:1.4;">–ü—Ä–∏ –ø–æ–∫—É–ø–∫–µ –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–ø—É—â–µ–Ω–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞ VISA DIGITAL.</p>
            </div>
        </div>
    </div>

    <div id="screen-loan" class="screen">
        <div style="padding:70px 30px;">
            <div class="back-icon" onclick="app.nav('screen-home')">‚Üê</div>
            <h2 style="font-size:36px; font-weight:900; margin-bottom:15px;">–ö—Ä–µ–¥–∏—Ç</h2>
            <p style="color:grey; font-size:17px; margin-bottom:30px;">–ó–∞—á–∏—Å–ª–µ–Ω–∏–µ –Ω–∞ –Ω–æ–≤—É—é GOLD –∫–∞—Ä—Ç—É –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.</p>
            
            <div style="background:white; padding:35px; border-radius:40px; box-shadow: var(--shadow-soft);">
                <div class="input-group">
                    <label>–õ–∏–º–∏—Ç –∫—Ä–µ–¥–∏—Ç–æ–≤–∞–Ω–∏—è (‚ÇΩ)</label>
                    <input type="number" id="inp-loan-limit" placeholder="–û—Ç 10 000 ‚ÇΩ">
                </div>
                
                <div style="margin-top:30px; font-size:13px; color:#aaa; line-height:1.5;">–ù–∞–∂–∏–º–∞—è –∫–Ω–æ–ø–∫—É, –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å —É—Å–ª–æ–≤–∏—è–º–∏ –∫—Ä–µ–¥–∏—Ç–Ω–æ–≥–æ –¥–æ–≥–æ–≤–æ—Ä–∞ ‚Ññ–ö-0021-99.</div>
                
                <button class="main-button" style="background:#8e44ad; margin-top:40px;" onclick="app.execLoan()">–ü–æ–ª—É—á–∏—Ç—å –¥–µ–Ω—å–≥–∏</button>
                <button class="main-button btn-red" onclick="app.nav('screen-home')">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <div id="screen-details" class="screen">
        <div style="padding: 70px 30px 45px; background:white; border-radius: 0 0 50px 50px; box-shadow: var(--shadow-soft);">
            <div class="back-icon" onclick="app.nav('screen-home')">‚úï</div>
            <div id="det-label" style="font-size: 15px; color: var(--text-grey); font-weight: 800; text-transform: uppercase; letter-spacing: 2px;">MIR PREMIUM</div>
            <h1 id="det-balance" style="font-size:55px; font-weight:900; margin:15px 0; color: var(--text-main);">0 ‚ÇΩ</h1>
            <div style="display:flex; align-items:center; gap:12px; color:#f39c12; font-size:21px; font-weight:800;">
                <span>‚ú®</span> <span id="det-bonus">0</span> –±–æ–Ω—É—Å–æ–≤
            </div>
        </div>
        
        <div style="padding: 40px 30px;">
            <h3 style="font-size: 25px; font-weight: 800; margin-bottom: 25px;">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</h3>
            <div id="ui-history-box">
                </div>
            
            <div id="ui-context-btns" style="margin-top: 40px;"></div>
            
            <button class="main-button btn-red" style="margin-top:20px;" onclick="app.nav('screen-home')">–í–µ—Ä–Ω—É—Ç—å—Å—è</button>
        </div>
    </div>

    <script>
        /**
         * -------------------------------------------------------------------
         * –Ø–î–†–û –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø K-ONLINE (ENTERPRISE EDITION)
         * -------------------------------------------------------------------
         */
        const firebaseConfig = { 
            apiKey: "AIzaSyA3J7KnUgxUHZigwRKmndm7xyxJeeLCrxg", 
            databaseURL: "https://webapp-b7149-default-rtdb.europe-west1.firebasedatabase.app", 
            projectId: "webapp-b7149" 
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // –û–ë–™–ï–ö–¢ –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø –î–õ–Ø –ì–õ–û–ë–ê–õ–¨–ù–û–ì–û –î–û–°–¢–£–ü–ê
        const app = {
            users: [],
            selectedKey: null,
            currentUser: null,
            pinBuffer: "",
            isBusy: false,

            // –ù–ê–í–ò–ì–ê–¶–ò–Ø
            nav(id) {
                document.querySelectorAll('.screen').forEach(s => {
                    s.classList.remove('active');
                    setTimeout(() => { if(!s.classList.contains('active')) s.style.display = 'none'; }, 400);
                });
                const target = document.getElementById(id);
                target.style.display = (id === 'screen-pin-entry') ? 'flex' : 'block';
                setTimeout(() => target.classList.add('active'), 50);
                window.scrollTo(0, 0);
            },

            // –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –î–ê–ù–ù–´–•
            initData() {
                db.ref('clients').on('value', snap => {
                    const data = snap.val();
                    this.users = data ? Object.keys(data).map(k => ({ ...data[k], fbKey: k })) : [];
                    this.renderUsers();
                    
                    if (this.currentUser) {
                        const updated = this.users.find(u => u.fbKey === this.currentUser.fbKey);
                        if (updated) {
                            this.currentUser = updated;
                            this.refreshUI();
                        }
                    }
                });
            },

            renderUsers() {
                const container = document.getElementById('ui-user-list');
                if (!this.users.length) {
                    container.innerHTML = '<div style="padding:40px; color:grey;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                    return;
                }
                container.innerHTML = this.users.map(u => `
                    <div class="user-item ${this.selectedKey === u.fbKey ? 'selected' : ''}" onclick="app.selectUser('${u.fbKey}')">
                        <span>${u.name}</span>
                        ${this.selectedKey === u.fbKey ? '<span style="color:var(--sber-green); font-size:22px;">‚óè</span>' : ''}
                    </div>
                `).join('');

                const select = document.getElementById('inp-target-user');
                if (select) {
                    const others = this.users.filter(u => u.fbKey !== this.currentUser?.fbKey);
                    select.innerHTML = others.map(u => `<option value="${u.fbKey}">${u.name}</option>`).join('');
                }
            },

            selectUser(key) {
                this.selectedKey = key;
                this.renderUsers();
            },

            // –õ–û–ì–ò–ö–ê –ü–ò–ù-–ö–û–î–ê
            toPin() {
                if (!this.selectedKey) return alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å");
                const user = this.users.find(u => u.fbKey === this.selectedKey);
                document.getElementById('pin-user-name').innerText = "–ü—Ä–∏–≤–µ—Ç, " + user.name.split(' ')[0];
                this.pinBuffer = "";
                this.updatePinDots();
                this.nav('screen-pin-entry');
            },

            pinPress(key) {
                if (this.isBusy) return;
                if (key === 'DEL') {
                    this.pinBuffer = this.pinBuffer.slice(0, -1);
                } else if (this.pinBuffer.length < 4) {
                    this.pinBuffer += key;
                }
                this.updatePinDots();

                if (this.pinBuffer.length === 4) {
                    this.isBusy = true;
                    const user = this.users.find(u => u.fbKey === this.selectedKey);
                    setTimeout(() => {
                        if (user.clientPin === this.pinBuffer) {
                            this.currentUser = user;
                            this.refreshUI();
                            this.nav('screen-home');
                            this.pinBuffer = "";
                        } else {
                            alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ü–ò–ù-–∫–æ–¥!");
                            this.pinBuffer = "";
                            this.updatePinDots();
                        }
                        this.isBusy = false;
                    }, 300);
                }
            },

            updatePinDots() {
                const dots = document.querySelectorAll('#ui-pin-dots .dot');
                dots.forEach((d, i) => d.classList.toggle('active', i < this.pinBuffer.length));
            },

            // –ì–õ–ê–í–ù–´–ô –ò–ù–¢–ï–†–§–ï–ô–°
            refreshUI() {
                if (!this.currentUser) return;
                document.getElementById('ui-name').innerText = this.currentUser.name;
                document.getElementById('ui-avatar').innerText = this.currentUser.name.charAt(0).toUpperCase();
                document.getElementById('ui-home-usd').innerText = (this.currentUser.usd || 0).toFixed(2) + " $";

                // –†–ï–ù–î–ï–† –ö–ê–†–£–°–ï–õ–ò –í–ï–†–¢–ò–ö–ê–õ–¨–ù–´–• –ö–ê–†–¢
                const carousel = document.getElementById('ui-cards-carousel');
                let cardsHtml = `
                    <div class="v-card v-card-rub" onclick="app.showDet('rub')">
                        <div class="chip"></div>
                        <div>
                            <div class="balance-label">${(this.currentUser.balance || 0).toLocaleString()} ‚ÇΩ</div>
                            <div class="card-info">MIR DEBIT ‚Ä¢ 4002</div>
                        </div>
                        <div class="card-brand">MIR</div>
                    </div>
                `;

                // –ê–≤—Ç–æ-—Å–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã USD –µ—Å–ª–∏ –±–∞–ª–∞–Ω—Å > 0
                if (this.currentUser.usd > 0) {
                    cardsHtml += `
                        <div class="v-card v-card-usd" onclick="app.showDet('usd')">
                            <div class="chip"></div>
                            <div>
                                <div class="balance-label">${(this.currentUser.usd).toFixed(2)} $</div>
                                <div class="card-info">VISA DIGITAL ‚Ä¢ 8812</div>
                            </div>
                            <div class="card-brand">VISA</div>
                        </div>
                    `;
                }

                if (this.currentUser.hasCredit) {
                    cardsHtml += `
                        <div class="v-card v-card-gold" onclick="app.showDet('gold')">
                            <div class="chip"></div>
                            <div>
                                <div class="balance-label">${(this.currentUser.creditBalance || 0).toLocaleString()} ‚ÇΩ</div>
                                <div class="card-info">GOLD CREDIT ‚Ä¢ 9901</div>
                            </div>
                            <div class="card-brand">MIR GOLD</div>
                        </div>
                    `;
                    document.getElementById('ui-loan-widget').style.display = 'none';
                } else {
                    document.getElementById('ui-loan-widget').style.display = 'flex';
                }

                carousel.innerHTML = cardsHtml;
            },

            // –ë–ê–ù–ö–û–í–°–ö–ò–ï –û–ü–ï–†–ê–¶–ò–ò
            execTransfer() {
                const targetKey = document.getElementById('inp-target-user').value;
                const amount = parseInt(document.getElementById('inp-tr-amount').value);
                const targetUser = this.users.find(u => u.fbKey === targetKey);

                if (!amount || amount <= 0) return alert("–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É");
                if (this.currentUser.balance < amount) return alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤");

                db.ref(`clients/${this.currentUser.fbKey}`).update({ balance: this.currentUser.balance - amount });
                db.ref(`clients/${this.currentUser.fbKey}/history`).push({ title: "–ü–µ—Ä–µ–≤–æ–¥: " + targetUser.name, sum: -amount, date: Date.now() });

                db.ref(`clients/${targetKey}`).update({ balance: (targetUser.balance || 0) + amount });
                db.ref(`clients/${targetKey}/history`).push({ title: "–í—Ö–æ–¥—è—â–∏–π –æ—Ç " + this.currentUser.name, sum: amount, date: Date.now() });

                showSuccess("–ü–µ—Ä–µ–≤–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω", amount, "–ü–æ–ª—É—á–∞—Ç–µ–ª—å: " + targetUser.name);
                document.getElementById('inp-tr-amount').value = "";
            },

            execExchange() {
                const usdVal = parseFloat(document.getElementById('inp-buy-usd').value);
                const cost = Math.round(usdVal * 91.20);

                if (!usdVal || usdVal <= 0) return alert("–£–∫–∞–∂–∏—Ç–µ —Å—É–º–º—É");
                if (this.currentUser.balance < cost) return alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä—É–±–ª–µ–π");

                db.ref(`clients/${this.currentUser.fbKey}`).update({
                    balance: this.currentUser.balance - cost,
                    usd: (this.currentUser.usd || 0) + usdVal
                });
                db.ref(`clients/${this.currentUser.fbKey}/history`).push({ title: "–û–±–º–µ–Ω –≤–∞–ª—é—Ç—ã (USD)", sum: -cost, date: Date.now() });

                showSuccess("–í–∞–ª—é—Ç–∞ –∫—É–ø–ª–µ–Ω–∞", cost, "–ó–∞—á–∏—Å–ª–µ–Ω–æ " + usdVal.toFixed(2) + " $");
                document.getElementById('inp-buy-usd').value = "";
            },

            execLoan() {
                const limit = parseInt(document.getElementById('inp-loan-limit').value);
                if (!limit || limit < 10000) return alert("–ú–∏–Ω. —Å—É–º–º–∞ 10 000 ‚ÇΩ");

                db.ref(`clients/${this.currentUser.fbKey}`).update({
                    hasCredit: true,
                    creditLimit: limit,
                    creditBalance: limit
                });
                db.ref(`clients/${this.currentUser.fbKey}/history`).push({ title: "–ö—Ä–µ–¥–∏—Ç–Ω—ã–π –ª–∏–º–∏—Ç", sum: limit, date: Date.now() });

                showSuccess("–ö—Ä–µ–¥–∏—Ç –≤—ã–¥–∞–Ω", limit, "–ö–∞—Ä—Ç–∞ GOLD –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞");
                document.getElementById('inp-loan-limit').value = "";
            },

            // –î–ï–¢–ê–õ–ò –ò –ò–°–¢–û–†–ò–Ø
            showDet(type) {
                const label = document.getElementById('det-label');
                const bal = document.getElementById('det-balance');
                const bonus = document.getElementById('det-bonus');
                
                if (type === 'rub') { label.innerText = "MIR PREMIUM"; bal.innerText = (this.currentUser.balance || 0).toLocaleString() + " ‚ÇΩ"; }
                if (type === 'usd') { label.innerText = "VISA DIGITAL"; bal.innerText = (this.currentUser.usd || 0).toFixed(2) + " $"; }
                if (type === 'gold') { label.innerText = "MIR GOLD"; bal.innerText = (this.currentUser.creditBalance || 0).toLocaleString() + " ‚ÇΩ"; }

                bonus.innerText = (this.currentUser.bonus || 0).toLocaleString();

                const box = document.getElementById('ui-history-box');
                const history = this.currentUser.history ? Object.values(this.currentUser.history).reverse() : [];
                
                box.innerHTML = history.length ? history.map(h => `
                    <div class="history-row">
                        <div>
                            <div class="h-title">${h.title}</div>
                            <div class="h-date">${new Date(h.date || Date.now()).toLocaleDateString()} ‚Ä¢ –£—Å–ø–µ—à–Ω–æ</div>
                        </div>
                        <div class="h-sum" style="color:${h.sum > 0 ? 'var(--sber-green)' : 'black'}">
                            ${h.sum > 0 ? '+' : ''}${h.sum.toLocaleString()} ‚ÇΩ
                        </div>
                    </div>
                `).join('') : '<div style="padding:30px; text-align:center; color:grey;">–ò—Å—Ç–æ—Ä–∏–∏ –ø–æ–∫–∞ –Ω–µ—Ç</div>';

                const ctxBox = document.getElementById('ui-context-btns');
                ctxBox.innerHTML = type === 'gold' ? 
                    `<button class="main-button" onclick="app.repayLoan()">–ü–æ–≥–∞—Å–∏—Ç—å –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å</button>` :
                    `<button class="main-button" style="background:#333" onclick="alert('–ö–∞—Ä—Ç–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞')">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç—É</button>`;

                this.nav('screen-details');
            },

            repayLoan() {
                const debt = this.currentUser.creditLimit - this.currentUser.creditBalance;
                if (debt <= 0) return alert("–î–æ–ª–≥–æ–≤ –Ω–µ—Ç!");
                if (this.currentUser.balance < debt) return alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ MIR PREMIUM");

                db.ref(`clients/${this.currentUser.fbKey}`).update({
                    balance: this.currentUser.balance - debt,
                    creditBalance: this.currentUser.creditLimit
                });
                db.ref(`clients/${this.currentUser.fbKey}/history`).push({ title: "–ü–æ–≥–∞—à–µ–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–∞", sum: -debt, date: Date.now() });
                alert("–ö—Ä–µ–¥–∏—Ç —É—Å–ø–µ—à–Ω–æ –ø–æ–≥–∞—à–µ–Ω!");
            },

            createUser() {
                const n = prompt("–§–ò–û:");
                const p = prompt("–ü–ò–ù (4 —Ü–∏—Ñ—Ä—ã):");
                if (n && p && p.length === 4) {
                    db.ref('clients').push({ name: n, clientPin: p, balance: 45000, usd: 0, bonus: 1500, hasCredit: false });
                }
            }
        };

        // –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï
        function showSuccess(h, v, d) {
            document.getElementById('success-header').innerText = h;
            document.getElementById('success-val').innerText = v.toLocaleString() + " ‚ÇΩ";
            document.getElementById('success-desc').innerText = d;
            document.getElementById('modal-success').style.display = 'flex';
        }

        function closeSuccess() {
            document.getElementById('modal-success').style.display = 'none';
            app.nav('screen-home');
        }

        // –ó–ê–ü–£–°–ö
        window.onload = () => {
            app.initData();
            app.nav('screen-auth');
        };
    </script>
</body>
</html>
