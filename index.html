<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>K-Online | Secure</title>
    <meta name="apple-mobile-web-app-title" content="–ö-–û–Ω–ª–∞–π–Ω">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/QtVHC5G0/IMG-3035.jpg">
    <link rel="icon" type="image/png" href="https://i.postimg.cc/QtVHC5G0/IMG-3035.jpg">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg-body: #f0f4f8;
            --grad-red: linear-gradient(170deg, #000a1a 0%, #1a0000 40%, #660000 100%);
            --white: #ffffff;
            --sber-green: #2ecc71;
            --danger: #ff3b30;
            --blue: #007aff;
            --frozen-overlay: rgba(179, 229, 252, 0.45);
            --text-dark: #1c1c1e;
            --text-grey: #8e8e93;
            --shadow-soft: 0 10px 30px rgba(0,0,0,0.05);
            --shadow-card: 0 15px 35px rgba(0,0,0,0.4);
            --radius-card: 28px;
            --radius-btn: 22px;
            --anim-screen: 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            overflow: hidden; background: var(--bg-body); 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif;
            -webkit-font-smoothing: antialiased;
            -webkit-user-select: none;
            user-select: none;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

        #snow-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }

        .screen { 
            display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            width: 100%; height: 100%; overflow-y: auto; background: var(--bg-body);
            z-index: 10; opacity: 0; transform: scale(0.96);
            transition: opacity var(--anim-screen), transform var(--anim-screen);
            will-change: transform, opacity;
        }
        .screen.active { display: block !important; opacity: 1; transform: scale(1); }

        /* Auth UI Customization */
        .auth-wrap { padding: 80px 30px 40px; text-align: center; display: flex; flex-direction: column; min-height: 100vh; background: var(--white); }
        .logo-text { font-size: 52px; font-weight: 900; background: linear-gradient(45deg, #ff0000, #ffcc00); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0; letter-spacing: -3px; filter: drop-shadow(0 0 10px rgba(255,0,0,0.3)); }
        
        .input-main { width: 100%; height: 65px; border-radius: 20px; border: 1.5px solid #eee; padding: 0 25px; font-size: 18px; background: #fafafa; margin-top: 30px; transition: 0.3s; text-align: center; }
        .input-main:focus { border-color: var(--blue); background: #fff; }

        .btn-main { width: 100%; height: 65px; border: none; border-radius: var(--radius-btn); font-size: 18px; font-weight: 800; cursor: pointer; transition: 0.2s; }
        .btn-black { background: #000; color: #fff; box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .btn-red { background: var(--danger); color: #fff; }
        .btn-add-id { background: transparent; color: var(--blue); font-weight: 600; margin-top: 15px; border: none; font-size: 15px; }

        /* Admin UI */
        .admin-request { background: #fff; border-radius: 20px; padding: 20px; margin-bottom: 15px; border: 1px solid #ffebeb; box-shadow: var(--shadow-soft); }
        .admin-btns { display: flex; gap: 10px; margin-top: 15px; }
        .btn-appr { flex: 1; background: #2ecc71; color: white; border: none; padding: 12px; border-radius: 12px; font-weight: 700; }
        .btn-rejt { flex: 1; background: #ff3b30; color: white; border: none; padding: 12px; border-radius: 12px; font-weight: 700; }

        /* Dashboard Items */
        .header-top { background: var(--grad-red); padding: 60px 0 45px; border-radius: 0 0 50px 50px; box-shadow: 0 20px 50px rgba(0,0,0,0.4); color: white; position: relative; z-index: 5; overflow: hidden; }
        .user-meta { display: flex; justify-content: space-between; padding: 0 30px; align-items: center; margin-bottom: 30px; }
        .ava-box { width: 55px; height: 55px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 22px; backdrop-filter: blur(10px); border: 2px solid rgba(255,255,255,0.3); }
        .cards-row { display: flex; overflow-x: auto; padding: 10px 30px 40px; gap: 20px; scrollbar-width: none; }
        .v-card { min-width: 175px; height: 260px; border-radius: var(--radius-card); padding: 25px; display: flex; flex-direction: column; justify-content: space-between; box-shadow: var(--shadow-card); position: relative; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); }
        .c-black { background: linear-gradient(160deg, #1a1a1a 0%, #000000 100%); }
        .c-balance { font-size: 24px; font-weight: 900; margin-top: 15px; }
        
        /* Modals */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; align-items: center; justify-content: center; backdrop-filter: blur(15px); }
        .modal-in { background: #fff; width: 85%; max-width: 380px; border-radius: 40px; padding: 40px; text-align: center; }
        
        .form-card { background: #fff; border-radius: 35px; padding: 35px; box-shadow: var(--shadow-soft); }
        input, select { width: 100%; height: 60px; border-radius: 20px; border: 1px solid #e0e0e0; padding: 0 20px; margin-bottom: 25px; font-size: 18px; background: #fafafa; }
    </style>
</head>
<body>

    <canvas id="snow-canvas"></canvas>

    <div id="screen-auth" class="screen active">
        <div class="auth-wrap">
            <h1 class="logo-text">–ö-–û–Ω–ª–∞–π–Ω</h1>
            <p style="color:#999; font-weight:600; margin-top:5px;">–í—Å—Ç—Ä–µ—á–∞–µ–º –ù–æ–≤—ã–π –ì–æ–¥ –í–º–µ—Å—Ç–µ 2026 ‚ùÑÔ∏è</p>
            
            <div style="flex-grow: 1; display: flex; flex-direction: column; justify-content: center;">
                <input type="number" id="auth-tg-id" class="input-main" placeholder="–í–≤–µ–¥–∏—Ç–µ Telegram ID">
                <button class="btn-main btn-black" style="margin-top:20px;" onclick="auth.requestCode()">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Telegram</button>
                <button class="btn-add-id" onclick="view.toggleModal('modal-reg', true)">–î–æ–±–∞–≤–∏—Ç—å ID</button>
            </div>
            
            <p style="font-size: 12px; color: #ccc;">Secure 2FA by Telegram Verification</p>
        </div>
    </div>

    <div id="screen-otp" class="screen">
        <div class="auth-wrap">
            <h2 style="font-size:32px; font-weight:900;">–ö–æ–¥ –∏–∑ –¢–ì</h2>
            <p style="color:#888;">–ú—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π –∫–æ–¥ –≤–∞—à–µ–º—É –±–æ—Ç—É. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –µ–≥–æ –Ω–∏–∂–µ.</p>
            
            <input type="number" id="auth-otp" class="input-main" placeholder="000 000" style="letter-spacing: 8px; font-size: 24px; font-weight: 800;">
            <button class="btn-main btn-black" style="margin-top:25px;" onclick="auth.verifyCode()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
            <p class="btn-add-id" onclick="view.nav('screen-auth')">–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞–∑–∞–¥</p>
        </div>
    </div>

    <div id="screen-home" class="screen">
        <div class="header-top">
            <div class="user-meta">
                <div>
                    <div id="h-name" style="font-size:26px; font-weight:900;">...</div>
                    <div style="font-size:13px; opacity:0.7; margin-top:5px;">Premium Client ‚ùÑÔ∏è</div>
                </div>
                <div class="ava-box" id="h-ava">?</div>
            </div>
            <div class="cards-row" id="h-cards"></div>
            <div style="display:flex; justify-content:center; gap:25px;">
                <div onclick="view.nav('screen-transfer')" style="font-size:30px; background:rgba(255,255,255,0.1); padding:15px; border-radius:20px; backdrop-filter:blur(10px);">üéÅ</div>
                <div onclick="view.nav('screen-admin')" id="admin-icon" style="display:none; font-size:30px; background:rgba(255,255,255,0.1); padding:15px; border-radius:20px; backdrop-filter:blur(10px);">üõ°Ô∏è</div>
                <div onclick="location.reload()" style="font-size:30px; background:rgba(255,255,255,0.1); padding:15px; border-radius:20px; backdrop-filter:blur(10px);">üö™</div>
            </div>
        </div>
        <div style="padding:30px;">
            <h3 style="color:#333;">–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</h3>
            <div id="h-history"></div>
        </div>
    </div>

    <div id="screen-transfer" class="screen">
        <div class="form-box" style="padding:30px;">
            <div style="font-size:30px; margin-bottom:20px;" onclick="view.nav('screen-home')">‚Üê</div>
            <h2 style="font-size:36px; font-weight:900; margin-bottom:10px;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å üéÅ</h2>
            <div class="form-card">
                <label style="color:#aaa; font-size:12px; font-weight:700;">–ö–û–ú–£</label>
                <select id="tr-target"></select>
                <label style="color:#aaa; font-size:12px; font-weight:700;">–°–£–ú–ú–ê (‚ÇΩ)</label>
                <input type="number" id="tr-val" placeholder="0">
                <button class="btn-main btn-black" onclick="bank.send()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–¥–∞—Ä–æ–∫</button>
            </div>
        </div>
    </div>

    <div id="screen-admin" class="screen">
        <div style="padding:40px 25px;">
            <h2 onclick="view.nav('screen-home')">‚Üê –ú–æ–¥–µ—Ä–∞—Ü–∏—è</h2>
            <p style="color:#888; margin-bottom:25px;">–ü–ª–∞—Ç–µ–∂–∏ —Å–≤—ã—à–µ 1.000 ‚ÇΩ</p>
            <div id="admin-pending-list"></div>
        </div>
    </div>

    <div id="modal-reg" class="modal">
        <div class="modal-in">
            <h2 style="margin-top:0;">–ü—Ä–∏–≤—è–∑–∫–∞ ID</h2>
            <p style="color:#888; font-size:14px;">–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤ —Å–∏—Å—Ç–µ–º–µ</p>
            <input type="text" id="reg-name" placeholder="–ò–º—è –§–∞–º–∏–ª–∏—è" style="margin-top:10px;">
            <input type="number" id="reg-phone" placeholder="–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞">
            <input type="number" id="reg-tg" placeholder="–í–∞—à Telegram ID">
            <button class="btn-main btn-black" onclick="auth.register()">–ü—Ä–∏–≤—è–∑–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
            <p class="btn-add-id" onclick="view.toggleModal('modal-reg', false)">–û—Ç–º–µ–Ω–∞</p>
        </div>
    </div>

    <div id="modal-success" class="modal">
        <div class="modal-in">
            <div style="width:90px; height:90px; background:#2ecc71; color:white; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:50px; margin:0 auto 25px;">üéÑ</div>
            <h2 id="suc-h">–£—Å–ø–µ—à–Ω–æ</h2>
            <div id="suc-val" style="font-size:36px; font-weight:900; margin:15px 0;">0 ‚ÇΩ</div>
            <p id="suc-p" style="color:#aaa; margin-bottom:30px;"></p>
            <button class="btn-main btn-red" onclick="view.toggleModal('modal-success', false); view.nav('screen-home');">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const BOT_TOKEN = "8548215166:AAHhHo_ODrDZl-6Lg5Zi-BpBIpeMzXdOEFE"; 
        const ADMIN_TG_ID = "7597506775"; // –ö–æ–º—É –ø—Ä–∏—Ö–æ–¥—è—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø—Ä–æ–≤–µ—Ä–∫–µ

        const config = { 
            apiKey: "AIzaSyA3J7KnUgxUHZigwRKmndm7xyxJeeLCrxg", 
            databaseURL: "https://webapp-b7149-default-rtdb.europe-west1.firebasedatabase.app", 
            projectId: "webapp-b7149" 
        };
        firebase.initializeApp(config);
        const rtdb = firebase.database();
        const sound = new Audio('https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3');

        let state = { all: [], user: null, tempOTP: null, candidate: null };

        // --- AUTH LOGIC ---
        const auth = {
            requestCode: async () => {
                const tgId = document.getElementById('auth-tg-id').value;
                const user = state.all.find(u => u.tg_id == tgId);
                
                if(!user) return alert("–≠—Ç–æ—Ç ID –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω. –ù–∞–∂–º–∏—Ç–µ '–î–æ–±–∞–≤–∏—Ç—å ID'");
                
                state.tempOTP = Math.floor(100000 + Math.random() * 900000);
                state.candidate = user;

                // –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞ —á–µ—Ä–µ–∑ –¢–µ–ª–µ–≥—Ä–∞–º –ë–æ—Ç–∞
                const text = `‚ùÑÔ∏è <b>K-Online Security</b>\n\n–í–∞—à –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π –∫–æ–¥ –¥–ª—è –≤—Ö–æ–¥–∞:\n<code>${state.tempOTP}</code>\n\n–ï—Å–ª–∏ —ç—Ç–æ –Ω–µ –≤—ã, –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä—É–π—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.`;
                
                try {
                    await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ chat_id: tgId, text: text, parse_mode: 'HTML' })
                    });
                    view.nav('screen-otp');
                } catch(e) {
                    alert("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–¥–∞. –í—ã –∑–∞–ø—É—Å—Ç–∏–ª–∏ –±–æ—Ç–∞?");
                }
            },
            verifyCode: () => {
                const code = document.getElementById('auth-otp').value;
                if(code == state.tempOTP) {
                    state.user = state.candidate;
                    state.tempOTP = null;
                    sound.play();
                    view.drawHome();
                    view.nav('screen-home');
                } else {
                    alert("–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥!");
                }
            },
            register: () => {
                const name = document.getElementById('reg-name').value;
                const tg = document.getElementById('reg-tg').value;
                const ph = document.getElementById('reg-phone').value;
                if(!name || !tg || !ph) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!");

                const newRef = rtdb.ref('clients').push();
                newRef.set({ name, tg_id: tg, phone: ph, balance: 1000, isFrozen: false });
                alert("–ê–∫–∫–∞—É–Ω—Ç –ø—Ä–∏–≤—è–∑–∞–Ω! –¢–µ–ø–µ—Ä—å –≤–≤–æ–π–¥–∏—Ç–µ.");
                view.toggleModal('modal-reg', false);
            }
        };

        // --- BANK LOGIC ---
        const bank = {
            send: async () => {
                const toKey = document.getElementById('tr-target').value;
                const val = parseInt(document.getElementById('tr-val').value);
                const u = state.user;
                const target = state.all.find(x => x.fbKey === toKey);

                if(!val || val <= 0 || u.balance < val) return alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤");

                if(val > 1000) {
                    // –ù–ê –ü–†–û–í–ï–†–ö–£
                    const modRef = rtdb.ref('moderation').push();
                    await modRef.set({
                        from: u.fbKey, fromName: u.name, fromTg: u.tg_id,
                        to: toKey, toName: target.name, toTg: target.tg_id,
                        amount: val, date: Date.now()
                    });
                    // –•–æ–ª–¥–∏—Ä–æ–≤–∞–Ω–∏–µ (—Å–Ω–∏–º–∞–µ–º —É –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è —Å—Ä–∞–∑—É)
                    rtdb.ref(`clients/${u.fbKey}`).update({ balance: u.balance - val });
                    
                    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É
                    fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${ADMIN_TG_ID}&text=üí≥ <b>–ó–∞–ø—Ä–æ—Å –Ω–∞ –ø–µ—Ä–µ–≤–æ–¥</b>\n–°—É–º–º–∞: ${val}‚ÇΩ\n–û—Ç: ${u.name}\n–ö–æ–º—É: ${target.name}\n\n<i>–û–¥–æ–±—Ä–∏—Ç–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.</i>&parse_mode=HTML`);
                    
                    alert("–ü–µ—Ä–µ–≤–æ–¥ —Å–≤—ã—à–µ 1.000 ‚ÇΩ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.");
                    view.nav('screen-home');
                } else {
                    // –ú–ì–ù–û–í–ï–ù–ù–´–ô
                    rtdb.ref(`clients/${u.fbKey}`).update({ balance: u.balance - val });
                    rtdb.ref(`clients/${toKey}`).update({ balance: (target.balance||0) + val });
                    rtdb.ref(`clients/${u.fbKey}/history`).push({ title: `–ü–µ—Ä–µ–≤–æ–¥: ${target.name}`, sum: -val, date: Date.now() });
                    rtdb.ref(`clients/${toKey}/history`).push({ title: `–û—Ç: ${u.name}`, sum: val, date: Date.now() });
                    view.showSuccess("–£—Å–ø–µ—à–Ω–æ", val+" ‚ÇΩ", "–ü–µ—Ä–µ–≤–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω");
                }
            },
            approve: async (key, data) => {
                // –ü–ª—é—Å—É–µ–º –ø–æ–ª—É—á–∞—Ç–µ–ª—é
                const tRef = rtdb.ref(`clients/${data.to}/balance`);
                tRef.transaction(current => (current || 0) + data.amount);
                
                rtdb.ref(`clients/${data.from}/history`).push({ title: `–û–¥–æ–±—Ä–µ–Ω–æ: ${data.toName}`, sum: -data.amount, date: Date.now() });
                rtdb.ref(`clients/${data.to}/history`).push({ title: `–ü—Ä–∏–Ω—è—Ç–æ: ${data.fromName}`, sum: data.amount, date: Date.now() });
                
                rtdb.ref(`moderation/${key}`).remove();
                
                // –£–≤–µ–¥–æ–º–ª—è–µ–º –æ–±–æ–∏—Ö –≤ –¢–ì
                fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${data.fromTg}&text=‚úÖ –í–∞—à –ø–µ—Ä–µ–≤–æ–¥ –Ω–∞ ${data.amount}‚ÇΩ –¥–ª—è ${data.toName} –æ–¥–æ–±—Ä–µ–Ω!`);
                fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${data.toTg}&text=üí∞ –í–∞–º –∑–∞—á–∏—Å–ª–µ–Ω–æ ${data.amount}‚ÇΩ –æ—Ç ${data.fromName}`);
            },
            reject: async (key, data) => {
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—é
                const fRef = rtdb.ref(`clients/${data.from}/balance`);
                fRef.transaction(current => (current || 0) + data.amount);
                
                rtdb.ref(`moderation/${key}`).remove();
                fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${data.fromTg}&text=‚ùå –í–∞—à –ø–µ—Ä–µ–≤–æ–¥ –Ω–∞ ${data.amount}‚ÇΩ –æ—Ç–∫–ª–æ–Ω–µ–Ω –±–∞–Ω–∫–æ–º. –°—Ä–µ–¥—Å—Ç–≤–∞ –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã.`);
            }
        };

        // --- VIEW ENGINE ---
        const view = {
            nav: (id) => {
                document.querySelectorAll('.screen').forEach(s => {
                    s.classList.remove('active');
                    setTimeout(() => { if(!s.classList.contains('active')) s.style.display='none'; }, 400);
                });
                const t = document.getElementById(id);
                t.style.display = 'block';
                setTimeout(() => t.classList.add('active'), 50);
            },
            toggleModal: (id, show) => document.getElementById(id).style.display = show ? 'flex' : 'none',
            drawHome: () => {
                const u = state.user;
                document.getElementById('h-name').innerText = u.name;
                document.getElementById('h-ava').innerText = u.name[0];
                document.getElementById('admin-icon').style.display = (u.tg_id == ADMIN_TG_ID) ? 'block' : 'none';
                
                document.getElementById('h-cards').innerHTML = `
                    <div class="v-card c-black">
                        <div style="font-weight:900; color:white;">MIR GOLD</div>
                        <div>
                            <div class="c-balance">${(u.balance || 0).toLocaleString()} ‚ÇΩ</div>
                            <div style="opacity:0.6; font-size:12px; margin-top:5px;">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ 2026</div>
                        </div>
                    </div>
                `;

                const hist = u.history ? Object.values(u.history).reverse() : [];
                document.getElementById('h-history').innerHTML = hist.map(h => `
                    <div style="display:flex; justify-content:space-between; padding:15px 0; border-bottom:1px solid #eee;">
                        <div><b>${h.title}</b><br><small style="color:#aaa;">${new Date(h.date).toLocaleDateString()}</small></div>
                        <div style="font-weight:700; color:${h.sum>0?'#2ecc71':'#000'}">${h.sum>0?'+':''}${h.sum.toLocaleString()} ‚ÇΩ</div>
                    </div>
                `).join('');

                const sel = document.getElementById('tr-target');
                sel.innerHTML = state.all.filter(x => x.fbKey !== u.fbKey).map(x => `<option value="${x.fbKey}">${x.name}</option>`).join('');
            },
            drawAdmin: (data) => {
                const box = document.getElementById('admin-pending-list');
                if(!data) return box.innerHTML = "<p style='color:#ccc;'>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞—è–≤–æ–∫</p>";
                box.innerHTML = Object.keys(data).map(k => `
                    <div class="admin-request">
                        <div style="font-size:20px; font-weight:800;">${data[k].amount} ‚ÇΩ</div>
                        <div style="font-size:13px; margin:5px 0;">–û—Ç: ${data[k].fromName} <br> –ö–æ–º—É: ${data[k].toName}</div>
                        <div class="admin-btns">
                            <button class="btn-appr" onclick='bank.approve("${k}", ${JSON.stringify(data[k])})'>–û–¥–æ–±—Ä–∏—Ç—å</button>
                            <button class="btn-rejt" onclick='bank.reject("${k}", ${JSON.stringify(data[k])})'>–í–µ—Ä–Ω—É—Ç—å</button>
                        </div>
                    </div>
                `).join('');
            },
            showSuccess: (h, v, p) => {
                document.getElementById('suc-h').innerText = h; 
                document.getElementById('suc-val').innerText = v; 
                document.getElementById('suc-p').innerText = p;
                view.toggleModal('modal-success', true);
                sound.play();
            }
        };

        // --- INIT ---
        rtdb.ref('clients').on('value', s => {
            const d = s.val();
            state.all = d ? Object.keys(d).map(k => ({...d[k], fbKey: k})) : [];
            if(state.user) {
                state.user = state.all.find(x => x.fbKey === state.user.fbKey);
                view.drawHome();
            }
        });

        rtdb.ref('moderation').on('value', s => view.drawAdmin(s.val()));

        // Snow Effect
        const canvas = document.getElementById('snow-canvas');
        const ctx = canvas.getContext('2d');
        let flakes = [];
        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.onresize = resize; resize();
        for(let i=0; i<100; i++) flakes.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, r: Math.random()*3+1, v: Math.random()*1+0.5 });
        function drawSnow() {
            ctx.clearRect(0,0,canvas.width,canvas.height); ctx.fillStyle = "white"; ctx.beginPath();
            flakes.forEach(f => { ctx.moveTo(f.x, f.y); ctx.arc(f.x, f.y, f.r, 0, Math.PI*2); });
            ctx.fill(); flakes.forEach(f => { f.y += f.v; if(f.y > canvas.height) f.y = -5; });
            requestAnimationFrame(drawSnow);
        }
        drawSnow();
    </script>
</body>
</html>
