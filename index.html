<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>K-Online | Ultimate Secure Edition</title>
    <meta name="apple-mobile-web-app-title" content="–ö-–û–Ω–ª–∞–π–Ω">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/QtVHC5G0/IMG-3035.jpg">
    <link rel="icon" type="image/png" href="https://i.postimg.cc/QtVHC5G0/IMG-3035.jpg">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg-body: #f2f7fa;
            --grad-main: linear-gradient(170deg, #000a1a 0%, #1a0000 40%, #660000 100%);
            --white: #ffffff;
            --sber-green: #2ecc71;
            --danger: #ff3b30;
            --blue: #007aff;
            --text-dark: #1c1c1e;
            --text-grey: #8e8e93;
            --shadow-soft: 0 10px 30px rgba(0,0,0,0.08);
            --shadow-card: 0 15px 35px rgba(0,0,0,0.3);
            --radius-card: 28px;
            --radius-btn: 22px;
            --anim-speed: 0.4s;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            overflow: hidden; background: var(--bg-body); 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif;
        }

        #snow-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }

        /* –°–∏—Å—Ç–µ–º–∞ —ç–∫—Ä–∞–Ω–æ–≤ */
        .screen { 
            display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            width: 100%; height: 100%; overflow-y: auto; background: var(--bg-body);
            z-index: 10; opacity: 0; transform: translateY(20px);
            transition: opacity var(--anim-speed) ease, transform var(--anim-speed) ease;
        }
        .screen.active { display: block !important; opacity: 1; transform: translateY(0); }

        /* –î–∏–∑–∞–π–Ω –≤—Ö–æ–¥–∞ */
        .auth-container { 
            min-height: 100vh; display: flex; flex-direction: column; 
            justify-content: space-between; padding: 60px 35px 40px; 
            background: var(--white); text-align: center; 
        }
        .logo-area h1 { 
            font-size: 56px; font-weight: 900; margin: 0; letter-spacing: -3px;
            background: linear-gradient(45deg, #ff0000, #ffcc00);
            -webkit-background-clip: text; -webkit-fill-color: transparent;
            filter: drop-shadow(0 5px 15px rgba(255,0,0,0.2));
        }
        .input-group { margin-top: 40px; }
        .input-main { 
            width: 100%; height: 70px; border-radius: 20px; border: 2px solid #f0f0f0;
            padding: 0 25px; font-size: 18px; font-weight: 600; background: #fafafa;
            transition: 0.3s; margin-bottom: 20px;
        }
        .input-main:focus { border-color: var(--blue); background: #fff; box-shadow: 0 0 15px rgba(0,122,255,0.1); }

        .btn-full { 
            width: 100%; height: 70px; border: none; border-radius: var(--radius-btn);
            font-size: 18px; font-weight: 800; cursor: pointer; transition: 0.2s;
        }
        .btn-black { background: #1a1a1a; color: #fff; box-shadow: 0 10px 25px rgba(0,0,0,0.15); }
        .btn-black:active { transform: scale(0.97); }

        /* –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω */
        .header-bg { 
            background: var(--grad-main); padding: 70px 0 50px; 
            border-radius: 0 0 45px 45px; color: white; position: relative;
            box-shadow: 0 15px 40px rgba(0,0,0,0.2);
        }
        .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 0 30px; margin-bottom: 30px; }
        .user-info h2 { margin: 0; font-size: 28px; font-weight: 900; }
        .avatar { width: 55px; height: 55px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; font-weight: 800; border: 2px solid rgba(255,255,255,0.3); backdrop-filter: blur(10px); }

        /* –ö–∞—Ä—Ç–æ—á–∫–∞ */
        .card-slider { padding: 0 30px; margin-bottom: 25px; }
        .bank-card { 
            width: 100%; height: 210px; border-radius: 32px; background: #000;
            padding: 30px; display: flex; flex-direction: column; justify-content: space-between;
            box-shadow: var(--shadow-card); position: relative; overflow: hidden;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .card-chip { width: 45px; height: 35px; background: linear-gradient(135deg, #d4af37, #f9e29c); border-radius: 8px; }

        /* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */
        .action-grid { display: flex; justify-content: center; gap: 20px; margin-top: 20px; }
        .action-item { 
            width: 60px; height: 60px; background: rgba(255,255,255,0.12);
            border-radius: 20px; display: flex; align-items: center; justify-content: center;
            font-size: 24px; backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.1);
        }

        /* –°–ø–∏—Å–æ–∫ –∏—Å—Ç–æ—Ä–∏–∏ */
        .section-label { padding: 25px 30px 15px; font-size: 20px; font-weight: 800; color: var(--text-dark); }
        .history-card { 
            background: #fff; margin: 0 25px 12px; padding: 20px; 
            border-radius: 22px; display: flex; justify-content: space-between;
            align-items: center; box-shadow: var(--shadow-soft);
        }

        /* –ó–∞–º–æ—Ä–æ–∑–∫–∞ */
        #frozen-overlay { 
            position: fixed; top:0; left:0; width:100%; height:100%; 
            background: #fff; z-index: 10000; display: none;
            flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 40px;
        }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.8); z-index: 9999; align-items: center; justify-content: center;
            backdrop-filter: blur(12px);
        }
        .modal-content { background: #fff; width: 88%; max-width: 400px; border-radius: 35px; padding: 40px; text-align: center; }

        .admin-request-item { background: #fff; border-radius: 20px; padding: 20px; margin-bottom: 15px; border: 1px solid #eee; }
    </style>
</head>
<body>

    <canvas id="snow-canvas"></canvas>

    <div id="frozen-overlay">
        <div style="font-size: 100px; margin-bottom: 20px;">‚ùÑÔ∏è</div>
        <h1 style="font-size: 32px; font-weight: 900; margin: 0;">–í–∞—à —Å—á—ë—Ç –∑–∞–º–æ—Ä–æ–∂–µ–Ω</h1>
        <p style="color: #8e8e93; font-size: 18px; margin-top: 15px;">–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ª–∏—á–Ω–æ—Å—Ç–∏.</p>
        <button class="btn-full btn-black" onclick="location.reload()" style="margin-top: 30px; width: 200px;">–û–∫</button>
    </div>

    <div id="screen-auth" class="screen active">
        <div class="auth-container">
            <div class="logo-area">
                <h1>K-Online</h1>
                <p style="font-weight: 600; color: #888; margin-top: 10px;">Security First ‚Ä¢ 2026 üéÑ</p>
            </div>
            
            <div class="input-group">
                <input type="number" id="auth-id-input" class="input-main" placeholder="–í–≤–µ–¥–∏—Ç–µ –í–∞—à Telegram ID">
                <button class="btn-full btn-black" onclick="auth.startLogin()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
                <button style="background:transparent; border:none; color:var(--blue); font-weight:700; margin-top:20px;" onclick="view.openModal('modal-register')">–î–æ–±–∞–≤–∏—Ç—å ID –≤ —Å–∏—Å—Ç–µ–º—É</button>
            </div>

            <div style="font-size: 12px; color: #ccc;">Protected by Telegram 2FA</div>
        </div>
    </div>

    <div id="screen-otp" class="screen">
        <div class="auth-container">
            <div>
                <h2 style="font-size: 32px; font-weight: 900;">–ó–∞—â–∏—Ç–Ω—ã–π –∫–æ–¥</h2>
                <p style="color:#888;">–ú—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –≤ –í–∞—à Telegram –±–æ—Ç.</p>
            </div>
            <input type="number" id="otp-input" class="input-main" placeholder="000 000" style="text-align:center; font-size:32px; letter-spacing:8px;">
            <button class="btn-full btn-black" onclick="auth.completeLogin()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—Ö–æ–¥</button>
            <p style="color: var(--blue); font-weight: 600;" onclick="view.showScreen('screen-auth')">–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞–∑–∞–¥</p>
        </div>
    </div>

    <div id="screen-home" class="screen">
        <div class="header-bg">
            <div class="top-bar">
                <div class="user-info">
                    <div style="font-size: 14px; opacity: 0.7;">–î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä,</div>
                    <h2 id="user-display-name">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
                </div>
                <div class="avatar" id="user-avatar">?</div>
            </div>

            <div class="card-slider">
                <div class="bank-card">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <div class="card-chip"></div>
                        <div style="color:white; font-weight:900; font-style:italic;">MIR</div>
                    </div>
                    <div>
                        <div style="font-size: 36px; font-weight: 900; color: white;" id="user-balance">0.00 ‚ÇΩ</div>
                        <div style="font-size: 14px; color: rgba(255,255,255,0.5); margin-top: 5px;">Digital Card ‚Ä¢ 2026</div>
                    </div>
                </div>
            </div>

            <div class="action-grid">
                <div class="action-item" onclick="view.showScreen('screen-transfer')">üéÅ</div>
                <div class="action-item" onclick="view.showScreen('screen-history')">üìú</div>
                <div class="action-item" id="admin-node" style="display:none; background: #ffcc00; color: black;" onclick="view.showScreen('screen-admin')">üõ°Ô∏è</div>
                <div class="action-item" onclick="location.reload()">üö™</div>
            </div>
        </div>

        <div class="section-label">–ë—ã—Å—Ç—Ä—ã–µ –ø–ª–∞—Ç–µ–∂–∏</div>
        <div id="home-history-mini"></div>
    </div>

    <div id="screen-transfer" class="screen">
        <div style="padding: 60px 30px;">
            <div style="font-size: 32px; margin-bottom: 25px;" onclick="view.showScreen('screen-home')">‚Üê</div>
            <h2 style="font-size: 36px; font-weight: 900;">–ü–µ—Ä–µ–≤–æ–¥</h2>
            
            <div style="background:#fff; padding:30px; border-radius:30px; box-shadow: var(--shadow-soft);">
                <label style="font-size:12px; color:#aaa; font-weight:800;">–ü–û–õ–£–ß–ê–¢–ï–õ–¨</label>
                <select id="transfer-to" class="input-main" style="margin-top:10px;"></select>

                <label style="font-size:12px; color:#aaa; font-weight:800;">–°–£–ú–ú–ê (‚ÇΩ)</label>
                <input type="number" id="transfer-amount" class="input-main" placeholder="0.00" style="margin-top:10px;">
                
                <button class="btn-full btn-black" onclick="bank.initTransfer()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–¥–∞—Ä–æ–∫</button>
            </div>
        </div>
    </div>

    <div id="screen-history" class="screen">
        <div style="padding: 60px 25px;">
            <div style="font-size: 32px; margin-bottom: 25px;" onclick="view.showScreen('screen-home')">‚Üê</div>
            <h2 style="font-size: 36px; font-weight: 900; margin-left: 10px;">–ò—Å—Ç–æ—Ä–∏—è</h2>
            <div id="full-history-list" style="margin-top: 20px;"></div>
        </div>
    </div>

    <div id="screen-admin" class="screen">
        <div style="padding: 60px 25px;">
            <div style="font-size: 32px; margin-bottom: 25px;" onclick="view.showScreen('screen-home')">‚Üê</div>
            <h2 style="font-size: 30px; font-weight: 900;">–ú–æ–¥–µ—Ä–∞—Ü–∏—è (1000‚ÇΩ+)</h2>
            <div id="admin-requests-list" style="margin-top: 20px;"></div>
        </div>
    </div>

    <div id="modal-register" class="modal">
        <div class="modal-content">
            <h2 style="margin:0 0 10px 0;">–ù–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç</h2>
            <p style="color:#888; margin-bottom:25px;">–ü—Ä–∏–≤—è–∂–∏—Ç–µ –í–∞—à –Ω–æ–º–µ—Ä –∏ Telegram ID –∫ —Å–∏—Å—Ç–µ–º–µ</p>
            <input type="text" id="reg-name" class="input-main" placeholder="–í–∞—à–µ –ò–º—è">
            <input type="number" id="reg-phone" class="input-main" placeholder="–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞">
            <input type="number" id="reg-tgid" class="input-main" placeholder="–í–∞—à Telegram ID">
            <button class="btn-full btn-black" onclick="auth.register()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
            <p style="margin-top:20px; color:#aaa;" onclick="view.closeModal('modal-register')">–û—Ç–º–µ–Ω–∞</p>
        </div>
    </div>

    <div id="modal-success" class="modal">
        <div class="modal-content">
            <div style="font-size:70px; margin-bottom:20px;">‚úÖ</div>
            <h2 id="success-title">–ì–æ—Ç–æ–≤–æ</h2>
            <p id="success-desc" style="color:#888; font-size:18px;"></p>
            <button class="btn-full btn-black" onclick="view.closeModal('modal-success'); view.showScreen('screen-home');">–û—Ç–ª–∏—á–Ω–æ</button>
        </div>
    </div>

    <script>
        // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø (–í–°–¢–ê–í–¨ –°–í–û–ò –î–ê–ù–ù–´–ï) ---
        const BOT_TOKEN = "8548215166:AAHhHo_ODrDZl-6Lg5Zi-BpBIpeMzXdOEFE";
        const MY_ADMIN_ID = "7597506775"; // –¢–æ—Ç, –∫—Ç–æ –≤–∏–¥–∏—Ç –∫–Ω–æ–ø–∫—É üõ°Ô∏è –∏ –æ–¥–æ–±—Ä—è–µ—Ç

        const firebaseConfig = { 
            apiKey: "AIzaSyA3J7KnUgxUHZigwRKmndm7xyxJeeLCrxg", 
            databaseURL: "https://webapp-b7149-default-rtdb.europe-west1.firebasedatabase.app", 
            projectId: "webapp-b7149" 
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let state = { allUsers: [], currentUser: null, otp: null, pendingUser: null };

        // --- –õ–û–ì–ò–ö–ê –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò ---
        const auth = {
            startLogin: async () => {
                const tgId = document.getElementById('auth-id-input').value;
                const user = state.allUsers.find(u => u.tg_id == tgId);

                if (!user) return alert("–≠—Ç–æ—Ç ID –Ω–µ –Ω–∞–π–¥–µ–Ω. –ù–∞–∂–º–∏—Ç–µ '–î–æ–±–∞–≤–∏—Ç—å ID'");
                if (user.isFrozen) return document.getElementById('frozen-overlay').style.display = 'flex';

                state.otp = Math.floor(100000 + Math.random() * 900000);
                state.pendingUser = user;

                // –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞ –≤ –¢–µ–ª–µ–≥—Ä–∞–º
                const msg = `üéÑ <b>K-Online Auth</b>\n\n–í–∞—à –ø—Ä–æ–≤–µ—Ä–æ—á–Ω—ã–π –∫–æ–¥:\n<code>${state.otp}</code>`;
                try {
                    await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ chat_id: tgId, text: msg, parse_mode: 'HTML' })
                    });
                    view.showScreen('screen-otp');
                } catch(e) { alert("–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å –±–æ—Ç–æ–º."); }
            },

            completeLogin: () => {
                const input = document.getElementById('otp-input').value;
                if (input == state.otp) {
                    state.currentUser = state.pendingUser;
                    view.renderProfile();
                    view.showScreen('screen-home');
                } else { alert("–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥!"); }
            },

            register: () => {
                const name = document.getElementById('reg-name').value;
                const phone = document.getElementById('reg-phone').value;
                const tg = document.getElementById('reg-tgid').value;

                if (!name || !phone || !tg) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å—ë!");

                db.ref('clients').push({
                    name: name,
                    phone: phone,
                    tg_id: tg,
                    balance: 1000,
                    isFrozen: false,
                    history: []
                });
                alert("–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω! –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ.");
                view.closeModal('modal-register');
            }
        };

        // --- –õ–û–ì–ò–ö–ê –ë–ê–ù–ö–ê ---
        const bank = {
            initTransfer: async () => {
                const targetKey = document.getElementById('transfer-to').value;
                const amount = parseInt(document.getElementById('transfer-amount').value);
                const sender = state.currentUser;
                const target = state.allUsers.find(u => u.fbKey === targetKey);

                if (!amount || amount <= 0 || sender.balance < amount) return alert("–û—à–∏–±–∫–∞ —Å—É–º–º—ã");

                if (amount >= 1000) {
                    // –ù–ê –ü–†–û–í–ï–†–ö–£
                    db.ref(`clients/${sender.fbKey}`).update({ balance: sender.balance - amount });
                    db.ref('moderation').push({
                        from: sender.fbKey, fromN: sender.name, fromT: sender.tg_id,
                        to: targetKey, toN: target.name, toT: target.tg_id,
                        val: amount, time: Date.now()
                    });
                    
                    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É
                    fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${MY_ADMIN_ID}&text=üõ°Ô∏è <b>–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞</b>\n–°—É–º–º–∞: ${amount}‚ÇΩ\n–û—Ç: ${sender.name}\n–ö–æ–º—É: ${target.name}&parse_mode=HTML`);
                    
                    view.showSuccess("–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ", `–ü–µ—Ä–µ–≤–æ–¥ ${amount}‚ÇΩ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –±–∞–Ω–∫–æ–º.`);
                } else {
                    // –ú–ì–ù–û–í–ï–ù–ù–û
                    await db.ref(`clients/${sender.fbKey}`).update({ balance: sender.balance - amount });
                    await db.ref(`clients/${targetKey}/balance`).transaction(c => (c || 0) + amount);
                    
                    db.ref(`clients/${sender.fbKey}/history`).push({ title: `–ü–µ—Ä–µ–≤–æ–¥: ${target.name}`, sum: -amount, date: Date.now() });
                    db.ref(`clients/${targetKey}/history`).push({ title: `–û—Ç: ${sender.name}`, sum: amount, date: Date.now() });

                    view.showSuccess("–£—Å–ø–µ—à–Ω–æ", `–ü–æ–¥–∞—Ä–æ–∫ –¥–ª—è ${target.name} –¥–æ—Å—Ç–∞–≤–ª–µ–Ω!`);
                }
            },

            approve: (key, data) => {
                db.ref(`clients/${data.to}/balance`).transaction(c => (c || 0) + data.val);
                db.ref(`clients/${data.from}/history`).push({ title: `–û–¥–æ–±—Ä–µ–Ω–æ: ${data.toN}`, sum: -data.val, date: Date.now() });
                db.ref(`clients/${data.to}/history`).push({ title: `–ü–æ—Å—Ç—É–ø–∏–ª–æ: ${data.fromN}`, sum: data.val, date: Date.now() });
                db.ref(`moderation/${key}`).remove();
                
                fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${data.fromT}&text=‚úÖ –ü–µ—Ä–µ–≤–æ–¥ –Ω–∞ ${data.val}‚ÇΩ –æ–¥–æ–±—Ä–µ–Ω!`);
                fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${data.toT}&text=üí∞ –í–∞–º –∑–∞—á–∏—Å–ª–µ–Ω–æ ${data.val}‚ÇΩ –æ—Ç ${data.fromN}`);
            },

            reject: (key, data) => {
                db.ref(`clients/${data.from}/balance`).transaction(c => (c || 0) + data.val);
                db.ref(`moderation/${key}`).remove();
                fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${data.fromT}&text=‚ùå –ü–µ—Ä–µ–≤–æ–¥ –Ω–∞ ${data.val}‚ÇΩ –æ—Ç–∫–ª–æ–Ω–µ–Ω. –°—Ä–µ–¥—Å—Ç–≤–∞ –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã.`);
            }
        };

        // --- –ò–ù–¢–ï–†–§–ï–ô–° ---
        const view = {
            showScreen: (id) => {
                document.querySelectorAll('.screen').forEach(s => {
                    s.classList.remove('active');
                    setTimeout(() => { if(!s.classList.contains('active')) s.style.display='none'; }, 400);
                });
                const next = document.getElementById(id);
                next.style.display = 'block';
                setTimeout(() => next.classList.add('active'), 50);
            },

            openModal: (id) => document.getElementById(id).style.display = 'flex',
            closeModal: (id) => document.getElementById(id).style.display = 'none',

            renderProfile: () => {
                const u = state.currentUser;
                if (!u) return;

                if (u.isFrozen) {
                    document.getElementById('frozen-overlay').style.display = 'flex';
                    return;
                }

                document.getElementById('user-display-name').innerText = u.name;
                document.getElementById('user-avatar').innerText = u.name[0];
                document.getElementById('user-balance').innerText = (u.balance || 0).toLocaleString() + " ‚ÇΩ";
                
                // –ö–Ω–æ–ø–∫–∞ –∞–¥–º–∏–Ω–∞
                document.getElementById('admin-node').style.display = (u.tg_id == MY_ADMIN_ID) ? 'flex' : 'none';

                // –°–µ–ª–µ–∫—Ç–æ—Ä –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π
                const sel = document.getElementById('transfer-to');
                sel.innerHTML = state.allUsers
                    .filter(x => x.fbKey !== u.fbKey)
                    .map(x => `<option value="${x.fbKey}">${x.name}</option>`).join('');

                // –ò—Å—Ç–æ—Ä–∏—è
                const h = u.history ? Object.values(u.history).reverse() : [];
                const hHtml = h.map(i => `
                    <div class="history-card">
                        <div><b>${i.title}</b><br><small style="color:#aaa;">${new Date(i.date).toLocaleDateString()}</small></div>
                        <div style="font-weight:900; color:${i.sum > 0 ? '#2ecc71' : '#1c1c1e'}">
                            ${i.sum > 0 ? '+' : ''}${i.sum} ‚ÇΩ
                        </div>
                    </div>
                `).join('');
                document.getElementById('full-history-list').innerHTML = hHtml || "<p style='text-align:center; color:#ccc;'>–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</p>";
                document.getElementById('home-history-mini').innerHTML = hHtml.slice(0, 300); // –¢–æ–ª—å–∫–æ –ø–∞—Ä—É —à—Ç—É–∫ –Ω–∞ –≥–ª–∞–≤–Ω—É—é
            },

            renderAdmin: (requests) => {
                const box = document.getElementById('admin-requests-list');
                if (!requests) return box.innerHTML = "–ó–∞—è–≤–æ–∫ –Ω–µ—Ç";
                box.innerHTML = Object.keys(requests).map(k => `
                    <div class="admin-request-item">
                        <div style="font-size:22px; font-weight:900;">${requests[k].val} ‚ÇΩ</div>
                        <div style="color:#666; margin:10px 0;">–û—Ç: ${requests[k].fromN}<br>–ö–æ–º—É: ${requests[k].toN}</div>
                        <div style="display:flex; gap:10px;">
                            <button onclick='bank.approve("${k}", ${JSON.stringify(requests[k])})' style="flex:1; background:#2ecc71; color:white; border:none; padding:12px; border-radius:12px; font-weight:700;">–û–¥–æ–±—Ä–∏—Ç—å</button>
                            <button onclick='bank.reject("${k}", ${JSON.stringify(requests[k])})' style="flex:1; background:#ff3b30; color:white; border:none; padding:12px; border-radius:12px; font-weight:700;">–í–µ—Ä–Ω—É—Ç—å</button>
                        </div>
                    </div>
                `).join('');
            },

            showSuccess: (title, desc) => {
                document.getElementById('success-title').innerText = title;
                document.getElementById('success-desc').innerText = desc;
                view.openModal('modal-success');
            }
        };

        // --- –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –° FIREBASE ---
        db.ref('clients').on('value', snap => {
            const data = snap.val();
            state.allUsers = data ? Object.keys(data).map(k => ({...data[k], fbKey: k})) : [];
            if (state.currentUser) {
                state.currentUser = state.allUsers.find(u => u.fbKey === state.currentUser.fbKey);
                view.renderProfile();
            }
        });

        db.ref('moderation').on('value', snap => view.renderAdmin(snap.val()));

        // --- –≠–§–§–ï–ö–¢ –°–ù–ï–ì–ê ---
        const canvas = document.getElementById('snow-canvas');
        const ctx = canvas.getContext('2d');
        let flakes = [];
        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.onresize = resize; resize();
        for(let i=0; i<100; i++) flakes.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, r: Math.random()*3+1, v: Math.random()*1+0.5 });
        function drawSnow() {
            ctx.clearRect(0,0,canvas.width,canvas.height); ctx.fillStyle = "white"; ctx.beginPath();
            flakes.forEach(f => { ctx.moveTo(f.x, f.y); ctx.arc(f.x, f.y, f.r, 0, Math.PI*2); });
            ctx.fill(); flakes.forEach(f => { f.y += f.v; if(f.y > canvas.height) f.y = -5; });
            requestAnimationFrame(drawSnow);
        }
        drawSnow();
    </script>
</body>
</html>
