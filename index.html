<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>K-Online Pro | Premium Banking</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --sber-green: #21a038;
            --sber-dark: #083d12;
            --bg-main: #f2f5f7;
            --white: #ffffff;
            --dark-panel: #020b0d;
            --text-main: #1a1a1a;
            --text-gray: #8e8e93;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.05);
            --shadow-md: 0 8px 24px rgba(0,0,0,0.12);
            --card-black: linear-gradient(135deg, #232526, #414345);
            --card-green: linear-gradient(135deg, #1d976c, #93f9b9);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: var(--bg-main); color: var(--text-main);
            overflow: hidden; 
        }

        /* --- –ê–Ω–∏–º–∞—Ü–∏–∏ --- */
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* --- –≠–∫—Ä–∞–Ω—ã --- */
        .screen {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-main); overflow-y: auto; overflow-x: hidden;
            z-index: 10;
        }
        .screen.active { display: block; animation: fadeIn 0.3s ease; }

        /* --- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è) --- */
        #screen-auth {
            background: linear-gradient(135deg, #21a038 0%, #004d40 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px; text-align: center;
        }
        .auth-logo { font-size: 48px; font-weight: 900; color: white; margin-bottom: 10px; letter-spacing: -2px; }
        .auth-card {
            background: rgba(255, 255, 255, 0.95); width: 100%; max-width: 350px;
            border-radius: 30px; padding: 30px 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
        }
        .auth-tabs { display: flex; background: #eee; border-radius: 12px; margin-bottom: 20px; padding: 3px; }
        .tab-btn { flex: 1; padding: 10px; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; background: none; }
        .tab-btn.active { background: white; box-shadow: var(--shadow-sm); color: var(--sber-green); }

        .user-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 15px; border-bottom: 1px solid #f0f0f0; transition: 0.2s;
        }
        .user-row:active { background: #f9f9f9; }
        .user-row.selected { color: var(--sber-green); font-weight: 800; border-right: 4px solid var(--sber-green); }

        /* --- –®–∞–ø–∫–∞ –≥–ª–∞–≤–Ω–æ–π --- */
        .top-bar {
            background: var(--dark-panel); padding: 60px 20px 30px;
            color: white; border-radius: 0 0 35px 35px; position: relative;
        }
        .user-info-block { display: flex; justify-content: space-between; align-items: center; }
        .avatar-circle {
            width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(45deg, #444, #888);
            display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 20px;
            border: 2px solid rgba(255,255,255,0.2);
        }

        /* --- –°–ª–∞–π–¥–µ—Ä –∫–∞—Ä—Ç (–î–µ—Ç–∞–ª—å–Ω—ã–π) --- */
        .card-slider {
            display: flex; gap: 15px; overflow-x: auto; padding: 20px 0;
            scroll-snap-type: x mandatory; padding-left: 20px;
        }
        .card-slider::-webkit-scrollbar { display: none; }
        .card-item {
            min-width: 280px; height: 170px; border-radius: 24px; padding: 25px;
            color: white; position: relative; scroll-snap-align: center;
            box-shadow: 0 12px 24px rgba(0,0,0,0.2);
        }
        .debit-style { background: var(--card-green); }
        .credit-style { background: var(--card-black); }
        .card-name { font-size: 11px; text-transform: uppercase; letter-spacing: 1.2px; opacity: 0.9; }
        .card-sum { font-size: 32px; font-weight: 800; margin: 15px 0; }
        .card-chip { width: 40px; height: 30px; background: #ffd700; border-radius: 6px; margin-bottom: 10px; opacity: 0.8; }

        /* --- –°–µ—Ç–∫–∞ –¥–µ–π—Å—Ç–≤–∏–π --- */
        .action-container { 
            display: grid; grid-template-columns: repeat(4, 1fr); 
            gap: 12px; padding: 25px 20px; 
        }
        .action-box { text-align: center; }
        .action-icon {
            width: 60px; height: 60px; background: white; border-radius: 20px;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; margin: 0 auto 8px; box-shadow: var(--shadow-sm);
        }
        .action-text { font-size: 11px; font-weight: 700; color: #555; }

        /* --- –í–∏–¥–∂–µ—Ç—ã --- */
        .widget-card {
            background: white; margin: 0 20px 12px; border-radius: 22px;
            padding: 18px; display: flex; align-items: center; gap: 15px;
            box-shadow: var(--shadow-sm);
        }
        .widget-circle {
            width: 48px; height: 48px; border-radius: 14px;
            display: flex; align-items: center; justify-content: center; font-size: 20px;
        }

        /* --- –ò—Å—Ç–æ—Ä–∏—è (–ü–æ–ª–Ω–∞—è) --- */
        .history-panel {
            background: white; border-radius: 35px 35px 0 0; margin-top: 25px;
            padding: 30px 20px; min-height: 500px; box-shadow: 0 -10px 30px rgba(0,0,0,0.03);
        }
        .history-title { font-size: 20px; font-weight: 800; margin-bottom: 20px; display: flex; justify-content: space-between; }
        .op-item {
            display: flex; align-items: center; padding: 16px 0;
            border-bottom: 1px solid #f8f8f8;
        }
        .op-icon-bg {
            width: 42px; height: 42px; border-radius: 50%; background: #f0f2f5;
            display: flex; align-items: center; justify-content: center; margin-right: 15px;
        }
        .op-main { flex: 1; }
        .op-name { font-weight: 700; font-size: 15px; }
        .op-sub { font-size: 12px; color: var(--text-gray); margin-top: 2px; }
        .op-val { font-weight: 800; font-size: 16px; text-align: right; }
        .val-plus { color: var(--sber-green); }

        /* --- –§–æ—Ä–º—ã –∏ –∏–Ω–ø—É—Ç—ã --- */
        .form-wrap { padding: 20px; }
        .input-field {
            background: #fff; border-radius: 18px; padding: 15px;
            margin-bottom: 15px; box-shadow: var(--shadow-sm);
        }
        .input-field label { display: block; font-size: 11px; color: var(--text-gray); font-weight: 700; margin-bottom: 5px; }
        .input-field input, .input-field select {
            width: 100%; border: none; font-size: 18px; font-weight: 700; background: none;
        }
        .main-btn {
            width: 100%; height: 60px; background: var(--sber-green); color: white;
            border: none; border-radius: 18px; font-size: 18px; font-weight: 800;
            margin-top: 10px; box-shadow: 0 8px 20px rgba(33, 160, 56, 0.3);
        }

        /* --- –í—Å–ø–ª—ã–≤–∞—é—â–µ–µ –º–µ–Ω—é --- */
        .bottom-sheet {
            position: fixed; bottom: 0; left: 0; right: 0; background: white;
            border-radius: 30px 30px 0 0; padding: 30px 20px; z-index: 1000;
            transform: translateY(100%); transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .bottom-sheet.open { transform: translateY(0); }
        .overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); opacity: 0; pointer-events: none; transition: 0.3s; z-index: 999;
        }
        .overlay.show { opacity: 1; pointer-events: auto; }

    </style>
</head>
<body>

    <div id="overlay" class="overlay" onclick="closeAllModals()"></div>

    <div id="screen-auth" class="screen active">
        <div class="auth-logo">K-Online</div>
        <div class="auth-card">
            <div class="auth-tabs">
                <button class="tab-btn active" onclick="setAuthTab('private')">–ß–∞—Å—Ç–Ω–æ–µ –ª–∏—Ü–æ</button>
                <button class="tab-btn" onclick="setAuthTab('business')">–ë–∏–∑–Ω–µ—Å</button>
            </div>
            <div id="userListUI" style="max-height: 250px; overflow-y: auto; margin-bottom: 20px;">
                </div>
            <button class="main-btn" onclick="loginAction()">–í–æ–π—Ç–∏ –ø–æ –ü–ò–ù-–∫–æ–¥—É</button>
            <div style="margin-top: 20px; font-size: 13px; color: #666;" onclick="registerNew()">
                –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <span style="color: var(--sber-green); font-weight: 800;">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</span>
            </div>
        </div>
    </div>

    <div id="screen-home" class="screen">
        <div class="top-bar">
            <div class="user-info-block">
                <div>
                    <div style="opacity: 0.7; font-size: 12px;">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å,</div>
                    <div id="homeUserName" style="font-size: 24px; font-weight: 900;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
                </div>
                <div class="avatar-circle" id="homeAvatar">?</div>
            </div>
            
            <div class="card-slider">
                <div class="card-item debit-style" onclick="openCardDetails('debit')">
                    <div class="card-name">Mir Debit Platinum</div>
                    <div class="card-chip"></div>
                    <div id="bal-debit" class="card-sum">0.00 ‚ÇΩ</div>
                    <div style="font-family: monospace; letter-spacing: 2px;">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ 4002</div>
                </div>
                <div class="card-item credit-style" onclick="openCardDetails('credit')">
                    <div class="card-name">Credit Signature</div>
                    <div class="card-chip" style="background: #c0c0c0;"></div>
                    <div id="bal-credit" class="card-sum">0.00 ‚ÇΩ</div>
                    <div style="font-family: monospace; letter-spacing: 2px;">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ 8851</div>
                </div>
            </div>
        </div>

        <div class="action-container">
            <div class="action-box" onclick="nav('screen-transfer')">
                <div class="action-icon">üì§</div>
                <div class="action-text">–ü–µ—Ä–µ–≤–æ–¥</div>
            </div>
            <div class="action-box" onclick="nav('screen-payments')">
                <div class="action-icon">üì±</div>
                <div class="action-text">–ü–ª–∞—Ç–µ–∂–∏</div>
            </div>
            <div class="action-box" onclick="openExchange()">
                <div class="action-icon">üí±</div>
                <div class="action-text">–ö—É—Ä—Å—ã</div>
            </div>
            <div class="action-box" onclick="nav('screen-settings')">
                <div class="action-icon">‚öôÔ∏è</div>
                <div class="action-text">–õ–∏–º–∏—Ç—ã</div>
            </div>
        </div>

        <div class="widget-card" onclick="alert('–í–∞—à–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –∞–∫—Ç–∏–≤–Ω–∞')">
            <div class="widget-circle" style="background: #e8f5e9; color: var(--sber-green);">‚≠ê</div>
            <div style="flex: 1;">
                <div style="font-size: 15px; font-weight: 800;">–ë–æ–Ω—É—Å—ã –∑–∞ –ø–æ–∫—É–ø–∫–∏</div>
                <div id="userBonuses" style="font-size: 13px; color: #666;">–ù–∞–∫–æ–ø–ª–µ–Ω–æ: 0</div>
            </div>
            <div style="font-weight: 900; color: var(--sber-green);">‚ûú</div>
        </div>

        <div class="widget-card">
            <div class="widget-circle" style="background: #fff3e0; color: #ff9800;">üíµ</div>
            <div style="flex: 1;">
                <div style="font-size: 15px; font-weight: 800;">–í–∞–ª—é—Ç–Ω—ã–π —Å—á–µ—Ç</div>
                <div id="userUsd" style="font-size: 13px; color: #666;">$ 0.00</div>
            </div>
        </div>

        <div class="history-panel">
            <div class="history-title">
                –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
                <span style="font-size: 13px; color: var(--sber-green);">–í—Å–µ</span>
            </div>
            <div id="mainHistoryUI">
                </div>
        </div>
    </div>

    <div id="screen-transfer" class="screen">
        <div style="padding: 50px 20px 20px; display: flex; align-items: center; justify-content: space-between;">
            <div onclick="nav('screen-home')" style="font-size: 24px;">‚úï</div>
            <div style="font-weight: 800; font-size: 18px;">–ü–µ—Ä–µ–≤–æ–¥ –ø–æ –Ω–æ–º–µ—Ä—É</div>
            <div style="width: 24px;"></div>
        </div>
        <div class="form-wrap">
            <div class="input-field">
                <label>–ü–æ–ª—É—á–∞—Ç–µ–ª—å</label>
                <select id="transferRecipient"></select>
            </div>
            <div class="input-field">
                <label>–°—É–º–º–∞ –ø–µ—Ä–µ–≤–æ–¥–∞</label>
                <input type="number" id="transferAmount" placeholder="0.00">
            </div>
            <div class="input-field">
                <label>–°–æ–æ–±—â–µ–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                <input type="text" placeholder="–ü–æ–¥–∞—Ä–æ–∫">
            </div>
            <button class="main-btn" onclick="executeTransfer()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–µ—Ä–µ–≤–æ–¥</button>
        </div>
    </div>

    <div id="screen-payments" class="screen">
        <div style="padding: 50px 20px 20px; display: flex; align-items: center; gap: 15px;">
            <div onclick="nav('screen-home')" style="font-size: 24px;">‚Üê</div>
            <h2 style="margin: 0;">–ü–ª–∞—Ç–µ–∂–∏</h2>
        </div>
        <div class="widget-card" onclick="startServicePay('–ú–æ–±–∏–ª—å–Ω–∞—è —Å–≤—è–∑—å', 'üì±')">
            <div class="widget-circle">üì±</div>
            <div style="font-weight: 800;">–ú–æ–±–∏–ª—å–Ω–∞—è —Å–≤—è–∑—å</div>
        </div>
        <div class="widget-card" onclick="startServicePay('–ò–Ω—Ç–µ—Ä–Ω–µ—Ç', 'üåê')">
            <div class="widget-circle">üåê</div>
            <div style="font-weight: 800;">–ò–Ω—Ç–µ—Ä–Ω–µ—Ç –∏ –¢–í</div>
        </div>
        <div class="widget-card" onclick="startServicePay('–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç', 'üöå')">
            <div class="widget-circle">üöå</div>
            <div style="font-weight: 800;">–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</div>
        </div>
        <div class="widget-card" onclick="startServicePay('–ñ–ö–•', 'üè†')">
            <div class="widget-circle">üè†</div>
            <div style="font-weight: 800;">–ö–≤–∞—Ä—Ç–ø–ª–∞—Ç–∞</div>
        </div>
    </div>

    <div id="screen-card-detail" class="screen">
        <div id="detailHeader" style="padding: 50px 20px 30px; color: white;">
            <div onclick="nav('screen-home')">‚Üê –ù–∞–∑–∞–¥</div>
            <h1 id="detailAmount" style="font-size: 42px; margin: 20px 0 5px;">0.00 ‚ÇΩ</h1>
            <p id="detailName" style="opacity: 0.8; font-weight: 700;">–î–µ–±–µ—Ç–æ–≤–∞—è –∫–∞—Ä—Ç–∞</p>
        </div>
        <div class="action-container">
            <div class="action-box" onclick="topUpAction()">
                <div class="action-icon">‚ûï</div>
                <div class="action-text">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</div>
            </div>
            <div class="action-box" onclick="alert('–õ–∏–º–∏—Ç: 150 000 ‚ÇΩ / –¥–µ–Ω—å')">
                <div class="action-icon">üìä</div>
                <div class="action-text">–õ–∏–º–∏—Ç—ã</div>
            </div>
            <div class="action-box" onclick="freezeToggle()">
                <div class="action-icon">‚ùÑÔ∏è</div>
                <div class="action-text">–ë–ª–æ–∫</div>
            </div>
            <div class="action-box" onclick="alert('RU45 2020 4002 1100 9982')">
                <div class="action-icon">‚ÑπÔ∏è</div>
                <div class="action-text">–†–µ–∫–≤–∏–∑–∏—Ç—ã</div>
            </div>
        </div>
        <div class="history-panel" id="detailHistory">
            </div>
    </div>

    <div id="screen-settings" class="screen">
        <div style="padding: 50px 20px;">
            <div onclick="nav('screen-home')" style="font-size: 24px;">‚úï</div>
            <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
            <div class="widget-card" onclick="changePin()">
                <div style="flex: 1; font-weight: 800;">–ò–∑–º–µ–Ω–∏—Ç—å –ü–ò–ù-–∫–æ–¥</div>
            </div>
            <div class="widget-card" onclick="location.reload()">
                <div style="flex: 1; font-weight: 800; color: #d32f2f;">–í—ã–π—Ç–∏ –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</div>
            </div>
        </div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        const firebaseConfig = { 
            apiKey: "AIzaSyA3J7KnUgxUHZigwRKmndm7xyxJeeLCrxg", 
            databaseURL: "https://webapp-b7149-default-rtdb.europe-west1.firebasedatabase.app", 
            projectId: "webapp-b7149"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let currentUser = null;
        let allUsers = [];
        let selectedLoginId = null;
        let currentDetailCard = 'debit';

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
        function init() {
            db.ref('clients').on('value', snap => {
                const data = snap.val();
                allUsers = data ? Object.keys(data).map(k => ({...data[k], fbKey: k})) : [];
                renderUserList();
                if(currentUser) {
                    currentUser = allUsers.find(u => u.fbKey === currentUser.fbKey);
                    refreshUI();
                }
            });
        }

        // –†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞ –Ω–∞ –≤—Ö–æ–¥–µ
        function renderUserList() {
            const container = document.getElementById('userListUI');
            container.innerHTML = allUsers.map(u => `
                <div class="user-row ${selectedLoginId === u.fbKey ? 'selected' : ''}" onclick="selectLogin('${u.fbKey}')">
                    <span>${u.name}</span>
                    <span>${selectedLoginId === u.fbKey ? '‚úì' : ''}</span>
                </div>
            `).join('');

            // –°–µ–ª–µ–∫—Ç –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–æ–≤
            const select = document.getElementById('transferRecipient');
            select.innerHTML = allUsers.filter(u => currentUser && u.fbKey !== currentUser.fbKey)
                                       .map(u => `<option value="${u.fbKey}">${u.name}</option>`).join('');
        }

        function selectLogin(id) {
            selectedLoginId = id;
            renderUserList();
        }

        // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
        function loginAction() {
            if(!selectedLoginId) return alert("–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è");
            const pin = prompt("–í–≤–µ–¥–∏—Ç–µ 4-–∑–Ω–∞—á–Ω—ã–π –ü–ò–ù:");
            const user = allUsers.find(u => u.fbKey === selectedLoginId);
            if(user && user.clientPin === pin) {
                currentUser = user;
                refreshUI();
                nav('screen-home');
            } else { alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ü–ò–ù-–∫–æ–¥"); }
        }

        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
        function registerNew() {
            const name = prompt("–í–∞—à–µ –∏–º—è:");
            const pin = prompt("–ù–æ–≤—ã–π –ü–ò–ù (4 —Ü–∏—Ñ—Ä—ã):");
            if(name && pin) {
                db.ref('clients').push({
                    name: name,
                    clientPin: pin,
                    balance: 10000,
                    bonus: 0,
                    usd: 0,
                    creditLimit: 50000,
                    creditBalance: 0,
                    history: { "init": { title: "–û—Ç–∫—Ä—ã—Ç–∏–µ —Å—á–µ—Ç–∞", sum: 10000, date: new Date().toLocaleDateString() } }
                });
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —ç–∫—Ä–∞–Ω–µ
        function refreshUI() {
            if(!currentUser) return;
            
            // –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω
            document.getElementById('homeUserName').innerText = currentUser.name;
            document.getElementById('homeAvatar').innerText = currentUser.name[0];
            document.getElementById('bal-debit').innerText = (currentUser.balance || 0).toLocaleString() + " ‚ÇΩ";
            document.getElementById('bal-credit').innerText = (currentUser.creditLimit - (currentUser.creditBalance || 0)).toLocaleString() + " ‚ÇΩ";
            document.getElementById('userBonuses').innerText = "–ù–∞–∫–æ–ø–ª–µ–Ω–æ: " + (currentUser.bonus || 0);
            document.getElementById('userUsd').innerText = "$ " + (currentUser.usd || 0).toFixed(2);

            // –†–µ–Ω–¥–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏
            const hist = currentUser.history ? Object.values(currentUser.history).reverse() : [];
            const html = hist.map(op => `
                <div class="op-item">
                    <div class="op-icon-bg">${op.sum > 0 ? 'üí∞' : 'üõí'}</div>
                    <div class="op-main">
                        <div class="op-name">${op.title}</div>
                        <div class="op-sub">${op.date || '–°–µ–≥–æ–¥–Ω—è'}</div>
                    </div>
                    <div class="op-val ${op.sum > 0 ? 'val-plus' : ''}">
                        ${op.sum > 0 ? '+' : ''}${op.sum.toLocaleString()} ‚ÇΩ
                    </div>
                </div>
            `).join('');
            
            document.getElementById('mainHistoryUI').innerHTML = html;
            
            // –ï—Å–ª–∏ —ç–∫—Ä–∞–Ω –¥–µ—Ç–∞–ª–µ–π –æ—Ç–∫—Ä—ã—Ç, –æ–±–Ω–æ–≤–ª—è–µ–º –∏ –µ–≥–æ
            if(document.getElementById('screen-card-detail').classList.contains('active')) {
                renderCardDetail();
            }
        }

        // –ù–∞–≤–∏–≥–∞—Ü–∏—è
        function nav(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // –ü–µ—Ä–µ–≤–æ–¥—ã
        function executeTransfer() {
            const targetId = document.getElementById('transferRecipient').value;
            const amount = parseInt(document.getElementById('transferAmount').value);
            if(!amount || amount <= 0) return alert("–ù–µ–≤–µ—Ä–Ω–∞—è —Å—É–º–º–∞");
            if(currentUser.balance < amount) return alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤");

            const target = allUsers.find(u => u.fbKey === targetId);
            
            // –°–ø–∏—Å–∞–Ω–∏–µ
            db.ref(`clients/${currentUser.fbKey}`).update({ balance: currentUser.balance - amount });
            db.ref(`clients/${currentUser.fbKey}/history`).push({ 
                title: "–ü–µ—Ä–µ–≤–æ–¥: " + target.name, sum: -amount, date: "–°–µ–≥–æ–¥–Ω—è" 
            });

            // –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ
            db.ref(`clients/${targetId}`).update({ balance: (target.balance || 0) + amount });
            db.ref(`clients/${targetId}/history`).push({ 
                title: "–ü–µ—Ä–µ–≤–æ–¥ –æ—Ç: " + currentUser.name, sum: amount, date: "–°–µ–≥–æ–¥–Ω—è" 
            });

            alert("–ü–µ—Ä–µ–≤–æ–¥ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!");
            nav('screen-home');
        }

        // –û–ø–ª–∞—Ç–∞ —É—Å–ª—É–≥
        function startServicePay(name, icon) {
            const amountStr = prompt(`–û–ø–ª–∞—Ç–∞ ${name}. –í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É:`);
            const amount = parseInt(amountStr);
            if(!amount || amount <= 0) return;
            if(currentUser.balance < amount) return alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤");

            const bonusGain = Math.floor(amount * 0.01);
            db.ref(`clients/${currentUser.fbKey}`).update({ 
                balance: currentUser.balance - amount,
                bonus: (currentUser.bonus || 0) + bonusGain
            });
            db.ref(`clients/${currentUser.fbKey}/history`).push({ 
                title: "–û–ø–ª–∞—Ç–∞: " + name, sum: -amount, date: "–°–µ–≥–æ–¥–Ω—è" 
            });
            alert("–ü–ª–∞—Ç–µ–∂ –ø—Ä–æ—à–µ–ª! –ù–∞—á–∏—Å–ª–µ–Ω–æ –±–æ–Ω—É—Å–æ–≤: " + bonusGain);
        }

        // –î–µ—Ç–∞–ª–∏ –∫–∞—Ä—Ç—ã
        function openCardDetails(type) {
            currentDetailCard = type;
            const header = document.getElementById('detailHeader');
            if(type === 'debit') {
                header.style.background = "var(--sber-green)";
                document.getElementById('detailName').innerText = "Mir Debit Platinum";
            } else {
                header.style.background = "var(--dark-panel)";
                document.getElementById('detailName').innerText = "Credit Signature";
            }
            renderCardDetail();
            nav('screen-card-detail');
        }

        function renderCardDetail() {
            const val = currentDetailCard === 'debit' ? currentUser.balance : (currentUser.creditLimit - currentUser.creditBalance);
            document.getElementById('detailAmount').innerText = val.toLocaleString() + " ‚ÇΩ";
            document.getElementById('detailHistory').innerHTML = document.getElementById('mainHistoryUI').innerHTML;
        }

        // –î–æ–ø. —Ñ—É–Ω–∫—Ü–∏–∏
        function topUpAction() {
            const sum = prompt("–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è:");
            if(sum) {
                db.ref(`clients/${currentUser.fbKey}`).update({ balance: currentUser.balance + parseInt(sum) });
                db.ref(`clients/${currentUser.fbKey}/history`).push({ title: "–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ", sum: parseInt(sum), date: "–°–µ–≥–æ–¥–Ω—è" });
            }
        }

        function openExchange() {
            const usd = prompt("–ö—É—Ä—Å –ø–æ–∫—É–ø–∫–∏: 1$ = 91.2 ‚ÇΩ\n–°–∫–æ–ª—å–∫–æ USD –∫—É–ø–∏—Ç—å?");
            if(usd) {
                const cost = Math.round(usd * 91.2);
                if(currentUser.balance < cost) return alert("–ú–∞–ª–æ —Å—Ä–µ–¥—Å—Ç–≤");
                db.ref(`clients/${currentUser.fbKey}`).update({ balance: currentUser.balance - cost, usd: (currentUser.usd || 0) + parseFloat(usd) });
                db.ref(`clients/${currentUser.fbKey}/history`).push({ title: "–û–±–º–µ–Ω –≤–∞–ª—é—Ç—ã", sum: -cost, date: "–°–µ–≥–æ–¥–Ω—è" });
            }
        }

        function changePin() {
            const np = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π 4-–∑–Ω–∞—á–Ω—ã–π –ü–ò–ù:");
            if(np && np.length === 4) {
                db.ref(`clients/${currentUser.fbKey}`).update({ clientPin: np });
                alert("–ü–ò–ù –∏–∑–º–µ–Ω–µ–Ω!");
            }
        }

        function setAuthTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            if(tab === 'business') alert("–†–∞–∑–¥–µ–ª –¥–ª—è –±–∏–∑–Ω–µ—Å–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–∏");
        }

        init();
    </script>
</body>
</html>
