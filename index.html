<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–û–Ω–ª–∞–π–Ω –ë–∞–Ω–∫</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/3Jp6C40b/IMG-2667.jpg">

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <style>
        :root { 
            --bg: #f2f3f7; --accent: #007aff; --card: #ffffff; --text: #1c1c1e; 
            --secondary: #8e8e93; --credit: #34c759; --red: #ff3b30; --tab-bg: #ffffff;
        }
        body.dark {
            --bg: #000000; --card: #1c1c1e; --text: #ffffff; --secondary: #8e8e93; --tab-bg: #121212;
        }
        * { box-sizing: border-box; font-family: -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); color: var(--text); overscroll-behavior: none; transition: background 0.3s; }
        
        /* –°—Ç–∏–ª–∏ —ç–∫—Ä–∞–Ω–æ–≤ */
        #blocked-view { display: none; padding: 40px; text-align: center; background: var(--card); height: 100vh; flex-direction: column; justify-content: center; position: fixed; top: 0; left: 0; width: 100%; z-index: 10000; }
        .refresh-btn { position: fixed; top: 20px; right: 20px; width: 45px; height: 45px; background: var(--card); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; font-size: 22px; border: none; cursor: pointer; color: var(--text); }
        .screen { display: none; padding: 20px 20px 100px 20px; min-height: 100vh; position: relative; }
        .screen.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* –ö–∞—Ä—Ç–æ—á–∫–∏ –∏ –∫–Ω–æ–ø–∫–∏ */
        .card { background: var(--card); border-radius: 24px; padding: 20px; margin-bottom: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); }
        .balance { font-size: 32px; font-weight: 700; margin: 5px 0; }
        .small { color: var(--secondary); font-size: 13px; }
        .btn { width: 100%; padding: 18px 5px; border-radius: 18px; border: none; font-size: 14px; font-weight: 600; cursor: pointer; margin-bottom: 10px; }
        .primary { background: #ffdd2d; color: #000; }
        .secondary { background: #e8f0ff; color: #007aff; }
        
        /* –ß–∞—Ç */
        #chat-container { height: 60vh; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 8px; margin-bottom: 10px; border-radius: 15px; background: rgba(0,0,0,0.02); }
        .msg { max-width: 80%; padding: 10px 15px; border-radius: 18px; font-size: 14px; line-height: 1.4; }
        .msg.user { align-self: flex-end; background: var(--accent); color: white; border-bottom-right-radius: 4px; }
        .msg.admin { align-self: flex-start; background: #e5e5ea; color: #000; border-bottom-left-radius: 4px; }

        /* –¢–∞–±-–±–∞—Ä */
        .tab-bar { position: fixed; bottom: 0; left: 0; width: 100%; height: 70px; background: var(--tab-bg); display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #e5e5ea; z-index: 1000; padding-bottom: env(safe-area-inset-bottom); }
        .tab-item { display: flex; flex-direction: column; align-items: center; font-size: 10px; color: var(--secondary); cursor: pointer; }
        .tab-item.active { color: var(--accent); }
        .tab-icon { font-size: 24px; margin-bottom: 4px; }

        /* –ü–∏–Ω-–∫–æ–¥ */
        .dots { display: flex; justify-content: center; gap: 15px; margin: 30px 0; }
        .dot { width: 12px; height: 12px; border: 2px solid #ccc; border-radius: 50%; }
        .dot.filled { background: var(--text); border-color: var(--text); }
        .keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; max-width: 300px; margin: 0 auto; }
        .key { height: 70px; font-size: 26px; border: none; background: none; color: var(--text); cursor: pointer; }
        
        input, select { width: 100%; padding: 18px; border-radius: 18px; border: 1px solid #ddd; font-size: 16px; margin-bottom: 15px; background: var(--card); color: var(--text); outline: none; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 5000; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: var(--card); width: 90%; max-width: 350px; padding: 25px; border-radius: 28px; text-align: center; }
        .history-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f0f0f2; }
    </style>
</head>
<body>

    <button class="refresh-btn" onclick="location.reload()">üîÑ</button>

    <div id="blocked-view">
        <h1 style="color: var(--red);">–ö–∞—Ä—Ç–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞</h1>
        <button class="btn secondary" onclick="location.reload()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
    </div>

    <div id="screen-name" class="screen">
        <h1 style="margin-top:60px">–í—Ö–æ–¥</h1>
        <div class="card">
            <input type="text" id="loginInp" placeholder="–ò–º—è –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω">
            <button class="btn primary" onclick="findClient()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
            <div id="error" style="color:red; text-align:center;"></div>
        </div>
        <div id="variants"></div>
    </div>

    <div id="screen-pin" class="screen">
        <div style="text-align:center; margin-top:80px;">
            <h2 id="pinUser"></h2>
            <div class="dots" id="pinDots"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
            <div class="keypad" id="keypad"></div>
        </div>
    </div>

    <div id="screen-home" class="screen">
        <h1 id="homeUser" style="margin-top:10px"></h1>
        <div class="card">
            <div class="small">–í—Å–µ–≥–æ —Å—Ä–µ–¥—Å—Ç–≤</div>
            <div class="balance" id="hBal">0 ‚ÇΩ</div>
            <div class="small" id="hSpend">–¢—Ä–∞—Ç—ã: 0 ‚ÇΩ</div>
        </div>
        <div id="accounts-container"></div>
    </div>

    <div id="screen-support" class="screen">
        <h1>–ü–æ–¥–¥–µ—Ä–∂–∫–∞</h1>
        <div class="card" style="padding: 10px;">
            <div id="chat-container"></div>
            <div style="display: flex; gap: 8px;">
                <input type="text" id="chatInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="margin-bottom:0">
                <button class="btn primary" style="width: 60px; margin-bottom:0" onclick="sendMsg()">‚û§</button>
            </div>
        </div>
    </div>

    <div id="screen-settings" class="screen">
        <h1>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1>
        <div class="card">
            <p class="small">–¢–µ–º–∞</p>
            <select id="themeSelect" onchange="applyTheme()">
                <option value="light">–°–≤–µ—Ç–ª–∞—è</option>
                <option value="dark">–¢–µ–º–Ω–∞—è</option>
            </select>
        </div>
        <button class="btn secondary" onclick="logout()">–í—ã–π—Ç–∏</button>
    </div>

    <div class="tab-bar" id="main-nav" style="display: none;">
        <div class="tab-item active" onclick="navTo('screen-home', this)"><span class="tab-icon">üè†</span><span>–ì–ª–∞–≤–Ω–∞—è</span></div>
        <div class="tab-item" onclick="navTo('screen-support', this)"><span class="tab-icon">üí¨</span><span>–ß–∞—Ç</span></div>
        <div class="tab-item" onclick="navTo('screen-settings', this)"><span class="tab-icon">‚öôÔ∏è</span><span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span></div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA3J7KnUgxUHZigwRKmndm7xyxJeeLCrxg",
            authDomain: "webapp-b7149.firebaseapp.com",
            databaseURL: "https://webapp-b7149-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "webapp-b7149",
            storageBucket: "webapp-b7149.firebasestorage.app",
            messagingSenderId: "1034835242406",
            appId: "1:1034835242406:web:98499dc1edbb83e4b8f367"
        };

        firebase.initializeApp(firebaseConfig);
        const dbRef = firebase.database().ref('bank_db');

        let db = [];
        let curUser = null;
        let enteredPin = "";

        dbRef.on('value', (snapshot) => {
            db = snapshot.val() || [];
            if (curUser) {
                curUser = db.find(u => u.id === curUser.id);
                if (curUser.blockedCard) document.getElementById('blocked-view').style.display = 'flex';
                else document.getElementById('blocked-view').style.display = 'none';
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–æ–≤ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤ –ë–î
                if(document.getElementById('screen-home').classList.contains('active')) showHome();
                if(document.getElementById('screen-support').classList.contains('active')) loadChat();
            }
        });

        function navTo(id, el) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(el) {
                document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
                el.classList.add('active');
            }
            document.getElementById('main-nav').style.display = ['screen-home', 'screen-support', 'screen-settings'].includes(id) ? 'flex' : 'none';
            if(id === 'screen-home') showHome();
            if(id === 'screen-support') loadChat();
        }

        function findClient() {
            const v = loginInp.value.trim();
            const matches = db.filter(c => c.name.toLowerCase() === v.toLowerCase() || c.phone === v);
            if (!matches.length) { error.innerText = "–ù–µ –Ω–∞–π–¥–µ–Ω"; return; }
            if (matches.length === 1) selectUser(matches[0]);
            else {
                variants.innerHTML = "";
                matches.forEach(c => {
                    let d = document.createElement('div'); d.className = "card"; d.innerText = c.name;
                    d.onclick = () => selectUser(c); variants.appendChild(d);
                });
            }
        }

        function selectUser(c) {
            curUser = c; enteredPin = ""; pinUser.innerText = curUser.name;
            updateDots(); navTo('screen-pin'); buildKeypad();
        }

        function buildKeypad() {
            const keys = [1,2,3,4,5,6,7,8,9,'',0,'‚Üê'];
            keypad.innerHTML = '';
            keys.forEach(k => {
                let b = document.createElement('button'); b.className = 'key'; b.innerText = k;
                if(k === '') b.style.visibility = 'hidden';
                b.onclick = () => {
                    if(k === '‚Üê') enteredPin = enteredPin.slice(0, -1);
                    else if(typeof k === 'number' && enteredPin.length < 4) enteredPin += k;
                    updateDots();
                    if(enteredPin.length === 4) {
                        if(enteredPin === curUser.pin) navTo('screen-home');
                        else { enteredPin = ""; updateDots(); }
                    }
                };
                keypad.appendChild(b);
            });
        }

        function updateDots() {
            const d = pinDots.children;
            for(let i=0; i<4; i++) d[i].classList.toggle('filled', i < enteredPin.length);
        }

        function showHome() {
            if(!curUser) return;
            homeUser.innerText = `–ü—Ä–∏–≤–µ—Ç, ${curUser.name}`;
            hBal.innerText = (curUser.balance || 0).toLocaleString() + " ‚ÇΩ";
            hSpend.innerText = `–¢—Ä–∞—Ç—ã: ${(curUser.spending || 0).toLocaleString()} ‚ÇΩ`;
            document.getElementById('accounts-container').innerHTML = `
                <div class="card">
                    <div class="small">–õ–∏—á–Ω—ã–π —Å—á–µ—Ç</div>
                    <div style="font-size:20px; font-weight:600; margin-top:8px;">${(curUser.balance || 0).toLocaleString()} ‚ÇΩ</div>
                </div>`;
        }

        function loadChat() {
            const cont = document.getElementById('chat-container');
            cont.innerHTML = '<div class="msg admin">–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ß–µ–º –ø–æ–º–æ—á—å?</div>';
            if(curUser.chat) {
                curUser.chat.forEach(m => {
                    let d = document.createElement('div');
                    d.className = `msg ${m.role}`; d.innerText = m.text;
                    cont.appendChild(d);
                });
            }
            cont.scrollTop = cont.scrollHeight;
        }

        function sendMsg() {
            const t = chatInput.value.trim();
            if(!t) return;
            if(!curUser.chat) curUser.chat = [];
            curUser.chat.push({role: 'user', text: t, time: Date.now()});
            chatInput.value = "";
            dbRef.set(db);
        }

        function applyTheme() {
            const t = localStorage.getItem('theme') || 'light';
            document.body.className = t; themeSelect.value = t;
        }

        themeSelect.onchange = () => {
            localStorage.setItem('theme', themeSelect.value);
            applyTheme();
        };

        function logout() { curUser = null; navTo('screen-name'); }

        window.onload = () => {
            navTo('screen-name');
            applyTheme();
        };
    </script>
</body>
</html>
