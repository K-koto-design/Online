<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>K-Online Deluxe</title>
    <meta name="apple-mobile-web-app-title" content="–ö-–û–Ω–ª–∞–π–Ω">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/QtVHC5G0/IMG-3035.jpg">
    <link rel="icon" type="image/png" href="https://i.postimg.cc/QtVHC5G0/IMG-3035.jpg">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg-body: #f0f4f8;
            --grad-red: linear-gradient(170deg, #000a1a 0%, #1a0000 40%, #660000 100%);
            --white: #ffffff;
            --danger: #ff3b30;
            --radius-card: 28px;
            --radius-btn: 22px;
            --anim-screen: 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            overflow: hidden; background: var(--bg-body); 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        /* –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –°–ù–ï–ì –î–õ–Ø IPA */
        #snow-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 9999;
        }

        .screen { 
            display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            width: 100%; height: 100%; overflow-y: auto; background: var(--bg-body);
            z-index: 10; opacity: 0; transform: scale(0.96);
            transition: opacity var(--anim-screen), transform var(--anim-screen);
        }
        .screen.active { display: block !important; opacity: 1; transform: scale(1); }

        .auth-wrap { padding: 80px 30px; text-align: center; min-height: 100vh; background: #fff; }
        .logo-text { 
            font-size: 52px; font-weight: 900; 
            background: linear-gradient(45deg, #ff0000, #ffcc00); 
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; 
            margin: 0; letter-spacing: -2px; 
        }

        #screen-pin-entry { background: var(--grad-red); color: white; display:none; flex-direction: column; justify-content: space-between; align-items: center; padding: 80px 30px 50px; }
        .pin-dots { display: flex; gap: 20px; margin: 40px 0; }
        .p-dot { width: 15px; height: 15px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; }
        .p-dot.active { background: #ffcc00; border-color: #ffcc00; box-shadow: 0 0 15px #ffcc00; }
        .keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; width: 100%; max-width: 300px; }
        .k-btn { height: 70px; border-radius: 50%; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; font-size: 28px; backdrop-filter: blur(5px); cursor: pointer; }

        .header-top { background: var(--grad-red); padding: 60px 0 40px; border-radius: 0 0 50px 50px; color: white; position: relative; }
        .user-meta { display: flex; justify-content: space-between; padding: 0 30px; align-items: center; margin-bottom: 25px; }
        .ava-box { width: 60px; height: 60px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 24px; border: 2px solid rgba(255,255,255,0.3); position: relative; }
        .santa-hat { position: absolute; top: -20px; left: -10px; font-size: 30px; transform: rotate(-15deg); }

        .cards-row { display: flex; overflow-x: auto; padding: 10px 30px 30px; gap: 15px; scrollbar-width: none; }
        .v-card { min-width: 190px; height: 240px; border-radius: var(--radius-card); padding: 25px; display: flex; flex-direction: column; justify-content: space-between; box-shadow: 0 15px 30px rgba(0,0,0,0.3); flex-shrink: 0; }
        .c-black { background: linear-gradient(160deg, #1a1a1a 0%, #000 100%); color: white; }
        .c-blue { background: linear-gradient(160deg, #002f6c 0%, #001433 100%); color: white; }
        .c-gold { background: linear-gradient(160deg, #d4af37 0%, #f1c40f 100%); color: #4a3b00; }

        .widget { background: #fff; border-radius: 24px; padding: 20px; margin: 15px 20px; display: flex; align-items: center; gap: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); cursor: pointer;}
        .w-ico { width: 50px; height: 50px; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 22px; }

        .history-box { padding: 0 25px 40px; }
        .h-item { background: #fff; border-radius: 18px; padding: 15px; display: flex; align-items: center; gap: 12px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        .h-ico { font-size: 20px; width: 40px; text-align: center; }
        .h-info { flex: 1; }
        .h-name { font-size: 14px; font-weight: 700; }
        .h-time { font-size: 11px; color: #aaa; }
        .h-sum { font-weight: 800; font-size: 14px; }
        .sum-neg { color: #000; }
        .sum-pos { color: #27ae60; }
        .sum-wait { color: #f1c40f; font-style: italic; }

        input, textarea { width: 100%; height: 60px; border-radius: 18px; border: 1px solid #eee; padding: 0 20px; font-size: 17px; margin-bottom: 15px; background: #f9f9f9; font-family: inherit; }
        textarea { height: 90px; padding: 15px 20px; resize: none; }
        .btn-main { width: 100%; height: 60px; border: none; border-radius: var(--radius-btn); font-size: 17px; font-weight: 700; cursor: pointer; transition: 0.2s; }
        .btn-black { background: #000; color: #fff; }
        .btn-red { background: var(--danger); color: #fff; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .modal-in { background: #fff; width: 85%; border-radius: 35px; padding: 35px; text-align: center; }
        .form-box { padding: 60px 25px; }

        /* –ö–Ω–æ–ø–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –≤ —É–≥–ª—É */
        .history-btn-fixed { position: absolute; top: 60px; right: 25px; font-size: 28px; cursor: pointer; z-index: 100; }
    </style>
</head>
<body>

    <canvas id="snow-canvas"></canvas>

    <div id="modal-success" class="modal">
        <div class="modal-in">
            <div style="font-size:60px; margin-bottom:15px;">üéÑ</div>
            <h2 id="suc-h">–ì–æ—Ç–æ–≤–æ!</h2>
            <div id="suc-val" style="font-size:32px; font-weight:900; margin:10px 0;">0 ‚ÇΩ</div>
            <p id="suc-p" style="color:#888; margin-bottom:25px;"></p>
            <button class="btn-main btn-red" onclick="view.hideSuccess()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <div id="screen-auth" class="screen active">
        <div class="auth-wrap">
            <h1 class="logo-text">–ö-–û–Ω–ª–∞–π–Ω</h1>
            <p style="color:#888; font-weight:500; margin: 10px 0 40px;">–í–≤–µ–¥–∏—Ç–µ –≤–∞—à Telegram ID ‚ùÑÔ∏è</p>
            <input type="number" id="auth-tg-id" placeholder="ID (–Ω–∞–ø—Ä–∏–º–µ—Ä: 1234567)">
            <button class="btn-main btn-black" onclick="logic.tryLogin()">–í–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç</button>
            <p style="margin-top:20px; font-size:13px; color:#bbb;">–ù–µ—Ç ID? –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É</p>
        </div>
    </div>

    <div id="screen-pin-entry" class="screen">
        <div style="text-align:center;">
            <h2 id="pin-user-name">–í—Ö–æ–¥</h2>
            <p style="opacity:0.6;">–í–≤–µ–¥–∏—Ç–µ –ü–ò–ù-–∫–æ–¥</p>
        </div>
        <div class="pin-dots">
            <div class="p-dot"></div><div class="p-dot"></div><div class="p-dot"></div><div class="p-dot"></div>
        </div>
        <div class="keypad">
            <div class="k-btn" onclick="logic.tapPin('1')">1</div><div class="k-btn" onclick="logic.tapPin('2')">2</div><div class="k-btn" onclick="logic.tapPin('3')">3</div>
            <div class="k-btn" onclick="logic.tapPin('4')">4</div><div class="k-btn" onclick="logic.tapPin('5')">5</div><div class="k-btn" onclick="logic.tapPin('6')">6</div>
            <div class="k-btn" onclick="logic.tapPin('7')">7</div><div class="k-btn" onclick="logic.tapPin('8')">8</div><div class="k-btn" onclick="logic.tapPin('9')">9</div>
            <div class="k-btn" style="opacity:0;"></div><div class="k-btn" onclick="logic.tapPin('0')">0</div><div class="k-btn" onclick="logic.tapPin('DEL')">‚å´</div>
        </div>
        <div onclick="view.nav('screen-auth')" style="opacity:0.6; text-decoration:underline; cursor:pointer; margin-top: 30px;">–û—Ç–º–µ–Ω–∞</div>
    </div>

    <div id="screen-home" class="screen">
        <div class="history-btn-fixed" onclick="view.scrollToHistory()">üìÉ</div>
        <div class="header-top">
            <div class="user-meta">
                <div>
                    <div id="h-name" style="font-size:24px; font-weight:900;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
                    <div id="h-tg" style="font-size:12px; opacity:0.6;">ID: ---</div>
                </div>
                <div class="ava-box">
                    <span class="santa-hat">üéÖ</span>
                    <span id="h-ava">?</span>
                </div>
            </div>
            <div class="cards-row" id="h-cards"></div>
        </div>

        <div class="widget" onclick="view.nav('screen-transfer')">
            <div class="w-ico" style="background:#fff0f0; color:#e74c3c;">üéÅ</div>
            <div style="flex:1;"><b>–ü–µ—Ä–µ–≤–æ–¥</b><div style="font-size:12px; color:#aaa;">–ü–æ –∏–º–µ–Ω–∏ –∏–ª–∏ Telegram ID</div></div>
        </div>

        <div class="widget" onclick="view.nav('screen-exchange')">
            <div class="w-ico" style="background:#e3f2fd; color:#3498db;">üíµ</div>
            <div style="flex:1;"><b>–û–±–º–µ–Ω –≤–∞–ª—é—Ç—ã</b><div id="w-usd">0.00 $</div></div>
        </div>

        <div class="widget" onclick="view.nav('screen-loan')">
            <div class="w-ico" style="background:#fff9e6; color:#f1c40f;">üåü</div>
            <div style="flex:1;"><b>–ö–∞—Ä—Ç–∞ Gold</b><div style="font-size:12px; color:#aaa;">–ü—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–π –ª–∏–º–∏—Ç –¥–æ 500–∫</div></div>
        </div>

        <div id="history-anchor" style="padding: 10px 25px;"><h3 style="margin:0;">–ò—Å—Ç–æ—Ä–∏—è</h3></div>
        <div class="history-box" id="h-history-list"></div>
    </div>

    <div id="screen-transfer" class="screen">
        <div class="form-box">
            <div style="font-size:30px; margin-bottom:20px; cursor:pointer;" onclick="view.nav('screen-home')">‚Üê</div>
            <h2 style="font-size:32px; font-weight:900;">–ü–µ—Ä–µ–≤–æ–¥ üéÑ</h2>
            <label style="font-size:12px; color:#888; margin-left:10px;">–ü–û–õ–£–ß–ê–¢–ï–õ–¨ (–ò–ú–Ø –ò–õ–ò ID)</label>
            <input type="text" id="tr-target" placeholder="–ö–æ–º—É –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º?">
            <label style="font-size:12px; color:#888; margin-left:10px;">–°–£–ú–ú–ê (‚ÇΩ)</label>
            <input type="number" id="tr-val" placeholder="0.00">
            <label style="font-size:12px; color:#888; margin-left:10px;">–°–û–û–ë–©–ï–ù–ò–ï (–ù–ï–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û)</label>
            <textarea id="tr-msg" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –ø–æ–∂–µ–ª–∞–Ω–∏–µ..."></textarea>
            <button class="btn-main btn-black" onclick="bank.send()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–¥–∞—Ä–æ–∫</button>
        </div>
    </div>

    <div id="screen-settings" class="screen">
        <div class="form-box">
            <div style="font-size:30px; margin-bottom:20px; cursor:pointer;" onclick="view.nav('screen-home')">‚Üê</div>
            <h2>–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å üõ°Ô∏è</h2>
            <input type="text" id="set-old-id" readonly style="color:#aaa;">
            <input type="number" id="set-new-id" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π ID">
            <button class="btn-main btn-red" onclick="logic.updateId()">–ü—Ä–∏–≤—è–∑–∞—Ç—å –Ω–æ–≤—ã–π ID</button>
        </div>
    </div>

    <div id="screen-exchange" class="screen">
        <div class="form-box">
            <div style="font-size:30px; margin-bottom:20px; cursor:pointer;" onclick="view.nav('screen-home')">‚Üê</div>
            <h2>–û–±–º–µ–Ω ‚ùÑÔ∏è</h2>
            <div style="text-align:center; padding:20px; background:#fff; border-radius:30px;">
                <div style="font-size:42px; font-weight:900;">91.20 ‚ÇΩ</div>
                <input type="number" id="ex-val" placeholder="–°–∫–æ–ª—å–∫–æ $ –∫—É–ø–∏—Ç—å?">
                <button class="btn-main btn-black" onclick="bank.exchange()">–ö—É–ø–∏—Ç—å –≤–∞–ª—é—Ç—É</button>
            </div>
        </div>
    </div>

    <div id="screen-loan" class="screen">
        <div class="form-box">
            <div style="font-size:30px; margin-bottom:20px; cursor:pointer;" onclick="view.nav('screen-home')">‚Üê</div>
            <h2>–ö–∞—Ä—Ç–∞ Gold üåü</h2>
            <input type="number" id="ln-val" placeholder="–ñ–µ–ª–∞–µ–º—ã–π –ª–∏–º–∏—Ç">
            <button class="btn-main btn-black" onclick="bank.loan()">–ó–∞–ø—Ä–æ—Å–∏—Ç—å –ª–∏–º–∏—Ç</button>
        </div>
    </div>

    <script>
        const TG_TOKEN = '8548215166:AAHhHo_ODrDZl-6Lg5Zi-BpBIpeMzXdOEFE'; 
        const TG_ADMIN_ID = '7597506775';
        const config = { 
            apiKey: "AIzaSyA3J7KnUgxUHZigwRKmndm7xyxJeeLCrxg", 
            databaseURL: "https://webapp-b7149-default-rtdb.europe-west1.firebasedatabase.app", 
            projectId: "webapp-b7149" 
        };
        firebase.initializeApp(config);
        const rtdb = firebase.database();

        let state = { all: [], user: null, pin: "" };

        // –°–ù–ï–ñ–ò–ù–ö–ò - –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–û –î–õ–Ø IPA
        const canvas = document.getElementById('snow-canvas');
        const ctx = canvas.getContext('2d');
        let flakes = [];
        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.onresize = resize; resize();
        for(let i=0; i<60; i++) flakes.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, r: Math.random()*2+1, v: Math.random()*0.8+0.4, o: Math.random() });
        function drawSnow() {
            ctx.clearRect(0,0,canvas.width,canvas.height);
            ctx.fillStyle = "rgba(255, 255, 255, 0.8)";
            ctx.beginPath();
            flakes.forEach(f => {
                ctx.moveTo(f.x, f.y);
                ctx.arc(f.x, f.y, f.r, 0, Math.PI*2);
            });
            ctx.fill();
            flakes.forEach(f => {
                f.y += f.v;
                f.x += Math.sin(f.y/30)*0.5;
                if(f.y > canvas.height) f.y = -10;
                if(f.x > canvas.width) f.x = 0;
                else if(f.x < 0) f.x = canvas.width;
            });
            requestAnimationFrame(drawSnow);
        }
        drawSnow();

        const view = {
            nav: (id) => {
                document.querySelectorAll('.screen').forEach(s => { 
                    s.classList.remove('active'); 
                    setTimeout(()=>s.style.display='none', 400); 
                });
                const t = document.getElementById(id);
                t.style.display = (id==='screen-pin-entry')?'flex':'block';
                setTimeout(()=>t.classList.add('active'), 50);
            },
            scrollToHistory: () => {
                document.getElementById('screen-home').scrollTo({
                    top: document.getElementById('history-anchor').offsetTop - 20,
                    behavior: 'smooth'
                });
            },
            drawDash: () => {
                if(!state.user) return;
                const u = state.user;
                document.getElementById('h-name').innerText = u.name;
                document.getElementById('h-tg').innerText = 'ID: ' + u.telegramId;
                document.getElementById('h-ava').innerText = u.name[0];
                document.getElementById('w-usd').innerText = (u.usd || 0).toFixed(2) + " $";
                
                let cards = `<div class="v-card c-black"><div>MIR Physical</div><div style="font-size:24px; font-weight:800;">${(u.balance||0).toLocaleString()} ‚ÇΩ</div></div>`;
                if(u.usd > 0) cards += `<div class="v-card c-blue"><div>VISA Digital</div><div style="font-size:24px; font-weight:800;">${u.usd.toFixed(2)} $</div></div>`;
                if(u.hasCredit) cards += `<div class="v-card c-gold"><div>GOLD Credit</div><div style="font-size:24px; font-weight:800;">${(u.creditBalance||0).toLocaleString()} ‚ÇΩ</div></div>`;
                document.getElementById('h-cards').innerHTML = cards;
                view.listenHistory();
            },
            listenHistory: () => {
                const list = document.getElementById('h-history-list');
                rtdb.ref(`history/${state.user.fbKey}`).limitToLast(15).on('value', s => {
                    let h = '';
                    const data = s.val();
                    if(!data) { 
                        list.innerHTML = '<p style="color:#ccc; text-align:center;">–û–ø–µ—Ä–∞—Ü–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</p>'; 
                        return; 
                    }
                    Object.keys(data).reverse().forEach(k => {
                        const i = data[k];
                        const isPlus = i.type === 'plus';
                        const cls = isPlus ? 'sum-pos' : (i.status === 'wait' ? 'sum-wait' : 'sum-neg');
                        const prefix = isPlus ? '+' : '-';
                        h += `<div class="h-item">
                            <div class="h-ico">${i.ico || 'üí≥'}</div>
                            <div class="h-info">
                                <div class="h-name">${i.title}</div>
                                <div class="h-time">${i.status === 'wait' ? '–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ ‚è≥' : '–í—ã–ø–æ–ª–Ω–µ–Ω–æ ‚úÖ'}</div>
                            </div>
                            <div class="h-sum ${cls}">${prefix}${i.val.toLocaleString()} ${i.unit || '‚ÇΩ'}</div>
                        </div>`;
                    });
                    list.innerHTML = h;
                });
            },
            showSuccess: (h, v, p) => {
                document.getElementById('suc-h').innerText = h; document.getElementById('suc-val').innerText = v; document.getElementById('suc-p').innerText = p;
                document.getElementById('modal-success').style.display = 'flex';
            },
            hideSuccess: () => { document.getElementById('modal-success').style.display='none'; view.nav('screen-home'); }
        };

        const logic = {
            init: () => {
                const urlParams = new URLSearchParams(window.location.search);
                const action = urlParams.get('action');
                const to = urlParams.get('to');
                const from = urlParams.get('from');
                const val = parseInt(urlParams.get('val'));
                const hid = urlParams.get('hid');

                rtdb.ref('clients').on('value', s => {
                    const d = s.val(); state.all = d ? Object.keys(d).map(k=>({...d[k], fbKey:k})) : [];
                    
                    if(action && to && val && hid && !window.modDone) {
                        window.modDone = true;
                        if(action === 'approve') {
                            const target = state.all.find(x => x.fbKey === to);
                            const sender = state.all.find(x => x.fbKey === from);
                            if(target && sender) {
                                // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê: –°–ø–∏—Å–∞–Ω–∏–µ –∏ –∑–∞—á–∏—Å–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ —Ç—É—Ç
                                rtdb.ref(`clients/${from}`).update({ balance: (sender.balance||0) - val });
                                rtdb.ref(`clients/${to}`).update({ balance: (target.balance||0) + val });
                                rtdb.ref(`history/${from}/${hid}`).update({ status: 'done', ico: 'üéÅ' });
                                rtdb.ref(`history/${to}`).push({ title: '–í—Ö–æ–¥—è—â–∏–π –ø–µ—Ä–µ–≤–æ–¥', val: val, type: 'plus', ico: 'üí∞', status: 'done' });
                                alert("–ü–µ—Ä–µ–≤–æ–¥ –æ–¥–æ–±—Ä–µ–Ω!");
                            }
                        } else if (action === 'decline') {
                            rtdb.ref(`history/${from}/${hid}`).remove();
                            alert("–ü–µ—Ä–µ–≤–æ–¥ –æ—Ç–∫–ª–æ–Ω–µ–Ω.");
                        }
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }
                    if(state.user) {
                        state.user = state.all.find(x=>x.fbKey === state.user.fbKey);
                        view.drawDash();
                    }
                });
            },
            tryLogin: () => {
                const inputId = document.getElementById('auth-tg-id').value;
                const found = state.all.find(u => String(u.telegramId) === String(inputId));
                if(found) {
                    state.user = found;
                    document.getElementById('pin-user-name').innerText = found.name;
                    state.pin = ""; logic.updPinUI(); view.nav('screen-pin-entry');
                } else alert("ID –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω");
            },
            tapPin: (v) => {
                if(v==='DEL') state.pin = state.pin.slice(0,-1);
                else if(state.pin.length < 4) state.pin += v;
                logic.updPinUI();
                if(state.pin.length === 4) {
                    if(String(state.user.clientPin) === state.pin) { view.drawDash(); view.nav('screen-home'); }
                    else { alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ü–ò–ù"); state.pin = ""; logic.updPinUI(); }
                }
            },
            updPinUI: () => document.querySelectorAll('.p-dot').forEach((d,i)=>d.classList.toggle('active', i<state.pin.length)),
            sendTg: (m, kb = null) => {
                const body = { chat_id: TG_ADMIN_ID, text: m, parse_mode: 'HTML' };
                if(kb) body.reply_markup = JSON.stringify(kb);
                fetch(`https://api.telegram.org/bot${TG_TOKEN}/sendMessage`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                });
            }
        };

        const bank = {
            send: () => {
                const targetQuery = document.getElementById('tr-target').value.toLowerCase().trim();
                const val = parseInt(document.getElementById('tr-val').value);
                const msg = document.getElementById('tr-msg').value || "–ë–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è";
                const u = state.user;

                if(!targetQuery || !val || val <= 0) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ");
                const target = state.all.find(x => String(x.telegramId) === targetQuery || x.name.toLowerCase() === targetQuery);

                if(!target) return alert("–ü–æ–ª—É—á–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω");
                if(target.fbKey === u.fbKey) return alert("–ù–µ–ª—å–∑—è –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—å —Å–∞–º–æ–º—É —Å–µ–±–µ");
                if(u.balance < val) return alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤");

                if(val >= 1000) {
                    // –ï–°–õ–ò –ë–û–õ–¨–®–ï 1000 - –î–ï–ù–¨–ì–ò –ù–ï –°–ü–ò–°–´–í–ê–ï–ú –°–†–ê–ó–£
                    const histRef = rtdb.ref(`history/${u.fbKey}`).push();
                    histRef.set({ title: '–ü–µ—Ä–µ–≤–æ–¥: ' + target.name, val: val, type: 'minus', ico: '‚è≥', status: 'wait' });
                    
                    const myUrl = window.location.href.split('?')[0];
                    const kb = { inline_keyboard: [[
                        { text: "‚úÖ –û–¥–æ–±—Ä–∏—Ç—å", url: `${myUrl}?action=approve&to=${target.fbKey}&from=${u.fbKey}&val=${val}&hid=${histRef.key}` },
                        { text: "‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å", url: `${myUrl}?action=decline&from=${u.fbKey}&val=${val}&hid=${histRef.key}` }
                    ]]};
                    logic.sendTg(`üéÑ <b>–ú–û–î–ï–†–ê–¶–ò–Ø (>1000‚ÇΩ)</b>\n–û—Ç: ${u.name}\n–ö–æ–º—É: ${target.name}\n–°—É–º–º–∞: ${val}‚ÇΩ\n–¢–µ–∫—Å—Ç: ${msg}`, kb);
                    view.showSuccess("–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ", val + " ‚ÇΩ", "–°—É–º–º–∞ —Å–≤—ã—à–µ 1000‚ÇΩ —Ç—Ä–µ–±—É–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è");
                } else {
                    // –û–ë–´–ß–ù–´–ô –ü–ï–†–ï–í–û–î
                    rtdb.ref(`clients/${u.fbKey}`).update({ balance: u.balance - val });
                    rtdb.ref(`clients/${target.fbKey}`).update({ balance: (target.balance||0) + val });
                    rtdb.ref(`history/${u.fbKey}`).push({ title: '–ü–µ—Ä–µ–≤–æ–¥: ' + target.name, val: val, type: 'minus', ico: 'üéÅ', status: 'done' });
                    rtdb.ref(`history/${target.fbKey}`).push({ title: '–û—Ç: ' + u.name, val: val, type: 'plus', ico: 'üí∞', status: 'done' });
                    view.showSuccess("–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ", val + " ‚ÇΩ", "–ü–æ–ª—É—á–∞—Ç–µ–ª—å: " + target.name);
                }
                
                document.getElementById('tr-target').value = ""; document.getElementById('tr-val').value = ""; document.getElementById('tr-msg').value = "";
            },
            exchange: () => {
                const amt = parseFloat(document.getElementById('ex-val').value), cost = Math.round(amt*91.2), u = state.user;
                if(!amt || u.balance < cost) return alert("–û—à–∏–±–∫–∞ –±–∞–ª–∞–Ω—Å–∞");
                rtdb.ref(`clients/${u.fbKey}`).update({ balance: u.balance-cost, usd: (u.usd||0)+amt });
                rtdb.ref(`history/${u.fbKey}`).push({ title: '–ü–æ–∫—É–ø–∫–∞ –≤–∞–ª—é—Ç—ã', val: amt, unit: '$', type: 'minus', ico: 'üíµ', status: 'done' });
                view.showSuccess("–û–±–º–µ–Ω", amt+" $", "–°–ø–∏—Å–∞–Ω–æ " + cost + " ‚ÇΩ");
            },
            loan: () => {
                const s = parseInt(document.getElementById('ln-val').value);
                if(!s) return alert("–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É");
                logic.sendTg(`üí≥ <b>–ó–∞—è–≤–∫–∞ –Ω–∞ GOLD</b>\n–ö–ª–∏–µ–Ω—Ç: ${state.user.name}\n–õ–∏–º–∏—Ç: ${s}‚ÇΩ`);
                rtdb.ref(`clients/${state.user.fbKey}`).update({ hasCredit:true, creditLimit:s, creditBalance:s });
                rtdb.ref(`history/${state.user.fbKey}`).push({ title: '–õ–∏–º–∏—Ç GOLD', val: s, type: 'plus', ico: 'üåü', status: 'done' });
                view.showSuccess("–õ–∏–º–∏—Ç", s+" ‚ÇΩ", "–ö–∞—Ä—Ç–∞ GOLD –¥–æ–±–∞–≤–ª–µ–Ω–∞");
            }
        };

        window.onload = () => logic.init();
    </script>
</body>
</html>
