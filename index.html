<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>K-Online | Liquid Credit Edition</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg: #020b0d;
            --liquid: #1b5c68;
            --accent: #00ff88;
            --glass: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.15);
            --text: #ffffff;
            --text-dim: rgba(255, 255, 255, 0.6);
            --gold: #f1c40f;
        }

        body.light-theme {
            --bg: #e0e5ec; --liquid: #a3b1c6; --accent: #2ecc71;
            --glass: rgba(255, 255, 255, 0.7); --glass-border: rgba(255, 255, 255, 0.5);
            --text: #2d3436; --text-dim: #636e72;
        }

        * { box-sizing: border-box; font-family: -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; transition: all 0.3s ease; }
        body { margin: 0; background: var(--bg); color: var(--text); min-height: 100vh; overflow-x: hidden; }

        .liquid-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: radial-gradient(circle at 50% -20%, var(--liquid), var(--bg) 80%); }
        
        .screen { display: none; padding: 20px; padding-top: 50px; animation: slideUp 0.4s ease; }
        .screen.active { display: block; }
        @keyframes slideUp { from { opacity:0; transform: translateY(20px); } to { opacity:1; transform: translateY(0); } }

        .glass { background: var(--glass); backdrop-filter: blur(25px); border: 1px solid var(--glass-border); border-radius: 24px; }
        
        input { width: 100%; padding: 16px; border-radius: 16px; border: 1px solid var(--glass-border); background: rgba(0,0,0,0.2); color: var(--text); font-size: 16px; margin-bottom: 12px; }
        .btn { background: var(--liquid); border: none; padding: 18px; border-radius: 18px; width: 100%; color: white; font-weight: 700; cursor: pointer; }
        .btn:active { transform: scale(0.95); }

        /* –ö–ê–†–¢–´ */
        .card-container { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 15px; scrollbar-width: none; }
        .card-container::-webkit-scrollbar { display: none; }
        
        .card { min-width: 260px; height: 140px; padding: 20px; display: flex; flex-direction: column; justify-content: space-between; position: relative; overflow: hidden; }
        .card.credit { border: 1px solid var(--gold); background: linear-gradient(135deg, rgba(241, 196, 15, 0.1), var(--glass)); }
        
        .bal-val { font-size: 28px; font-weight: 800; }
        .card-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }

        /* –ú–ï–ù–Æ */
        .serv-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 25px 0; }
        .serv-item { display: flex; flex-direction: column; align-items: center; font-size: 10px; gap: 8px; color: var(--text-dim); cursor: pointer; }
        .s-ico { width: 55px; height: 55px; display: flex; align-items: center; justify-content: center; font-size: 22px; border-radius: 18px; background: var(--glass); border: 1px solid var(--glass-border); }

        /* CHAT */
        #chatBox { height: 60vh; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; padding: 10px; }
        .m { padding: 12px 16px; border-radius: 18px; max-width: 80%; font-size: 14px; line-height: 1.4; }
        .m.me { align-self: flex-end; background: var(--liquid); color: white; }
        .m.bot { align-self: flex-start; background: var(--glass); color: var(--text); }
    </style>
</head>
<body>

    <div class="liquid-bg"></div>

    <div id="screen-auth" class="screen active">
        <h1 style="text-align:center; margin-top:60px; letter-spacing: -1px;">K-Online</h1>
        <div class="glass" style="padding:30px; margin-top:30px;">
            <p id="authTitle" style="font-weight:700; margin-bottom:20px;">–í—Ö–æ–¥ –≤ –∫–∞–±–∏–Ω–µ—Ç</p>
            <input type="text" id="loginId" placeholder="–ò–º—è –∏–ª–∏ –Ω–æ–º–µ—Ä">
            <input type="password" id="loginPin" placeholder="–ü–ò–ù-–∫–æ–¥">
            <button class="btn" onclick="handleAuth()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
            <p style="text-align:center; font-size:13px; margin-top:20px; opacity:0.6;" onclick="toggleAuthMode()" id="toggleBtn">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</p>
        </div>
    </div>

    <div id="screen-home" class="screen">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
            <h2 id="helloName" style="margin:0;">–ü—Ä–∏–≤–µ—Ç!</h2>
            <div class="s-ico" style="width:40px; height:40px;" onclick="navTo('screen-settings')">‚öôÔ∏è</div>
        </div>

        <div class="card-container">
            <div class="glass card" onclick="navTo('screen-transfer')">
                <div style="display:flex; justify-content:space-between;">
                    <span class="card-label" style="color:var(--accent)">Debit Card</span>
                    <span id="cardNum" style="font-size:12px; opacity:0.6;">4002 ****</span>
                </div>
                <div class="bal-val" id="userBal">0 ‚ÇΩ</div>
            </div>

            <div id="creditCardUI" class="glass card credit" style="display:none;">
                <div style="display:flex; justify-content:space-between;">
                    <span class="card-label" style="color:var(--gold)">Credit Card</span>
                    <span style="font-size:12px; opacity:0.6;">5500 ****</span>
                </div>
                <div class="bal-val" id="creditBalUI">0 ‚ÇΩ</div>
            </div>
        </div>

        <div class="serv-grid">
            <div class="serv-item" onclick="navTo('screen-transfer')"><div class="s-ico">üí∏</div>–ü–µ—Ä–µ–≤–æ–¥</div>
            <div class="serv-item" onclick="navTo('screen-pay')"><div class="s-ico">üì±</div>–°–≤—è–∑—å</div>
            <div class="serv-item" onclick="navTo('screen-loan')"><div class="s-ico">üèõÔ∏è</div>–ö—Ä–µ–¥–∏—Ç</div>
            <div class="serv-item" onclick="openChat()"><div class="s-ico">üí¨</div>–ß–∞—Ç</div>
        </div>

        <div class="glass" style="padding:20px;">
            <div style="color:var(--text-dim); font-size:12px; margin-bottom:5px;">–¢—Ä–∞—Ç—ã –≤ –¥–µ–∫–∞–±—Ä–µ</div>
            <div style="font-size:24px; font-weight:800;">12 400.00 ‚ÇΩ</div>
        </div>
    </div>

    <div id="screen-loan" class="screen">
        <div class="glass" style="padding:25px;">
            <h3 onclick="navTo('screen-home')">‚Üê –ó–∞—è–≤–∫–∞ –Ω–∞ –∫—Ä–µ–¥–∏—Ç</h3>
            <p style="font-size:14px; opacity:0.7;">–î–µ–Ω—å–≥–∏ –±—É–¥—É—Ç –∑–∞—á–∏—Å–ª–µ–Ω—ã –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—É—é –∫—Ä–µ–¥–∏—Ç–Ω—É—é –∫–∞—Ä—Ç—É.</p>
            <input type="number" id="loanSum" placeholder="–°—É–º–º–∞ –∫—Ä–µ–¥–∏—Ç–∞ (‚ÇΩ)">
            <button class="btn" style="background:var(--gold); color:#000" onclick="takeLoan()">–û—Ñ–æ—Ä–º–∏—Ç—å —Å–µ–π—á–∞—Å</button>
        </div>
    </div>

    <div id="screen-transfer" class="screen">
        <div class="glass" style="padding:25px;">
            <h3 onclick="navTo('screen-home')">‚Üê –ü–µ—Ä–µ–≤–æ–¥</h3>
            <input type="text" id="targetUser" placeholder="–ü–æ–ª—É—á–∞—Ç–µ–ª—å (–ò–º—è/–¢–µ–ª–µ—Ñ–æ–Ω)">
            <input type="number" id="transferSum" placeholder="–°—É–º–º–∞ (‚ÇΩ)">
            <button class="btn" onclick="executeTransfer()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
    </div>

    <div id="screen-chat" class="screen">
        <div class="glass" style="padding:15px; height:85vh; display:flex; flex-direction:column;">
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:15px;">
                <span onclick="navTo('screen-home')" style="font-size:24px;">‚Üê</span> <b>–ü–æ–¥–¥–µ—Ä–∂–∫–∞ 24/7</b>
            </div>
            <div id="chatBox"></div>
            <div style="display:flex; gap:8px; margin-top:10px;">
                <input type="text" id="chatInp" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="margin:0;">
                <button class="btn" style="width:60px; margin:0;" onclick="sendMsg()">‚û§</button>
            </div>
        </div>
    </div>

    <div id="screen-settings" class="screen">
        <div class="glass" style="padding:25px;">
            <h3 onclick="navTo('screen-home')">‚Üê –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
            <div style="display:flex; justify-content:space-between; align-items:center; margin:20px 0;">
                <span>–°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞</span>
                <input type="checkbox" id="themeTog" onchange="toggleTheme()">
            </div>
            <p style="font-size:14px; margin-top:20px;">–ù–æ–≤—ã–π –ü–ò–ù-–∫–æ–¥</p>
            <input type="password" id="newPin" placeholder="4 —Ü–∏—Ñ—Ä—ã">
            <button class="btn" onclick="savePin()">–û–±–Ω–æ–≤–∏—Ç—å –ü–ò–ù</button>
            <button class="btn" style="background:#ff4757; margin-top:20px;" onclick="location.reload()">–í—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã</button>
        </div>
    </div>

    <script>
        // CONFIG
        const firebaseConfig = { 
            apiKey: "AIzaSyA3J7KnUgxUHZigwRKmndm7xyxJeeLCrxg", 
            authDomain: "webapp-b7149.firebaseapp.com", 
            databaseURL: "https://webapp-b7149-default-rtdb.europe-west1.firebasedatabase.app", 
            projectId: "webapp-b7149", 
            storageBucket: "webapp-b7149.firebasestorage.app", 
            messagingSenderId: "1034835242406", 
            appId: "1:1034835242406:web:98499dc1edbb83e4b8f367" 
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let users = [];
        let curUser = null;
        let isRegMode = false;

        // DB Listener
        db.ref('clients').on('value', snap => {
            const data = snap.val();
            users = data ? Object.keys(data).map(k => ({...data[k], fbKey: k})) : [];
            if(curUser) {
                curUser = users.find(u => u.fbKey === curUser.fbKey);
                updateUI();
            }
        });

        function updateUI() {
            document.getElementById('userBal').innerText = (curUser.balance || 0).toLocaleString() + " ‚ÇΩ";
            
            // –õ–æ–≥–∏–∫–∞ –∫—Ä–µ–¥–∏—Ç–Ω–æ–π –∫–∞—Ä—Ç—ã
            const creditUI = document.getElementById('creditCardUI');
            const creditBal = document.getElementById('creditBalUI');
            
            if(curUser.hasCredit && curUser.creditBalance > 0) {
                creditUI.style.display = "flex";
                creditBal.innerText = (curUser.creditBalance).toLocaleString() + " ‚ÇΩ";
            } else {
                creditUI.style.display = "none";
            }
        }

        // AUTH
        function toggleAuthMode() {
            isRegMode = !isRegMode;
            document.getElementById('authTitle').innerText = isRegMode ? "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è" : "–í—Ö–æ–¥ –≤ –∫–∞–±–∏–Ω–µ—Ç";
            document.getElementById('toggleBtn').innerText = isRegMode ? "–ï—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏" : "–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è";
        }

        function handleAuth() {
            const id = document.getElementById('loginId').value.trim();
            const pin = document.getElementById('loginPin').value.trim();

            if(isRegMode) {
                const newUser = { 
                    name: id, phone: id, clientPin: pin, balance: 500, 
                    hasCredit: false, creditBalance: 0,
                    card: "4002 " + Math.floor(1000+Math.random()*9000) 
                };
                db.ref('clients').push(newUser).then(() => { alert("–ì–æ—Ç–æ–≤–æ! –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ."); toggleAuthMode(); });
            } else {
                const user = users.find(u => (u.name === id || u.phone === id) && u.clientPin === pin);
                if(user) {
                    curUser = user;
                    document.getElementById('helloName').innerText = "–ü—Ä–∏–≤–µ—Ç, " + curUser.name;
                    document.getElementById('cardNum').innerText = curUser.card || "4002 ****";
                    navTo('screen-home');
                    updateUI();
                } else { alert("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞"); }
            }
        }

        // CREDIT (–ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø)
        function takeLoan() {
            const sum = parseInt(document.getElementById('loanSum').value);
            if(isNaN(sum) || sum <= 0) return alert("–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É");

            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ Firebase
            db.ref(`clients/${curUser.fbKey}`).update({
                hasCredit: true,
                creditBalance: sum
            }).then(() => {
                alert("–ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞ –æ—Ç–∫—Ä—ã—Ç–∞, –ª–∏–º–∏—Ç –∑–∞—á–∏—Å–ª–µ–Ω!");
                navTo('screen-home');
            });
        }

        // TRANSFERS
        function executeTransfer() {
            const to = document.getElementById('targetUser').value.trim();
            const sum = parseInt(document.getElementById('transferSum').value);
            const target = users.find(u => u.name === to || u.phone === to);

            if(!target || isNaN(sum) || sum > curUser.balance) return alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –∏–ª–∏ –Ω–µ–≤–µ—Ä–Ω—ã–π –ø–æ–ª—É—á–∞—Ç–µ–ª—å");

            db.ref(`clients/${curUser.fbKey}/balance`).set(curUser.balance - sum);
            db.ref(`clients/${target.fbKey}/balance`).set((target.balance || 0) + sum);
            alert("–ü–µ—Ä–µ–≤–æ–¥ —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω!");
            navTo('screen-home');
        }

        // CHAT
        function openChat() {
            navTo('screen-chat');
            const box = document.getElementById('chatBox'); box.innerHTML = "";
            db.ref(`support_chats/${curUser.fbKey}`).off();
            db.ref(`support_chats/${curUser.fbKey}`).on('child_added', snap => {
                const m = snap.val();
                const d = document.createElement('div');
                d.className = `m ${m.s === 'me' ? 'me' : 'bot'}`;
                d.innerText = m.t;
                box.appendChild(d);
                box.scrollTop = box.scrollHeight;
            });
        }

        function sendMsg() {
            const t = document.getElementById('chatInp').value;
            if(!t) return;
            db.ref(`support_chats/${curUser.fbKey}`).push({ t: t, s: 'me' });
            document.getElementById('chatInp').value = "";
        }

        // THEME & PIN
        function toggleTheme() { document.body.classList.toggle('light-theme'); }
        function savePin() {
            const p = document.getElementById('newPin').value;
            if(p.length >= 4) {
                db.ref(`clients/${curUser.fbKey}/clientPin`).set(p);
                alert("–ü–ò–ù-–∫–æ–¥ –∏–∑–º–µ–Ω–µ–Ω");
            }
        }

        function navTo(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
    </script>
</body>
</html>
